<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Car Builder">
    <title>Car Builder</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        canvas {
            touch-action: none;
        }
        h1 {
            color: #fff;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255,200,0,0.5);
        }
        #game-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        #build-area {
            background: linear-gradient(180deg, #87CEEB 0%, #87CEEB 60%, #228B22 60%, #228B22 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        #parts-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .panel-section {
            margin-bottom: 20px;
        }
        .panel-section h3 {
            color: #ffd700;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 2px solid rgba(255,215,0,0.3);
            padding-bottom: 5px;
        }
        .parts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .part-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 12px 8px;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 44px;
            touch-action: manipulation;
        }
        .part-btn:hover {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            transform: scale(1.05);
        }
        .part-btn.selected {
            background: rgba(255,215,0,0.4);
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }
        .color-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        .color-btn:hover {
            transform: scale(1.15);
            border-color: #fff;
        }
        .color-btn.selected {
            border-color: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        .action-btn {
            width: 100%;
            padding: 15px;
            margin-top: 8px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 50px;
            touch-action: manipulation;
        }
        .action-btn.primary {
            background: linear-gradient(180deg, #ffd700, #ff9500);
            color: #000;
        }
        .action-btn.primary:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        }
        .action-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        .action-btn.secondary:hover {
            background: rgba(255,255,255,0.3);
        }
        .action-btn.danger {
            background: linear-gradient(180deg, #ff6b6b, #ee5253);
            color: #fff;
        }
        #instructions {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            text-align: center;
            margin-top: 15px;
            line-height: 1.5;
        }
        #speed-display {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            display: none;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-container label {
            color: #fff;
            font-size: 12px;
            display: block;
            margin-bottom: 5px;
        }
        .slider-container input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
            -webkit-appearance: none;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
        }

        /* Virtual Joystick for Test Drive */
        #joystick-container {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 120px;
            display: none;
            z-index: 100;
        }
        #joystick-base {
            position: absolute;
            width: 120px;
            height: 120px;
            background: rgba(255, 215, 0, 0.3);
            border: 3px solid rgba(255, 215, 0, 0.6);
            border-radius: 50%;
        }
        #joystick-knob {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255, 215, 0, 0.7);
            border: 2px solid rgba(255, 215, 0, 0.9);
            border-radius: 50%;
            left: 35px;
            top: 35px;
        }
        #drive-button {
            position: absolute;
            bottom: 50px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: rgba(255, 149, 0, 0.4);
            border: 3px solid rgba(255, 149, 0, 0.7);
            border-radius: 50%;
            display: none;
            z-index: 100;
            font-size: 14px;
            color: #fff;
            font-weight: bold;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 80px;
        }
    </style>
</head>
<body>
    <h1>Car Builder</h1>

    <div id="game-container">
        <div style="position: relative;">
            <canvas id="build-area" width="700" height="500"></canvas>
            <div id="speed-display">0 MPH</div>
            <div id="joystick-container">
                <div id="joystick-base"></div>
                <div id="joystick-knob"></div>
            </div>
            <div id="drive-button">DRIVE</div>
        </div>

        <div id="parts-panel">
            <div class="panel-section">
                <h3>Body Style</h3>
                <div class="parts-grid">
                    <button class="part-btn selected" onclick="selectBody('sedan')">Sedan</button>
                    <button class="part-btn" onclick="selectBody('sports')">Sports</button>
                    <button class="part-btn" onclick="selectBody('suv')">SUV</button>
                    <button class="part-btn" onclick="selectBody('truck')">Truck</button>
                    <button class="part-btn" onclick="selectBody('hatchback')">Hatch</button>
                    <button class="part-btn" onclick="selectBody('convertible')">Convert</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>Body Color</h3>
                <div class="color-grid" id="body-colors"></div>
            </div>

            <div class="panel-section">
                <h3>Wheels</h3>
                <div class="parts-grid">
                    <button class="part-btn selected" onclick="selectWheels('standard')">Standard</button>
                    <button class="part-btn" onclick="selectWheels('sport')">Sport</button>
                    <button class="part-btn" onclick="selectWheels('offroad')">Off-Road</button>
                    <button class="part-btn" onclick="selectWheels('luxury')">Luxury</button>
                    <button class="part-btn" onclick="selectWheels('racing')">Racing</button>
                    <button class="part-btn" onclick="selectWheels('classic')">Classic</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>Accessories</h3>
                <div class="parts-grid">
                    <button class="part-btn" onclick="toggleAccessory('spoiler')">Spoiler</button>
                    <button class="part-btn" onclick="toggleAccessory('scoop')">Hood Scoop</button>
                    <button class="part-btn" onclick="toggleAccessory('stripe')">Stripes</button>
                    <button class="part-btn" onclick="toggleAccessory('exhaust')">Exhaust</button>
                    <button class="part-btn" onclick="toggleAccessory('lights')">Fog Lights</button>
                    <button class="part-btn" onclick="toggleAccessory('tint')">Tinted</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>Customize</h3>
                <div class="slider-container">
                    <label>Ride Height</label>
                    <input type="range" min="0" max="100" value="50" onchange="setRideHeight(this.value)">
                </div>
                <div class="slider-container">
                    <label>Wheel Size</label>
                    <input type="range" min="0" max="100" value="50" onchange="setWheelSize(this.value)">
                </div>
            </div>

            <button class="action-btn primary" onclick="testDrive()">Test Drive!</button>
            <button class="action-btn secondary" onclick="resetCar()">Reset Car</button>

            <div id="instructions">
                Build your dream car!<br>
                Choose parts and customize colors.<br>
                Tap the car to test drive!
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('build-area');
        const ctx = canvas.getContext('2d');

        // Car configuration
        let car = {
            body: 'sedan',
            bodyColor: '#e74c3c',
            wheels: 'standard',
            wheelColor: '#2c3e50',
            accessories: {
                spoiler: false,
                scoop: false,
                stripe: false,
                exhaust: false,
                lights: false,
                tint: false
            },
            rideHeight: 50,
            wheelSize: 50
        };

        // Animation state
        let testDriving = false;
        let carX = 350;
        let carSpeed = 0;
        let wheelRotation = 0;
        let clouds = [
            { x: 100, y: 60, size: 40 },
            { x: 300, y: 80, size: 50 },
            { x: 550, y: 50, size: 35 }
        ];

        // Colors
        const colors = [
            '#e74c3c', '#c0392b', '#e67e22', '#f39c12', '#f1c40f', '#2ecc71',
            '#27ae60', '#1abc9c', '#3498db', '#2980b9', '#9b59b6', '#8e44ad',
            '#34495e', '#2c3e50', '#ecf0f1', '#bdc3c7', '#95a5a6', '#7f8c8d'
        ];

        // Initialize color buttons
        function initColors() {
            const container = document.getElementById('body-colors');
            colors.forEach((color, i) => {
                const btn = document.createElement('button');
                btn.className = 'color-btn' + (i === 0 ? ' selected' : '');
                btn.style.background = color;
                btn.onclick = () => selectColor(color, btn);
                container.appendChild(btn);
            });
        }

        function selectColor(color, btn) {
            document.querySelectorAll('#body-colors .color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            car.bodyColor = color;
            draw();
        }

        function selectBody(type) {
            updatePartButtons('Body Style', type);
            car.body = type;
            draw();
        }

        function selectWheels(type) {
            updatePartButtons('Wheels', type);
            car.wheels = type;
            draw();
        }

        function updatePartButtons(section, selected) {
            const sections = document.querySelectorAll('.panel-section');
            sections.forEach(sec => {
                if (sec.querySelector('h3').textContent === section) {
                    sec.querySelectorAll('.part-btn').forEach(btn => {
                        btn.classList.remove('selected');
                        if (btn.textContent.toLowerCase().includes(selected.substring(0, 4))) {
                            btn.classList.add('selected');
                        }
                    });
                }
            });
        }

        function toggleAccessory(acc) {
            car.accessories[acc] = !car.accessories[acc];
            const btns = document.querySelectorAll('.panel-section')[3].querySelectorAll('.part-btn');
            const accNames = ['spoiler', 'scoop', 'stripe', 'exhaust', 'lights', 'tint'];
            btns[accNames.indexOf(acc)].classList.toggle('selected');
            draw();
        }

        function setRideHeight(val) {
            car.rideHeight = parseInt(val);
            draw();
        }

        function setWheelSize(val) {
            car.wheelSize = parseInt(val);
            draw();
        }

        function resetCar() {
            car = {
                body: 'sedan',
                bodyColor: '#e74c3c',
                wheels: 'standard',
                wheelColor: '#2c3e50',
                accessories: {
                    spoiler: false,
                    scoop: false,
                    stripe: false,
                    exhaust: false,
                    lights: false,
                    tint: false
                },
                rideHeight: 50,
                wheelSize: 50
            };

            // Reset UI
            document.querySelectorAll('.part-btn').forEach((btn, i) => {
                btn.classList.remove('selected');
                if (i === 0 || i === 6) btn.classList.add('selected'); // First body and wheel
            });
            document.querySelectorAll('#body-colors .color-btn').forEach((btn, i) => {
                btn.classList.remove('selected');
                if (i === 0) btn.classList.add('selected');
            });
            document.querySelectorAll('input[type="range"]').forEach(slider => slider.value = 50);

            testDriving = false;
            carX = 350;
            carSpeed = 0;
            document.getElementById('speed-display').style.display = 'none';
            draw();
        }

        function testDrive() {
            testDriving = !testDriving;
            document.getElementById('speed-display').style.display = testDriving ? 'block' : 'none';
            if (!testDriving) {
                carX = 350;
                carSpeed = 0;
            }
        }

        // Drawing functions
        function draw() {
            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Sky gradient
            const skyGrad = ctx.createLinearGradient(0, 0, 0, 300);
            skyGrad.addColorStop(0, '#87CEEB');
            skyGrad.addColorStop(1, '#E0F6FF');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, canvas.width, 350);

            // Sun
            ctx.fillStyle = '#FFD93D';
            ctx.beginPath();
            ctx.arc(600, 80, 40, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#FFF3B0';
            ctx.beginPath();
            ctx.arc(600, 80, 30, 0, Math.PI * 2);
            ctx.fill();

            // Clouds
            clouds.forEach(cloud => {
                drawCloud(cloud.x, cloud.y, cloud.size);
            });

            // Ground
            const groundGrad = ctx.createLinearGradient(0, 350, 0, 500);
            groundGrad.addColorStop(0, '#4a7c59');
            groundGrad.addColorStop(1, '#3d6b4f');
            ctx.fillStyle = groundGrad;
            ctx.fillRect(0, 350, canvas.width, 150);

            // Road
            ctx.fillStyle = '#444';
            ctx.fillRect(0, 360, canvas.width, 100);

            // Road lines
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.setLineDash([30, 20]);
            ctx.beginPath();
            ctx.moveTo(0, 410);
            ctx.lineTo(canvas.width, 410);
            ctx.stroke();
            ctx.setLineDash([]);

            // Road edges
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(0, 360, canvas.width, 4);
            ctx.fillRect(0, 456, canvas.width, 4);

            // Draw car
            drawCar(carX, 380);
        }

        function drawCloud(x, y, size) {
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(x, y, size * 0.5, 0, Math.PI * 2);
            ctx.arc(x + size * 0.4, y - size * 0.2, size * 0.4, 0, Math.PI * 2);
            ctx.arc(x + size * 0.8, y, size * 0.45, 0, Math.PI * 2);
            ctx.arc(x + size * 0.4, y + size * 0.15, size * 0.35, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawCar(x, y) {
            const heightOffset = (50 - car.rideHeight) * 0.3;
            const wheelRadius = 25 + (car.wheelSize - 50) * 0.15;

            ctx.save();
            ctx.translate(x, y + heightOffset);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(0, 65 - heightOffset, 100, 15, 0, 0, Math.PI * 2);
            ctx.fill();

            // Draw based on body type
            switch(car.body) {
                case 'sedan': drawSedan(wheelRadius); break;
                case 'sports': drawSports(wheelRadius); break;
                case 'suv': drawSUV(wheelRadius); break;
                case 'truck': drawTruck(wheelRadius); break;
                case 'hatchback': drawHatchback(wheelRadius); break;
                case 'convertible': drawConvertible(wheelRadius); break;
            }

            ctx.restore();
        }

        function drawSedan(wheelRadius) {
            // Realistic sedan (BMW 3-series style)

            // Lower body with gradient
            let bodyGrad = ctx.createLinearGradient(0, -50, 0, 25);
            bodyGrad.addColorStop(0, shadeColor(car.bodyColor, 20));
            bodyGrad.addColorStop(0.3, car.bodyColor);
            bodyGrad.addColorStop(0.7, shadeColor(car.bodyColor, -15));
            bodyGrad.addColorStop(1, shadeColor(car.bodyColor, -30));

            // Main body shape
            ctx.fillStyle = bodyGrad;
            ctx.beginPath();
            ctx.moveTo(-95, 22);
            ctx.quadraticCurveTo(-100, 10, -95, 0);
            ctx.lineTo(-90, -8);
            ctx.lineTo(-55, -8);
            ctx.quadraticCurveTo(-50, -15, -45, -42);
            ctx.quadraticCurveTo(-40, -48, -30, -48);
            ctx.lineTo(35, -48);
            ctx.quadraticCurveTo(45, -48, 50, -42);
            ctx.quadraticCurveTo(60, -15, 65, -8);
            ctx.lineTo(95, -8);
            ctx.quadraticCurveTo(102, -5, 102, 5);
            ctx.quadraticCurveTo(102, 15, 98, 22);
            ctx.closePath();
            ctx.fill();

            // Wheel wells
            ctx.fillStyle = '#1a1a1a';
            ctx.beginPath();
            ctx.arc(-55, 22, wheelRadius + 5, Math.PI, 0, false);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(55, 22, wheelRadius + 5, Math.PI, 0, false);
            ctx.fill();

            // Body line (character line)
            ctx.strokeStyle = shadeColor(car.bodyColor, -20);
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(-92, -2);
            ctx.quadraticCurveTo(0, -5, 98, -2);
            ctx.stroke();

            // Lower trim
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(-90, 18, 180, 6);

            // Door lines
            ctx.strokeStyle = shadeColor(car.bodyColor, -25);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-15, -45);
            ctx.lineTo(-15, 18);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(25, -45);
            ctx.lineTo(25, 18);
            ctx.stroke();

            // Windows with reflection
            let windowGrad = ctx.createLinearGradient(0, -48, 0, -10);
            windowGrad.addColorStop(0, car.accessories.tint ? 'rgba(20,20,30,0.95)' : 'rgba(40,60,80,0.85)');
            windowGrad.addColorStop(0.5, car.accessories.tint ? 'rgba(30,30,40,0.9)' : 'rgba(80,120,160,0.7)');
            windowGrad.addColorStop(1, car.accessories.tint ? 'rgba(20,20,30,0.95)' : 'rgba(60,90,120,0.8)');

            ctx.fillStyle = windowGrad;
            ctx.beginPath();
            ctx.moveTo(-42, -44);
            ctx.lineTo(32, -44);
            ctx.quadraticCurveTo(42, -44, 48, -38);
            ctx.lineTo(60, -12);
            ctx.lineTo(-52, -12);
            ctx.lineTo(-42, -44);
            ctx.closePath();
            ctx.fill();

            // Window dividers (B-pillar, C-pillar)
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(-16, -44, 4, 32);
            ctx.fillRect(24, -44, 4, 32);

            // Window reflection
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-38, -40);
            ctx.lineTo(-30, -20);
            ctx.stroke();

            // Side mirror
            ctx.fillStyle = car.bodyColor;
            ctx.beginPath();
            ctx.ellipse(55, -15, 8, 5, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.ellipse(57, -15, 5, 3, 0.3, 0, Math.PI * 2);
            ctx.fill();

            // Door handles
            ctx.fillStyle = shadeColor(car.bodyColor, -30);
            ctx.fillRect(-5, -5, 12, 3);
            ctx.fillRect(35, -5, 12, 3);

            // Headlights
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(88, -6);
            ctx.quadraticCurveTo(100, -6, 100, 0);
            ctx.quadraticCurveTo(100, 6, 92, 8);
            ctx.lineTo(85, 2);
            ctx.closePath();
            ctx.fill();

            // Headlight detail
            ctx.fillStyle = '#e8e8e8';
            ctx.beginPath();
            ctx.arc(92, 0, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ccc';
            ctx.beginPath();
            ctx.arc(92, 0, 3, 0, Math.PI * 2);
            ctx.fill();

            // Tail lights
            ctx.fillStyle = '#cc0000';
            ctx.beginPath();
            ctx.moveTo(-88, -5);
            ctx.quadraticCurveTo(-98, -3, -97, 5);
            ctx.lineTo(-85, 8);
            ctx.lineTo(-83, -2);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ff3333';
            ctx.beginPath();
            ctx.arc(-90, 2, 4, 0, Math.PI * 2);
            ctx.fill();

            // Grille
            ctx.fillStyle = '#1a1a1a';
            ctx.beginPath();
            ctx.moveTo(92, -4);
            ctx.lineTo(98, -2);
            ctx.lineTo(98, 12);
            ctx.lineTo(88, 12);
            ctx.closePath();
            ctx.fill();

            // Grille slats
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for(let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(89, 0 + i*3);
                ctx.lineTo(97, 0 + i*3);
                ctx.stroke();
            }

            // Front bumper lower
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(80, 15, 22, 6);

            // Fog lights
            if (car.accessories.lights) {
                ctx.fillStyle = '#ffcc00';
                ctx.beginPath();
                ctx.arc(85, 12, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(85, 12, 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // Racing stripe
            if (car.accessories.stripe) {
                ctx.fillStyle = 'rgba(255,255,255,0.85)';
                ctx.fillRect(-90, -4, 190, 5);
            }

            // Hood scoop
            if (car.accessories.scoop) {
                ctx.fillStyle = '#1a1a1a';
                ctx.beginPath();
                ctx.moveTo(20, -10);
                ctx.lineTo(50, -10);
                ctx.lineTo(48, -18);
                ctx.lineTo(22, -18);
                ctx.closePath();
                ctx.fill();
            }

            // Spoiler
            if (car.accessories.spoiler) {
                ctx.fillStyle = shadeColor(car.bodyColor, -25);
                ctx.beginPath();
                ctx.moveTo(-88, -52);
                ctx.lineTo(-50, -52);
                ctx.lineTo(-52, -48);
                ctx.lineTo(-86, -48);
                ctx.closePath();
                ctx.fill();
                ctx.fillRect(-84, -48, 4, 6);
                ctx.fillRect(-56, -48, 4, 6);
            }

            // Exhaust
            if (car.accessories.exhaust) {
                ctx.fillStyle = '#666';
                ctx.beginPath();
                ctx.ellipse(-95, 18, 8, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.ellipse(-95, 18, 5, 2.5, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // Wheels
            drawWheel(-55, 25, wheelRadius);
            drawWheel(55, 25, wheelRadius);
        }

        function drawSports(wheelRadius) {
            // Lamborghini Gallardo-style supercar

            // Body gradient for 3D effect
            let bodyGrad = ctx.createLinearGradient(0, -40, 0, 20);
            bodyGrad.addColorStop(0, shadeColor(car.bodyColor, 25));
            bodyGrad.addColorStop(0.2, shadeColor(car.bodyColor, 15));
            bodyGrad.addColorStop(0.5, car.bodyColor);
            bodyGrad.addColorStop(0.8, shadeColor(car.bodyColor, -20));
            bodyGrad.addColorStop(1, shadeColor(car.bodyColor, -35));

            // Main body - low angular wedge shape
            ctx.fillStyle = bodyGrad;
            ctx.beginPath();
            ctx.moveTo(-100, 16);
            ctx.quadraticCurveTo(-102, 5, -98, -5);
            ctx.lineTo(-75, -5);
            ctx.lineTo(-68, -28);
            ctx.quadraticCurveTo(-65, -35, -55, -36);
            ctx.lineTo(-25, -38);
            ctx.quadraticCurveTo(-15, -38, -5, -36);
            ctx.lineTo(25, -32);
            ctx.quadraticCurveTo(45, -25, 58, -12);
            ctx.lineTo(92, -6);
            ctx.quadraticCurveTo(105, -4, 108, 5);
            ctx.quadraticCurveTo(108, 12, 105, 16);
            ctx.closePath();
            ctx.fill();

            // Wheel wells
            ctx.fillStyle = '#0a0a0a';
            ctx.beginPath();
            ctx.arc(-55, 18, wheelRadius + 6, Math.PI, 0, false);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(60, 18, wheelRadius + 6, Math.PI, 0, false);
            ctx.fill();

            // Side air intake (signature Gallardo feature)
            let intakeGrad = ctx.createLinearGradient(-45, 0, -20, 0);
            intakeGrad.addColorStop(0, '#0a0a0a');
            intakeGrad.addColorStop(1, '#1a1a1a');
            ctx.fillStyle = intakeGrad;
            ctx.beginPath();
            ctx.moveTo(-48, -3);
            ctx.lineTo(-22, -6);
            ctx.lineTo(-18, 8);
            ctx.lineTo(-45, 12);
            ctx.closePath();
            ctx.fill();

            // Side intake mesh
            ctx.strokeStyle = '#2a2a2a';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(-46 + i * 5, -1 + i * 2);
                ctx.lineTo(-42 + i * 5, 10);
                ctx.stroke();
            }

            // Door line
            ctx.strokeStyle = shadeColor(car.bodyColor, -20);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-8, -34);
            ctx.lineTo(-3, 14);
            ctx.stroke();

            // Rear engine vent with depth
            ctx.fillStyle = '#0a0a0a';
            ctx.beginPath();
            ctx.moveTo(-93, -3);
            ctx.lineTo(-72, -3);
            ctx.lineTo(-72, 10);
            ctx.lineTo(-90, 10);
            ctx.closePath();
            ctx.fill();

            // Rear vent horizontal slats
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2;
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(-91, 0 + i * 3);
                ctx.lineTo(-73, 0 + i * 3);
                ctx.stroke();
            }

            // Windows with reflection gradient
            let windowGrad = ctx.createLinearGradient(-60, -38, 50, -10);
            windowGrad.addColorStop(0, car.accessories.tint ? 'rgba(15,15,25,0.95)' : 'rgba(30,40,60,0.9)');
            windowGrad.addColorStop(0.3, car.accessories.tint ? 'rgba(25,25,35,0.9)' : 'rgba(70,100,140,0.75)');
            windowGrad.addColorStop(0.7, car.accessories.tint ? 'rgba(20,20,30,0.92)' : 'rgba(50,70,100,0.8)');
            windowGrad.addColorStop(1, car.accessories.tint ? 'rgba(15,15,25,0.95)' : 'rgba(40,50,70,0.85)');

            ctx.fillStyle = windowGrad;
            ctx.beginPath();
            ctx.moveTo(-64, -26);
            ctx.quadraticCurveTo(-60, -33, -52, -34);
            ctx.lineTo(-22, -36);
            ctx.quadraticCurveTo(-10, -36, 0, -33);
            ctx.lineTo(22, -28);
            ctx.quadraticCurveTo(40, -22, 52, -12);
            ctx.lineTo(52, -10);
            ctx.lineTo(-3, -10);
            ctx.lineTo(-62, -10);
            ctx.closePath();
            ctx.fill();

            // Window frame
            ctx.strokeStyle = '#050505';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Window reflection highlight
            ctx.strokeStyle = 'rgba(255,255,255,0.25)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-58, -30);
            ctx.quadraticCurveTo(-45, -25, -40, -15);
            ctx.stroke();

            // Side mirror
            ctx.fillStyle = car.bodyColor;
            ctx.beginPath();
            ctx.moveTo(52, -14);
            ctx.lineTo(62, -18);
            ctx.lineTo(65, -14);
            ctx.lineTo(58, -10);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#222';
            ctx.beginPath();
            ctx.ellipse(60, -14, 4, 3, 0.3, 0, Math.PI * 2);
            ctx.fill();

            // Side body line
            ctx.strokeStyle = shadeColor(car.bodyColor, -15);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-95, 0);
            ctx.quadraticCurveTo(0, -3, 100, 0);
            ctx.stroke();

            // Side skirt
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(-95, 13, 200, 5);

            // Front splitter
            ctx.fillStyle = '#0a0a0a';
            ctx.beginPath();
            ctx.moveTo(75, 16);
            ctx.lineTo(108, 16);
            ctx.lineTo(108, 20);
            ctx.lineTo(70, 20);
            ctx.closePath();
            ctx.fill();

            // Headlights (angular LED style)
            let headlightGrad = ctx.createLinearGradient(85, -6, 105, 5);
            headlightGrad.addColorStop(0, '#ffffff');
            headlightGrad.addColorStop(0.5, '#e8e8e8');
            headlightGrad.addColorStop(1, '#cccccc');
            ctx.fillStyle = headlightGrad;
            ctx.beginPath();
            ctx.moveTo(88, -5);
            ctx.lineTo(104, -3);
            ctx.lineTo(104, 4);
            ctx.lineTo(85, 1);
            ctx.closePath();
            ctx.fill();

            // LED strip in headlight
            ctx.fillStyle = '#fff';
            ctx.fillRect(89, -3, 12, 2);
            ctx.fillStyle = 'rgba(200,230,255,0.8)';
            ctx.fillRect(89, -3, 12, 1);

            // Angular tail lights
            let tailGrad = ctx.createLinearGradient(-95, 0, -78, 0);
            tailGrad.addColorStop(0, '#990000');
            tailGrad.addColorStop(0.5, '#cc0000');
            tailGrad.addColorStop(1, '#ff2222');
            ctx.fillStyle = tailGrad;
            ctx.beginPath();
            ctx.moveTo(-96, -4);
            ctx.lineTo(-78, -4);
            ctx.lineTo(-76, 8);
            ctx.lineTo(-94, 8);
            ctx.closePath();
            ctx.fill();

            // Tail light inner glow
            ctx.fillStyle = 'rgba(255,100,100,0.6)';
            ctx.beginPath();
            ctx.arc(-86, 2, 4, 0, Math.PI * 2);
            ctx.fill();

            // Front grille
            ctx.fillStyle = '#0a0a0a';
            ctx.beginPath();
            ctx.moveTo(95, 0);
            ctx.lineTo(105, 2);
            ctx.lineTo(105, 14);
            ctx.lineTo(90, 14);
            ctx.closePath();
            ctx.fill();

            // Grille mesh
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 1;
            for(let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(91, 3 + i*2.5);
                ctx.lineTo(104, 3 + i*2.5);
                ctx.stroke();
            }

            // Fog lights
            if (car.accessories.lights) {
                ctx.fillStyle = '#ffdd00';
                ctx.beginPath();
                ctx.arc(98, 10, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(98, 10, 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // Racing stripe
            if (car.accessories.stripe) {
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.beginPath();
                ctx.moveTo(-95, -1);
                ctx.lineTo(102, -1);
                ctx.lineTo(102, 3);
                ctx.lineTo(-95, 3);
                ctx.closePath();
                ctx.fill();
            }

            // Hood scoop
            if (car.accessories.scoop) {
                ctx.fillStyle = '#0a0a0a';
                ctx.beginPath();
                ctx.moveTo(35, -10);
                ctx.lineTo(70, -8);
                ctx.lineTo(68, -16);
                ctx.lineTo(37, -18);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = '#1a1a1a';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(40, -13);
                ctx.lineTo(65, -11);
                ctx.stroke();
            }

            // Rear spoiler
            if (car.accessories.spoiler) {
                ctx.fillStyle = shadeColor(car.bodyColor, -30);
                ctx.beginPath();
                ctx.moveTo(-95, -42);
                ctx.lineTo(-55, -42);
                ctx.lineTo(-57, -36);
                ctx.lineTo(-93, -36);
                ctx.closePath();
                ctx.fill();
                // Spoiler stands
                ctx.fillRect(-90, -36, 5, 10);
                ctx.fillRect(-62, -36, 5, 10);
            }

            // Dual exhaust
            if (car.accessories.exhaust) {
                ctx.fillStyle = '#555';
                ctx.beginPath();
                ctx.ellipse(-100, 10, 7, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(-100, 2, 7, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#222';
                ctx.beginPath();
                ctx.ellipse(-100, 10, 4, 2.5, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(-100, 2, 4, 2.5, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // Wheels
            drawWheel(-55, 20, wheelRadius);
            drawWheel(60, 20, wheelRadius);
        }

        function drawSUV(wheelRadius) {
            // Taller body
            ctx.fillStyle = car.bodyColor;
            ctx.beginPath();
            ctx.moveTo(-85, 25);
            ctx.lineTo(-80, -15);
            ctx.lineTo(-55, -15);
            ctx.lineTo(-50, -55);
            ctx.lineTo(50, -55);
            ctx.lineTo(55, -15);
            ctx.lineTo(85, -15);
            ctx.lineTo(90, 25);
            ctx.closePath();
            ctx.fill();

            ctx.strokeStyle = shadeColor(car.bodyColor, -20);
            ctx.lineWidth = 2;
            ctx.stroke();

            drawCarDetails(wheelRadius, -50, 50, -55);
        }

        function drawTruck(wheelRadius) {
            // Cab
            ctx.fillStyle = car.bodyColor;
            ctx.beginPath();
            ctx.moveTo(-90, 25);
            ctx.lineTo(-85, -10);
            ctx.lineTo(-50, -10);
            ctx.lineTo(-40, -50);
            ctx.lineTo(10, -50);
            ctx.lineTo(15, -10);
            ctx.lineTo(15, 25);
            ctx.closePath();
            ctx.fill();

            // Bed
            ctx.fillStyle = shadeColor(car.bodyColor, -10);
            ctx.fillRect(20, -10, 75, 35);
            ctx.strokeStyle = shadeColor(car.bodyColor, -30);
            ctx.lineWidth = 2;
            ctx.strokeRect(20, -10, 75, 35);

            ctx.strokeStyle = shadeColor(car.bodyColor, -20);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-90, 25);
            ctx.lineTo(-85, -10);
            ctx.lineTo(-50, -10);
            ctx.lineTo(-40, -50);
            ctx.lineTo(10, -50);
            ctx.lineTo(15, -10);
            ctx.stroke();

            drawCarDetails(wheelRadius, -40, 10, -50, true);
        }

        function drawHatchback(wheelRadius) {
            ctx.fillStyle = car.bodyColor;
            ctx.beginPath();
            ctx.moveTo(-80, 20);
            ctx.lineTo(-75, -10);
            ctx.lineTo(-45, -10);
            ctx.lineTo(-30, -40);
            ctx.lineTo(45, -40);
            ctx.lineTo(75, -10);
            ctx.lineTo(80, 20);
            ctx.closePath();
            ctx.fill();

            ctx.strokeStyle = shadeColor(car.bodyColor, -20);
            ctx.lineWidth = 2;
            ctx.stroke();

            drawCarDetails(wheelRadius, -30, 45, -40);
        }

        function drawConvertible(wheelRadius) {
            ctx.fillStyle = car.bodyColor;
            ctx.beginPath();
            ctx.moveTo(-90, 15);
            ctx.lineTo(-85, -5);
            ctx.lineTo(-45, -5);
            ctx.lineTo(-35, -25);
            ctx.lineTo(25, -25);
            ctx.lineTo(35, -5);
            ctx.lineTo(95, -5);
            ctx.lineTo(95, 15);
            ctx.closePath();
            ctx.fill();

            // Windshield frame
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(-45, -5);
            ctx.lineTo(-35, -25);
            ctx.stroke();

            ctx.strokeStyle = shadeColor(car.bodyColor, -20);
            ctx.lineWidth = 2;
            ctx.stroke();

            drawCarDetails(wheelRadius, -35, 25, -25, false, true);
        }

        function drawCarDetails(wheelRadius, windowLeft, windowRight, roofY, isTruck = false, isConvertible = false) {
            // Windows
            if (!isConvertible) {
                ctx.fillStyle = car.accessories.tint ? 'rgba(20,20,40,0.85)' : 'rgba(135,206,250,0.7)';
                ctx.beginPath();
                ctx.moveTo(windowLeft + 5, roofY + 5);
                ctx.lineTo(windowRight - 5, roofY + 5);
                ctx.lineTo(isTruck ? windowRight - 5 : windowRight + 15, -12);
                ctx.lineTo(windowLeft + 15, -12);
                ctx.closePath();
                ctx.fill();

                // Window divider
                ctx.strokeStyle = shadeColor(car.bodyColor, -20);
                ctx.lineWidth = 3;
                ctx.beginPath();
                const midX = (windowLeft + windowRight) / 2;
                ctx.moveTo(midX, roofY + 5);
                ctx.lineTo(midX + 5, -12);
                ctx.stroke();
            }

            // Headlights
            ctx.fillStyle = '#fffde7';
            ctx.beginPath();
            ctx.ellipse(75, 0, 12, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.ellipse(75, 0, 8, 5, 0, 0, Math.PI * 2);
            ctx.fill();

            // Tail lights
            ctx.fillStyle = '#c0392b';
            ctx.beginPath();
            ctx.ellipse(-78, 0, 10, 7, 0, 0, Math.PI * 2);
            ctx.fill();

            // Fog lights
            if (car.accessories.lights) {
                ctx.fillStyle = '#f39c12';
                ctx.beginPath();
                ctx.arc(85, 12, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(-85, 12, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Stripe
            if (car.accessories.stripe) {
                ctx.fillStyle = '#fff';
                ctx.fillRect(-85, -3, 170, 6);
            }

            // Hood scoop
            if (car.accessories.scoop) {
                ctx.fillStyle = '#222';
                ctx.beginPath();
                ctx.moveTo(20, -12);
                ctx.lineTo(50, -12);
                ctx.lineTo(45, -22);
                ctx.lineTo(25, -22);
                ctx.closePath();
                ctx.fill();
            }

            // Spoiler
            if (car.accessories.spoiler) {
                ctx.fillStyle = shadeColor(car.bodyColor, -30);
                ctx.fillRect(-80, roofY - 8, 30, 5);
                ctx.fillRect(-78, roofY - 3, 3, 10);
                ctx.fillRect(-53, roofY - 3, 3, 10);
            }

            // Exhaust
            if (car.accessories.exhaust) {
                ctx.fillStyle = '#777';
                ctx.beginPath();
                ctx.ellipse(-92, 18, 8, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#555';
                ctx.beginPath();
                ctx.ellipse(-92, 18, 5, 3, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // Wheels
            drawWheel(-55, 30, wheelRadius);
            drawWheel(55, 30, wheelRadius);
        }

        function drawWheel(x, y, radius) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(wheelRotation);

            // Tire
            ctx.fillStyle = '#1a1a1a';
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, Math.PI * 2);
            ctx.fill();

            // Tire tread
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, radius - 2, 0, Math.PI * 2);
            ctx.stroke();

            // Rim
            const rimRadius = radius * 0.65;

            switch(car.wheels) {
                case 'standard':
                    drawStandardRim(rimRadius);
                    break;
                case 'sport':
                    drawSportRim(rimRadius);
                    break;
                case 'offroad':
                    drawOffroadRim(rimRadius);
                    break;
                case 'luxury':
                    drawLuxuryRim(rimRadius);
                    break;
                case 'racing':
                    drawRacingRim(rimRadius);
                    break;
                case 'classic':
                    drawClassicRim(rimRadius);
                    break;
            }

            ctx.restore();
        }

        function drawStandardRim(r) {
            ctx.fillStyle = '#c0c0c0';
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#888';
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.ellipse(0, r * 0.5, r * 0.15, r * 0.3, (i * Math.PI * 2) / 5, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.fillStyle = '#666';
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.25, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawSportRim(r) {
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = '#c0c0c0';
            ctx.lineWidth = 3;
            for (let i = 0; i < 6; i++) {
                const angle = (i * Math.PI * 2) / 6;
                ctx.beginPath();
                ctx.moveTo(r * 0.2 * Math.cos(angle), r * 0.2 * Math.sin(angle));
                ctx.lineTo(r * 0.85 * Math.cos(angle), r * 0.85 * Math.sin(angle));
                ctx.stroke();
            }

            ctx.fillStyle = '#c0c0c0';
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.2, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawOffroadRim(r) {
            ctx.fillStyle = '#2c2c2c';
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#555';
            for (let i = 0; i < 8; i++) {
                const angle = (i * Math.PI * 2) / 8;
                ctx.beginPath();
                ctx.arc(r * 0.55 * Math.cos(angle), r * 0.55 * Math.sin(angle), r * 0.2, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.fillStyle = '#777';
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.35, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawLuxuryRim(r) {
            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#b8960c';
            for (let i = 0; i < 10; i++) {
                const angle = (i * Math.PI * 2) / 10;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(r * Math.cos(angle - 0.15), r * Math.sin(angle - 0.15));
                ctx.lineTo(r * Math.cos(angle + 0.15), r * Math.sin(angle + 0.15));
                ctx.closePath();
                ctx.fill();
            }

            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.3, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawRacingRim(r) {
            ctx.fillStyle = '#111';
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#e74c3c';
            for (let i = 0; i < 5; i++) {
                const angle = (i * Math.PI * 2) / 5;
                ctx.beginPath();
                ctx.moveTo(r * 0.25 * Math.cos(angle), r * 0.25 * Math.sin(angle));
                ctx.lineTo(r * 0.85 * Math.cos(angle - 0.2), r * 0.85 * Math.sin(angle - 0.2));
                ctx.lineTo(r * 0.85 * Math.cos(angle + 0.2), r * 0.85 * Math.sin(angle + 0.2));
                ctx.closePath();
                ctx.fill();
            }

            ctx.fillStyle = '#c0c0c0';
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.25, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawClassicRim(r) {
            ctx.fillStyle = '#f5f5dc';
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = '#8b7355';
            ctx.lineWidth = r * 0.08;
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.7, 0, Math.PI * 2);
            ctx.stroke();

            ctx.fillStyle = '#8b7355';
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.3, 0, Math.PI * 2);
            ctx.fill();
        }

        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, Math.min(255, (num >> 16) + amt));
            const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
            const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        function gameLoop() {
            if (testDriving) {
                // Accelerate
                carSpeed = Math.min(carSpeed + 0.5, 15);
                carX += carSpeed * 0.5;
                wheelRotation += carSpeed * 0.05;

                // Move clouds
                clouds.forEach(cloud => {
                    cloud.x -= carSpeed * 0.3;
                    if (cloud.x < -60) cloud.x = canvas.width + 60;
                });

                // Loop car position
                if (carX > canvas.width + 100) {
                    carX = -100;
                }

                document.getElementById('speed-display').textContent = Math.round(carSpeed * 8) + ' MPH';
            } else {
                carSpeed = Math.max(0, carSpeed - 0.3);
                if (carSpeed > 0) {
                    wheelRotation += carSpeed * 0.05;
                }
            }

            draw();
            requestAnimationFrame(gameLoop);
        }

        // Touch controls - Virtual Joystick
        const joystickContainer = document.getElementById('joystick-container');
        const joystickKnob = document.getElementById('joystick-knob');
        const driveButton = document.getElementById('drive-button');

        let joystickActive = false;
        let joystickTouchId = null;
        let joystickCenter = { x: 60, y: 60 };
        const joystickRadius = 35;
        let carDriveKeys = { left: false, right: false, accelerate: false, brake: false };

        // Show joystick on touch devices
        function showTouchControls() {
            joystickContainer.style.display = 'block';
            driveButton.style.display = 'flex';
        }

        // Detect touch device
        if ('ontouchstart' in window) {
            showTouchControls();
        }

        joystickContainer.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const touch = e.changedTouches[0];
            joystickActive = true;
            joystickTouchId = touch.identifier;

            updateCarJoystick(touch);
        }, { passive: false });

        joystickContainer.addEventListener('touchmove', (e) => {
            if (!joystickActive) return;
            e.preventDefault();
            e.stopPropagation();

            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === joystickTouchId) {
                    updateCarJoystick(e.changedTouches[i]);
                    break;
                }
            }
        }, { passive: false });

        joystickContainer.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();

            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === joystickTouchId) {
                    resetCarJoystick();
                    break;
                }
            }
        }, { passive: false });

        joystickContainer.addEventListener('touchcancel', (e) => {
            resetCarJoystick();
        }, { passive: false });

        function updateCarJoystick(touch) {
            const rect = joystickContainer.getBoundingClientRect();
            let dx = touch.clientX - rect.left - joystickCenter.x;
            let dy = touch.clientY - rect.top - joystickCenter.y;

            // Clamp to radius
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > joystickRadius) {
                dx = (dx / dist) * joystickRadius;
                dy = (dy / dist) * joystickRadius;
            }

            // Update knob position
            joystickKnob.style.left = (joystickCenter.x + dx - 25) + 'px';
            joystickKnob.style.top = (joystickCenter.y + dy - 25) + 'px';

            // Update drive keys based on joystick position
            const deadzone = 15;
            carDriveKeys.left = dx < -deadzone;
            carDriveKeys.right = dx > deadzone;
            carDriveKeys.accelerate = dy < -deadzone;
            carDriveKeys.brake = dy > deadzone;
        }

        function resetCarJoystick() {
            joystickActive = false;
            joystickTouchId = null;
            joystickKnob.style.left = '35px';
            joystickKnob.style.top = '35px';
            carDriveKeys.left = false;
            carDriveKeys.right = false;
            carDriveKeys.accelerate = false;
            carDriveKeys.brake = false;
        }

        // Drive button - toggle test drive
        driveButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            testDrive();
        }, { passive: false });

        // Prevent canvas default touch but allow for interaction
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        // Initialize
        initColors();
        gameLoop();
    </script>
</body>
</html>
