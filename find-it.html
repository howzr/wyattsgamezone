<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find It!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a2e; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { margin-bottom: 10px; color: #ffd700; }
        #top-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; justify-content: center; }
        #money-display { font-size: 18px; color: #2ecc71; font-weight: bold; }
        .top-btn { padding: 8px 16px; font-size: 14px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #shop-btn { background: #e74c3c; }
        #tiny-games-btn { background: #9b59b6; }
        #crate-btn { background: #f39c12; }
        .top-btn:hover { opacity: 0.8; }
        #mode-container { margin-bottom: 10px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .mode-btn { padding: 6px 12px; font-size: 12px; border: 2px solid #444; background: #2a2a4e; color: white; border-radius: 6px; cursor: pointer; }
        .mode-btn:hover { background: #3a3a6e; }
        .mode-btn.active { border-color: #ffd700; background: #3a3a6e; }
        .mode-btn.easy { border-color: #2ecc71; } .mode-btn.easy.active { background: #2ecc71; color: #1a1a2e; }
        .mode-btn.normal { border-color: #3498db; } .mode-btn.normal.active { background: #3498db; color: #1a1a2e; }
        .mode-btn.hard { border-color: #e74c3c; } .mode-btn.hard.active { background: #e74c3c; }
        .mode-btn.extreme { border-color: #9b59b6; } .mode-btn.extreme.active { background: #9b59b6; }
        #scoreboard { display: flex; gap: 15px; margin-bottom: 10px; font-size: 14px; flex-wrap: wrap; justify-content: center; }
        .score { padding: 6px 12px; border-radius: 8px; font-weight: bold; }
        .player-score { background: #4CAF50; } .ai1-score { background: #e74c3c; } .ai2-score { background: #9b59b6; } .ai3-score { background: #f39c12; }
        .ai-score-hidden { display: none; }
        #dots-left { margin-bottom: 8px; font-size: 14px; color: #ffd700; }
        #game-container { position: relative; width: 800px; height: 600px; background: #16213e; border: 3px solid #ffd700; border-radius: 10px; overflow: hidden; }
        .dot { position: absolute; width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, #fff5a0, #ffd700, #b8860b); border-radius: 50%; box-shadow: 0 0 10px #ffd700; }
        .character { position: absolute; width: 40px; height: 40px; border-radius: 50%; z-index: 10; }
        .character-body { width: 100%; height: 100%; border-radius: 50%; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .character-face { position: absolute; width: 100%; height: 100%; top: 0; left: 0; }
        .eye { position: absolute; width: 25%; height: 30%; background: white; border-radius: 50%; top: 30%; }
        .eye-left { left: 20%; } .eye-right { right: 20%; }
        .pupil { position: absolute; width: 50%; height: 50%; background: #222; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .mouth { position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); width: 35%; height: 18%; border-bottom: 3px solid #222; border-radius: 0 0 10px 10px; }
        .eyebrow { position: absolute; width: 20%; height: 8%; background: #333; border-radius: 2px; top: 22%; }
        .eyebrow-left { left: 22%; transform: rotate(-10deg); } .eyebrow-right { right: 22%; transform: rotate(10deg); }
        .ai .eyebrow-left { transform: rotate(15deg); } .ai .eyebrow-right { transform: rotate(-15deg); }
        .ai .mouth { border-bottom: none; border-top: 3px solid #222; border-radius: 10px 10px 0 0; height: 12%; }
        .ai-hidden { display: none; }
        #message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px; font-weight: bold; text-shadow: 2px 2px 4px black; display: none; z-index: 100; text-align: center; }
        #earned-money { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: #2ecc71; display: none; z-index: 100; }
        #restart-btn { margin-top: 10px; padding: 10px 25px; font-size: 16px; background: #ffd700; color: #1a1a2e; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #instructions { margin-top: 10px; color: #aaa; font-size: 12px; text-align: center; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal.open { display: flex; }
        .modal-content { background: #1a1a2e; border: 3px solid #ffd700; border-radius: 15px; padding: 25px; max-width: 800px; max-height: 85vh; overflow-y: auto; }
        .modal-content h2 { color: #ffd700; margin-bottom: 10px; text-align: center; font-size: 24px; }
        .close-btn { display: block; margin: 15px auto 0; padding: 10px 25px; font-size: 14px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; }
        #shop-money { text-align: center; color: #2ecc71; font-size: 16px; margin-bottom: 15px; }
        .skin-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .skin-item { background: #2a2a4e; border: 2px solid #444; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .skin-item:hover { border-color: #ffd700; transform: scale(1.05); }
        .skin-item.owned { border-color: #2ecc71; }
        .skin-item.equipped { border-color: #ffd700; background: #3a3a6e; }
        .skin-item.locked { opacity: 0.5; }
        .skin-item.tiny-exclusive { border-color: #9b59b6; }
        .skin-item.crate-exclusive { border-color: #f39c12; }
        .skin-preview { width: 40px; height: 40px; margin: 0 auto 8px; border-radius: 50%; }
        .skin-name { font-size: 10px; color: #fff; margin-bottom: 3px; }
        .skin-price { font-size: 11px; color: #2ecc71; font-weight: bold; }
        .skin-price.tiny-unlock { color: #9b59b6; }
        .skin-price.crate-only { color: #f39c12; }
        .skin-status { font-size: 9px; color: #aaa; margin-top: 3px; }
        .rarity-common { box-shadow: 0 0 5px #aaa; }
        .rarity-rare { box-shadow: 0 0 8px #3498db; }
        .rarity-epic { box-shadow: 0 0 10px #9b59b6; }
        .rarity-legendary { box-shadow: 0 0 12px #f39c12; }
        .tab-container { display: flex; gap: 8px; margin-bottom: 15px; justify-content: center; flex-wrap: wrap; }
        .tab-btn { padding: 8px 15px; background: #2a2a4e; border: 2px solid #444; color: white; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .tab-btn:hover { background: #3a3a6e; }
        .tab-btn.active { border-color: #ffd700; background: #3a3a6e; }
        .shop-tab { display: none; }
        .shop-tab.active { display: block; }
        .section-title { color: #9b59b6; font-size: 12px; margin: 15px 0 8px; padding-top: 10px; border-top: 1px solid #444; }
        .section-title.crate { color: #f39c12; }
        .tiny-games-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .tiny-game-card { background: #2a2a4e; border: 3px solid #9b59b6; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .tiny-game-card:hover { transform: scale(1.05); border-color: #ffd700; }
        .tiny-game-card h3 { color: #ffd700; margin-bottom: 5px; font-size: 14px; }
        .tiny-game-card p { color: #aaa; font-size: 10px; }
        .tiny-game-icon { font-size: 30px; margin-bottom: 8px; }
        #tiny-wins-display { text-align: center; color: #9b59b6; font-size: 14px; margin-bottom: 10px; }
        #minigame-container { width: 380px; height: 320px; background: #16213e; border: 3px solid #9b59b6; border-radius: 10px; position: relative; margin: 0 auto 15px; overflow: hidden; }
        #minigame-info { text-align: center; margin-bottom: 10px; font-size: 16px; }
        #minigame-timer { color: #e74c3c; font-weight: bold; }
        #minigame-score { color: #2ecc71; font-weight: bold; }
        .minigame-dot { position: absolute; border-radius: 50%; cursor: pointer; }
        #minigame-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; font-weight: bold; text-align: center; display: none; z-index: 10; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; }
        .memory-card { position: absolute; width: 55px; height: 55px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .memory-card.hidden { background: #9b59b6; }
        .memory-card.revealed { background: #2ecc71; }
        .memory-card.matched { background: #ffd700; }
        #reaction-target { position: absolute; width: 70px; height: 70px; background: #e74c3c; border-radius: 50%; cursor: pointer; display: none; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #reaction-instruction { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; text-align: center; }
        .start-minigame-btn { display: block; margin: 0 auto; padding: 12px 30px; font-size: 16px; background: #9b59b6; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .pacman { position: absolute; width: 24px; height: 24px; background: #ffd700; border-radius: 50%; }
        .pacman-dot { position: absolute; width: 6px; height: 6px; background: #ffd700; border-radius: 50%; }
        .ghost { position: absolute; width: 22px; height: 22px; border-radius: 50% 50% 5px 5px; }
        #crate-container { text-align: center; }
        .crate-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        .crate-item { background: #2a2a4e; border: 3px solid #f39c12; border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .crate-item:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); }
        .crate-icon { font-size: 50px; margin-bottom: 10px; }
        .crate-name { font-size: 16px; color: #ffd700; margin-bottom: 5px; }
        .crate-price { font-size: 14px; color: #2ecc71; }
        .crate-contents { font-size: 10px; color: #aaa; margin-top: 5px; }
        #crate-opening { display: none; text-align: center; }
        #crate-result { font-size: 24px; margin: 20px 0; }
        .crate-skin-reveal { width: 80px; height: 80px; margin: 0 auto; border-radius: 50%; animation: pulse 0.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
        .shaking { animation: shake 0.1s linear infinite; }
        .dice { width: 80px; height: 80px; background: linear-gradient(145deg, #fff, #ddd); border: 3px solid #e67e22; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .dice.rolling { animation: diceRoll 0.1s linear infinite; }
        @keyframes diceRoll { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(15deg) scale(1.1); } 50% { transform: rotate(0deg) scale(1); } 75% { transform: rotate(-15deg) scale(1.1); } }
    </style>
</head>
<body>
    <h1>Find It!</h1>
    <div id="top-bar">
        <div id="money-display">$0</div>
        <button id="shop-btn" class="top-btn">Shop</button>
        <button id="crate-btn" class="top-btn">Crates</button>
        <button id="tiny-games-btn" class="top-btn">Tiny Games</button>
        <button id="lottery-btn" class="top-btn" style="background:#e67e22;">Lottery</button>
    </div>
    <div id="mode-container">
        <button class="mode-btn easy active" data-mode="easy">Easy</button>
        <button class="mode-btn normal" data-mode="normal">Normal</button>
        <button class="mode-btn hard" data-mode="hard">Hard</button>
        <button class="mode-btn extreme" data-mode="extreme">Extreme</button>
    </div>
    <div id="dots-left">Dots: 50</div>
    <div id="scoreboard">
        <div class="score player-score">You: <span id="player-points">0</span></div>
        <div class="score ai1-score">AI1: <span id="ai1-points">0</span></div>
        <div class="score ai2-score">AI2: <span id="ai2-points">0</span></div>
        <div class="score ai3-score">AI3: <span id="ai3-points">0</span></div>
    </div>
    <div id="game-container">
        <div id="player" class="character"></div>
        <div id="ai1" class="character ai"></div>
        <div id="ai2" class="character ai"></div>
        <div id="ai3" class="character ai"></div>
        <div id="message"></div>
        <div id="earned-money"></div>
    </div>
    <button id="restart-btn">Restart</button>
    <p id="instructions">Arrow keys to move!</p>

    <div id="shop-modal" class="modal">
        <div class="modal-content">
            <h2>Shop</h2>
            <div id="shop-money">$0 | Tiny Wins: 0</div>
            <div class="tab-container">
                <button class="tab-btn active" data-tab="player-skins">Your Skins</button>
                <button class="tab-btn" data-tab="ai-skins">AI Skins</button>
            </div>
            <div id="player-skins" class="shop-tab active">
                <div class="skin-grid" id="player-skin-grid"></div>
                <div class="section-title">Tiny Games Exclusive</div>
                <div class="skin-grid" id="player-tiny-skin-grid"></div>
                <div class="section-title crate">Crate Exclusive</div>
                <div class="skin-grid" id="player-crate-skin-grid"></div>
            </div>
            <div id="ai-skins" class="shop-tab">
                <div class="skin-grid" id="ai-skin-grid"></div>
                <div class="section-title">Tiny Games Exclusive</div>
                <div class="skin-grid" id="ai-tiny-skin-grid"></div>
                <div class="section-title crate">Crate Exclusive</div>
                <div class="skin-grid" id="ai-crate-skin-grid"></div>
            </div>
            <button class="close-btn" onclick="closeShop()">Close</button>
        </div>
    </div>

    <div id="crate-modal" class="modal">
        <div class="modal-content">
            <h2>Crates</h2>
            <div id="crate-money">Your Money: $0</div>
            <div id="crate-container">
                <div class="crate-grid" id="crate-grid"></div>
            </div>
            <div id="crate-opening">
                <div id="crate-animation">üéÅ</div>
                <div id="crate-result"></div>
                <button class="start-minigame-btn" onclick="closeCrateResult()">Continue</button>
            </div>
            <button class="close-btn" id="close-crate-btn" onclick="closeCrates()">Close</button>
        </div>
    </div>

    <div id="tiny-games-modal" class="modal">
        <div class="modal-content">
            <h2>Tiny Games</h2>
            <div id="tiny-wins-display">Tiny Wins: 0</div>
            <div id="tiny-games-menu">
                <div class="tiny-games-grid">
                    <div class="tiny-game-card" onclick="startMiniGame('clicker')"><div class="tiny-game-icon">üéØ</div><h3>Click Frenzy</h3><p>Click 15+ dots in 15s</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('memory')"><div class="tiny-game-icon">üß†</div><h3>Memory</h3><p>Match all pairs</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('reaction')"><div class="tiny-game-icon">‚ö°</div><h3>Reaction</h3><p>Avg under 400ms</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('pacman')"><div class="tiny-game-icon">üëª</div><h3>Pac-Man</h3><p>Eat dots, avoid ghosts!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('snake')"><div class="tiny-game-icon">üêç</div><h3>Snake</h3><p>Eat 20 food to win!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('flappy')"><div class="tiny-game-icon">üê¶</div><h3>Flappy Bird</h3><p>Pass 15 pipes!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('tetris')"><div class="tiny-game-icon">üß±</div><h3>Tetris</h3><p>Clear 10 lines!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('breakout')"><div class="tiny-game-icon">üß®</div><h3>Breakout</h3><p>Break all bricks!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('pong')"><div class="tiny-game-icon">üèì</div><h3>Pong</h3><p>First to 7 wins!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('invaders')"><div class="tiny-game-icon">üëæ</div><h3>Space Invaders</h3><p>Destroy all aliens!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('doodle')"><div class="tiny-game-icon">ü¶ò</div><h3>Doodle Jump</h3><p>Reach 2000 height!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('crossy')"><div class="tiny-game-icon">üêî</div><h3>Crossy Road</h3><p>Cross 20 lanes!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('game2048')"><div class="tiny-game-icon">üî¢</div><h3>2048</h3><p>Reach 2048 tile!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('whack')"><div class="tiny-game-icon">üî®</div><h3>Whack-a-Mole</h3><p>Whack 20 moles!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('asteroids')"><div class="tiny-game-icon">‚òÑÔ∏è</div><h3>Asteroids</h3><p>Destroy 30 asteroids!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('runner')"><div class="tiny-game-icon">üèÉ</div><h3>Temple Run</h3><p>Run 1000 meters!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('fruit')"><div class="tiny-game-icon">üçâ</div><h3>Fruit Ninja</h3><p>Slice 30 fruits!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('geometry')"><div class="tiny-game-icon">üî∑</div><h3>Geometry Dash</h3><p>Survive 100 meters!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('piano')"><div class="tiny-game-icon">üéπ</div><h3>Piano Tiles</h3><p>Tap 30 black tiles!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('simon')"><div class="tiny-game-icon">üî¥</div><h3>Simon Says</h3><p>Remember 10 patterns!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('tictactoe')"><div class="tiny-game-icon">‚≠ï</div><h3>Tic Tac Toe</h3><p>Beat AI 2 times!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('connect4')"><div class="tiny-game-icon">üî¥</div><h3>Connect Four</h3><p>Beat AI 2 times!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('trivia')"><div class="tiny-game-icon">‚ùì</div><h3>Trivia</h3><p>Answer 8/10 correctly!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('typing')"><div class="tiny-game-icon">‚å®Ô∏è</div><h3>Typing Speed</h3><p>Type 15 words in 30s!</p></div>
                    <div class="tiny-game-card" onclick="startMiniGame('hangman')"><div class="tiny-game-icon">ü™¢</div><h3>Hangman</h3><p>Guess the word!</p></div>
                </div>
            </div>
            <div id="minigame-area" style="display:none;">
                <div id="minigame-info"><span id="minigame-timer">Time: 15</span> | <span id="minigame-score">Score: 0</span></div>
                <div id="minigame-container"><div id="minigame-message"></div><div id="reaction-target"></div><div id="reaction-instruction"></div></div>
                <button class="start-minigame-btn" id="play-again-btn" style="display:none;" onclick="restartMiniGame()">Play Again</button>
                <button class="close-btn" onclick="backToTinyMenu()">Back</button>
            </div>
            <button class="close-btn" id="close-tiny-btn" onclick="closeTinyGames()">Close</button>
        </div>
    </div>

    <div id="lottery-modal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h2>Lottery</h2>
            <div id="lottery-money">Your Money: $0</div>
            <p style="color:#aaa;font-size:12px;margin:10px 0;">Roll 2 dice (5-10 each). Higher total = better prize!</p>
            <div id="lottery-prizes" style="margin-bottom:15px;background:#2a2a4e;border-radius:10px;padding:15px;">
                <div style="color:#ffd700;font-size:14px;margin-bottom:10px;">Prize Table</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">
                    <div style="text-align:left;color:#aaa;">10-11:</div><div style="text-align:right;color:#2ecc71;">$20</div>
                    <div style="text-align:left;color:#aaa;">12-13:</div><div style="text-align:right;color:#2ecc71;">$40</div>
                    <div style="text-align:left;color:#aaa;">14-15:</div><div style="text-align:right;color:#2ecc71;">$60</div>
                    <div style="text-align:left;color:#aaa;">16-17:</div><div style="text-align:right;color:#9b59b6;">Free Skin</div>
                    <div style="text-align:left;color:#aaa;">18-19:</div><div style="text-align:right;color:#3498db;">Rare Skin</div>
                    <div style="text-align:left;color:#ffd700;">20:</div><div style="text-align:right;color:#ffd700;">JACKPOT! $200 + Legendary</div>
                </div>
            </div>
            <div id="dice-container" style="display:flex;justify-content:center;gap:30px;margin:20px 0;">
                <div class="dice" id="die1">?</div>
                <div class="dice" id="die2">?</div>
            </div>
            <div id="dice-total" style="font-size:24px;color:#ffd700;margin:15px 0;">Total: ?</div>
            <div id="lottery-result" style="font-size:18px;min-height:60px;margin:15px 0;"></div>
            <button id="roll-btn" class="start-minigame-btn" style="background:#e67e22;" onclick="rollLottery()">Roll! ($25)</button>
            <button class="close-btn" onclick="closeLottery()">Close</button>
        </div>
    </div>

    <script>
        const GAME_WIDTH = 800, GAME_HEIGHT = 600, TOTAL_DOTS = 50, PLAYER_SIZE = 40, DOT_SIZE = 20, COLLECTION_DISTANCE = 30;

        const PLAYER_SKINS = [
            { id: 'default', name: 'Green', price: 0, colors: { body: '#4CAF50', bodyGradient: '#388E3C', border: '#fff' } },
            { id: 'blue', name: 'Blue', price: 30, colors: { body: '#3498db', bodyGradient: '#2980b9', border: '#fff' } },
            { id: 'red', name: 'Red', price: 30, colors: { body: '#e74c3c', bodyGradient: '#c0392b', border: '#fff' } },
            { id: 'pink', name: 'Pink', price: 50, colors: { body: '#e91e63', bodyGradient: '#c2185b', border: '#fff' } },
            { id: 'orange', name: 'Orange', price: 50, colors: { body: '#ff9800', bodyGradient: '#f57c00', border: '#fff' } },
            { id: 'purple', name: 'Purple', price: 60, colors: { body: '#9c27b0', bodyGradient: '#7b1fa2', border: '#fff' } },
            { id: 'cyan', name: 'Cyan', price: 70, colors: { body: '#00bcd4', bodyGradient: '#0097a7', border: '#fff' } },
            { id: 'lime', name: 'Lime', price: 70, colors: { body: '#cddc39', bodyGradient: '#afb42b', border: '#333' } },
            { id: 'teal', name: 'Teal', price: 80, colors: { body: '#009688', bodyGradient: '#00796b', border: '#fff' } },
            { id: 'indigo', name: 'Indigo', price: 90, colors: { body: '#3f51b5', bodyGradient: '#303f9f', border: '#fff' } },
            { id: 'amber', name: 'Amber', price: 100, colors: { body: '#ffc107', bodyGradient: '#ffa000', border: '#333' } },
            { id: 'gold', name: 'Gold', price: 150, colors: { body: '#ffd700', bodyGradient: '#b8860b', border: '#fff' } },
            { id: 'silver', name: 'Silver', price: 120, colors: { body: '#bdc3c7', bodyGradient: '#95a5a6', border: '#fff' } },
            { id: 'bronze', name: 'Bronze', price: 100, colors: { body: '#cd7f32', bodyGradient: '#8b4513', border: '#fff' } },
            { id: 'rainbow', name: 'Rainbow', price: 300, colors: { body: 'linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff)', bodyGradient: '#ff0000', border: '#fff', isGradient: true } },
            { id: 'ghost', name: 'Ghost', price: 200, colors: { body: 'rgba(255,255,255,0.7)', bodyGradient: 'rgba(200,200,200,0.7)', border: '#aaa', eyeColor: '#666' } },
        ];

        const TINY_PLAYER_SKINS = [
            { id: 'tiny-star', name: 'Star', winsRequired: 1, colors: { body: '#fff44f', bodyGradient: '#ffd700', border: '#fff' } },
            { id: 'tiny-diamond', name: 'Diamond', winsRequired: 3, colors: { body: '#b9f2ff', bodyGradient: '#00d4ff', border: '#fff' } },
            { id: 'tiny-ninja', name: 'Ninja', winsRequired: 5, colors: { body: '#2c2c2c', bodyGradient: '#1a1a1a', border: '#444', eyeColor: '#fff' } },
            { id: 'tiny-fire', name: 'Fire', winsRequired: 7, colors: { body: 'linear-gradient(180deg, #ff4500, #ffd700)', bodyGradient: '#ff4500', border: '#fff', isGradient: true } },
            { id: 'tiny-ice', name: 'Ice', winsRequired: 9, colors: { body: 'linear-gradient(180deg, #a8e6cf, #00d4ff)', bodyGradient: '#00d4ff', border: '#fff', isGradient: true } },
            { id: 'tiny-sunset', name: 'Sunset', winsRequired: 12, colors: { body: 'linear-gradient(180deg, #ff6b6b, #ffd93d)', bodyGradient: '#ff6b6b', border: '#fff', isGradient: true } },
            { id: 'tiny-galaxy', name: 'Galaxy', winsRequired: 15, colors: { body: 'linear-gradient(45deg, #0f0c29, #302b63, #24243e)', bodyGradient: '#302b63', border: '#9b59b6', isGradient: true, eyeColor: '#fff' } },
            { id: 'tiny-aurora', name: 'Aurora', winsRequired: 18, colors: { body: 'linear-gradient(45deg, #00c9ff, #92fe9d)', bodyGradient: '#00c9ff', border: '#fff', isGradient: true } },
            { id: 'tiny-champion', name: 'Champion', winsRequired: 25, colors: { body: 'linear-gradient(45deg, #ffd700, #ff6b6b, #ffd700)', bodyGradient: '#ffd700', border: '#fff', isGradient: true } },
        ];

        const CRATE_PLAYER_SKINS = [
            { id: 'crate-pixel', name: 'Pixel', rarity: 'common', colors: { body: '#8bc34a', bodyGradient: '#689f38', border: '#fff' } },
            { id: 'crate-neon', name: 'Neon', rarity: 'common', colors: { body: '#00ff00', bodyGradient: '#00cc00', border: '#0f0' } },
            { id: 'crate-ocean', name: 'Ocean', rarity: 'common', colors: { body: '#006994', bodyGradient: '#004466', border: '#fff' } },
            { id: 'crate-berry', name: 'Berry', rarity: 'rare', colors: { body: '#8e44ad', bodyGradient: '#6c3483', border: '#fff' } },
            { id: 'crate-mint', name: 'Mint', rarity: 'rare', colors: { body: '#1abc9c', bodyGradient: '#16a085', border: '#fff' } },
            { id: 'crate-coral', name: 'Coral', rarity: 'rare', colors: { body: '#ff7f50', bodyGradient: '#ff6347', border: '#fff' } },
            { id: 'crate-electric', name: 'Electric', rarity: 'epic', colors: { body: 'linear-gradient(45deg, #00ffff, #ff00ff)', bodyGradient: '#00ffff', border: '#fff', isGradient: true } },
            { id: 'crate-lava', name: 'Lava', rarity: 'epic', colors: { body: 'linear-gradient(180deg, #ff0000, #ff4500, #ffd700)', bodyGradient: '#ff0000', border: '#ff4500', isGradient: true } },
            { id: 'crate-cosmic', name: 'Cosmic', rarity: 'epic', colors: { body: 'linear-gradient(45deg, #667eea, #764ba2)', bodyGradient: '#667eea', border: '#fff', isGradient: true } },
            { id: 'crate-dragon', name: 'Dragon', rarity: 'legendary', colors: { body: 'linear-gradient(45deg, #ff0000, #8b0000, #ff4500)', bodyGradient: '#8b0000', border: '#ffd700', isGradient: true, eyeColor: '#ffd700' } },
            { id: 'crate-phoenix', name: 'Phoenix', rarity: 'legendary', colors: { body: 'linear-gradient(45deg, #ff4500, #ffd700, #ff6347)', bodyGradient: '#ff4500', border: '#ffd700', isGradient: true } },
            { id: 'crate-void', name: 'Void', rarity: 'legendary', colors: { body: 'linear-gradient(45deg, #000000, #1a1a2e, #000000)', bodyGradient: '#000', border: '#9b59b6', isGradient: true, eyeColor: '#9b59b6' } },
        ];

        const AI_SKINS = [
            { id: 'default', name: 'Classic', price: 0, colors: { ai1: '#e74c3c', ai2: '#9b59b6', ai3: '#f39c12' } },
            { id: 'ocean', name: 'Ocean', price: 80, colors: { ai1: '#1abc9c', ai2: '#3498db', ai3: '#2c3e50' } },
            { id: 'forest', name: 'Forest', price: 80, colors: { ai1: '#27ae60', ai2: '#2ecc71', ai3: '#16a085' } },
            { id: 'fire', name: 'Fire', price: 100, colors: { ai1: '#e74c3c', ai2: '#e67e22', ai3: '#f1c40f' } },
            { id: 'pastel', name: 'Pastel', price: 120, colors: { ai1: '#ffb3ba', ai2: '#bae1ff', ai3: '#baffc9' } },
            { id: 'dark', name: 'Shadow', price: 150, colors: { ai1: '#2c3e50', ai2: '#34495e', ai3: '#1a252f' } },
            { id: 'neon', name: 'Neon', price: 200, colors: { ai1: '#ff00ff', ai2: '#00ffff', ai3: '#ffff00' } },
            { id: 'mono', name: 'Mono', price: 100, colors: { ai1: '#555', ai2: '#777', ai3: '#999' } },
            { id: 'warm', name: 'Warm', price: 90, colors: { ai1: '#ff6b6b', ai2: '#feca57', ai3: '#ff9ff3' } },
            { id: 'cool', name: 'Cool', price: 90, colors: { ai1: '#54a0ff', ai2: '#5f27cd', ai3: '#00d2d3' } },
            { id: 'earth', name: 'Earth', price: 110, colors: { ai1: '#8b4513', ai2: '#228b22', ai3: '#deb887' } },
            { id: 'robot', name: 'Robot', price: 250, colors: { ai1: '#95a5a6', ai2: '#7f8c8d', ai3: '#bdc3c7', isRobot: true } },
        ];

        const TINY_AI_SKINS = [
            { id: 'tai-ice', name: 'Ice', winsRequired: 2, colors: { ai1: '#a8e6cf', ai2: '#88d8b0', ai3: '#6bc5a0' } },
            { id: 'tai-lava', name: 'Lava', winsRequired: 4, colors: { ai1: '#ff4500', ai2: '#ff6347', ai3: '#ff7f50' } },
            { id: 'tai-void', name: 'Void', winsRequired: 6, colors: { ai1: '#1a1a2e', ai2: '#16213e', ai3: '#0f3460' } },
            { id: 'tai-candy', name: 'Candy', winsRequired: 8, colors: { ai1: '#ff69b4', ai2: '#87ceeb', ai3: '#98fb98' } },
            { id: 'tai-sunset', name: 'Sunset', winsRequired: 10, colors: { ai1: '#ff6b6b', ai2: '#ffd93d', ai3: '#6bcb77' } },
            { id: 'tai-storm', name: 'Storm', winsRequired: 14, colors: { ai1: '#4a4e69', ai2: '#22223b', ai3: '#9a8c98' } },
            { id: 'tai-electric', name: 'Electric', winsRequired: 20, colors: { ai1: '#00ffff', ai2: '#ff00ff', ai3: '#00ff00', isRobot: true } },
        ];

        const CRATE_AI_SKINS = [
            { id: 'cai-retro', name: 'Retro', rarity: 'common', colors: { ai1: '#ff6b6b', ai2: '#4ecdc4', ai3: '#ffe66d' } },
            { id: 'cai-cyber', name: 'Cyber', rarity: 'common', colors: { ai1: '#00d9ff', ai2: '#ff00aa', ai3: '#00ff88' } },
            { id: 'cai-autumn', name: 'Autumn', rarity: 'rare', colors: { ai1: '#d35400', ai2: '#c0392b', ai3: '#f39c12' } },
            { id: 'cai-spring', name: 'Spring', rarity: 'rare', colors: { ai1: '#ff9ff3', ai2: '#feca57', ai3: '#00d2d3' } },
            { id: 'cai-galaxy', name: 'Galaxy', rarity: 'epic', colors: { ai1: '#667eea', ai2: '#764ba2', ai3: '#f093fb' } },
            { id: 'cai-inferno', name: 'Inferno', rarity: 'epic', colors: { ai1: '#ff0000', ai2: '#ff4500', ai3: '#8b0000' } },
            { id: 'cai-divine', name: 'Divine', rarity: 'legendary', colors: { ai1: '#ffd700', ai2: '#fff8dc', ai3: '#fffacd' } },
            { id: 'cai-abyss', name: 'Abyss', rarity: 'legendary', colors: { ai1: '#000', ai2: '#1a1a2e', ai3: '#0d0d1a' } },
        ];

        const CRATES = [
            { id: 'basic', name: 'Basic Crate', price: 50, icon: 'üì¶', contents: 'Common skins', weights: { common: 70, rare: 25, epic: 5, legendary: 0 } },
            { id: 'premium', name: 'Premium Crate', price: 150, icon: 'üéÅ', contents: 'Rare+ skins', weights: { common: 40, rare: 40, epic: 18, legendary: 2 } },
            { id: 'legendary', name: 'Legendary Crate', price: 400, icon: 'üëë', contents: 'Epic+ skins', weights: { common: 0, rare: 30, epic: 55, legendary: 15 } },
        ];

        const MODES = {
            easy: { aiCount: 1, aiSpeeds: { ai1: 2, ai2: 0, ai3: 0 }, moneyPerDot: 1 },
            normal: { aiCount: 2, aiSpeeds: { ai1: 2.5, ai2: 2.5, ai3: 0 }, moneyPerDot: 2 },
            hard: { aiCount: 3, aiSpeeds: { ai1: 3, ai2: 3, ai3: 3 }, moneyPerDot: 3 },
            extreme: { aiCount: 3, aiSpeeds: { ai1: 4, ai2: 4.5, ai3: 5 }, moneyPerDot: 5 }
        };

        let currentMode = 'easy', dots = [], scores = { player: 0, ai1: 0, ai2: 0, ai3: 0 }, gameOver = false;
        let totalMoney = 0, tinyWins = 0;
        let ownedPlayerSkins = ['default'], ownedTinyPlayerSkins = [], ownedCratePlayerSkins = [];
        let ownedAISkins = ['default'], ownedTinyAISkins = [], ownedCrateAISkins = [];
        let equippedPlayerSkin = 'default', equippedAISkin = 'default';
        let currentMiniGame = null, miniGameTimer = null, miniGameScore = 0, miniGameTime = 0;
        let memoryCards = [], flippedCards = [], reactionStartTime = 0, reactionRound = 0, reactionTimes = [], waitingForClick = false;
        let pacmanPos = { x: 0, y: 0 }, pacmanDir = { x: 0, y: 0 }, ghosts = [], pacmanDots = [], pacmanLives = 3;
        let snake = [], snakeDir = { x: 1, y: 0 }, snakeFood = null, snakeNextDir = null;
        let flappyBird = { y: 0, velocity: 0 }, flappyPipes = [], flappyScore = 0, flappyGameOver = false;
        let tetrisBoard = [], tetrisPiece = null, tetrisX = 0, tetrisY = 0, tetrisLines = 0, tetrisGameOver = false;
        let breakoutPaddle = 0, breakoutBall = { x: 0, y: 0, dx: 0, dy: 0 }, breakoutBricks = [], breakoutLives = 3;
        let pongPlayer = 0, pongAI = 0, pongBall = { x: 0, y: 0, dx: 0, dy: 0 }, pongScoreP = 0, pongScoreAI = 0;
        let invaderShip = 0, invaders = [], invaderBullets = [], invaderPlayerBullets = [], invaderDir = 1, invaderLives = 3;
        let doodlePlayer = { x: 0, y: 0, vy: 0 }, doodlePlatforms = [], doodleHeight = 0, doodleMaxHeight = 0, doodleWon = false;
        let crossyPlayer = { x: 0, y: 0 }, crossyLanes = [], crossyScore = 0, crossyMaxScore = 0;
        let grid2048 = [], score2048 = 0;
        let whackHoles = [], whackScore = 0, whackTime = 0;
        let astShip = { x: 0, y: 0, angle: 0, vx: 0, vy: 0 }, astRocks = [], astBullets = [], astScore = 0, astLives = 3;
        let runnerPlayer = { lane: 1, y: 0, vy: 0, jumping: false }, runnerObstacles = [], runnerCoins = [], runnerDist = 0, runnerSpeed = 5;
        let fruitItems = [], fruitScore = 0, fruitLives = 3, fruitTime = 0;
        let geoPlayer = { y: 0, vy: 0, jumping: false }, geoObstacles = [], geoDist = 0, geoSpeed = 5, geoGameOver = false;
        let pianoTiles = [], pianoScore = 0, pianoSpeed = 3, pianoGameOver = false;
        let simonSequence = [], simonPlayerIndex = 0, simonRound = 0, simonPlaying = false, simonShowingSequence = false;
        let tttBoard = [], tttPlayerWins = 0, tttAIWins = 0, tttCurrentTurn = 'X', tttGameActive = false;
        let c4Board = [], c4CurrentTurn = 'player', c4GameActive = false, c4PlayerWins = 0, c4AIWins = 0;
        let triviaQuestions = [], triviaIndex = 0, triviaScore = 0, triviaAnswered = false;
        let typingWords = [], typingCurrentWord = '', typingScore = 0, typingTime = 0, typingInput = null;
        let hangmanWord = '', hangmanGuessed = [], hangmanWrong = 0, hangmanWins = 0, hangmanGameActive = false;

        const gameContainer = document.getElementById('game-container');
        const playerEl = document.getElementById('player');
        const ai1 = document.getElementById('ai1'), ai2 = document.getElementById('ai2'), ai3 = document.getElementById('ai3');
        const message = document.getElementById('message'), earnedMoneyEl = document.getElementById('earned-money');
        const minigameContainer = document.getElementById('minigame-container');

        let playerPos = { x: 100, y: 300 };
        let aiPositions = { ai1: { x: 700, y: 100 }, ai2: { x: 700, y: 300 }, ai3: { x: 700, y: 500 } };
        let aiTargets = { ai1: null, ai2: null, ai3: null }, aiSpeeds = { ai1: 3, ai2: 2.5, ai3: 3.5 };

        function createCharacterHTML(isAI, colors, isRobot) {
            const eyeColor = colors?.eyeColor || 'white';
            const pupilStyle = isRobot ? 'background:#ff0000;box-shadow:0 0 5px #ff0000;' : '';
            return `<div class="character-body"><div class="character-face"><div class="eyebrow eyebrow-left"></div><div class="eyebrow eyebrow-right"></div><div class="eye eye-left" style="background:${eyeColor}"><div class="pupil" style="${pupilStyle}"></div></div><div class="eye eye-right" style="background:${eyeColor}"><div class="pupil" style="${pupilStyle}"></div></div><div class="mouth"></div></div></div>`;
        }

        function applyPlayerSkin() {
            let skin = [...PLAYER_SKINS, ...TINY_PLAYER_SKINS, ...CRATE_PLAYER_SKINS].find(s => s.id === equippedPlayerSkin);
            if (!skin) return;
            playerEl.innerHTML = createCharacterHTML(false, skin.colors, false);
            const body = playerEl.querySelector('.character-body');
            body.style.background = skin.colors.isGradient ? skin.colors.body : `radial-gradient(circle at 30% 30%, ${skin.colors.body}, ${skin.colors.bodyGradient})`;
            body.style.border = `3px solid ${skin.colors.border}`;
        }

        function applyAISkins() {
            let skin = [...AI_SKINS, ...TINY_AI_SKINS, ...CRATE_AI_SKINS].find(s => s.id === equippedAISkin);
            if (!skin) return;
            [ai1, ai2, ai3].forEach((ai, i) => {
                const color = skin.colors[`ai${i + 1}`];
                ai.innerHTML = createCharacterHTML(true, { ...skin.colors, isRobot: skin.colors.isRobot }, skin.colors.isRobot);
                const body = ai.querySelector('.character-body');
                body.style.background = `radial-gradient(circle at 30% 30%, ${color}, ${shadeColor(color, -20)})`;
                body.style.border = `2px solid rgba(255,255,255,0.5)`;
            });
        }

        function shadeColor(c, p) {
            if (c?.startsWith('#')) { const n = parseInt(c.slice(1), 16); return `rgb(${Math.max(0, Math.min(255, (n >> 16) + p))},${Math.max(0, Math.min(255, ((n >> 8) & 0xFF) + p))},${Math.max(0, Math.min(255, (n & 0xFF) + p))})`; }
            return c;
        }

        function loadData() {
            const s = localStorage.getItem('findItData');
            if (s) { const d = JSON.parse(s); totalMoney = d.money || 0; tinyWins = d.tinyWins || 0; ownedPlayerSkins = d.ownedPlayerSkins || ['default']; ownedTinyPlayerSkins = d.ownedTinyPlayerSkins || []; ownedCratePlayerSkins = d.ownedCratePlayerSkins || []; ownedAISkins = d.ownedAISkins || ['default']; ownedTinyAISkins = d.ownedTinyAISkins || []; ownedCrateAISkins = d.ownedCrateAISkins || []; equippedPlayerSkin = d.equippedPlayerSkin || 'default'; equippedAISkin = d.equippedAISkin || 'default'; }
            updateDisplays(); applyPlayerSkin(); applyAISkins();
        }

        function saveData() {
            localStorage.setItem('findItData', JSON.stringify({ money: totalMoney, tinyWins, ownedPlayerSkins, ownedTinyPlayerSkins, ownedCratePlayerSkins, ownedAISkins, ownedTinyAISkins, ownedCrateAISkins, equippedPlayerSkin, equippedAISkin }));
        }

        function updateDisplays() {
            document.getElementById('money-display').textContent = `$${totalMoney}`;
            document.getElementById('shop-money').textContent = `$${totalMoney} | Wins: ${tinyWins}`;
            document.getElementById('tiny-wins-display').textContent = `Tiny Wins: ${tinyWins}`;
            document.getElementById('crate-money').textContent = `Your Money: $${totalMoney}`;
        }

        function openShop() { document.getElementById('shop-modal').classList.add('open'); renderShop(); }
        function closeShop() { document.getElementById('shop-modal').classList.remove('open'); }
        function openCrates() { document.getElementById('crate-modal').classList.add('open'); renderCrates(); }
        function closeCrates() { document.getElementById('crate-modal').classList.remove('open'); document.getElementById('crate-container').style.display = 'block'; document.getElementById('crate-opening').style.display = 'none'; document.getElementById('close-crate-btn').style.display = 'block'; }

        function renderShop() {
            updateDisplays();
            renderSkinGrid('player-skin-grid', PLAYER_SKINS, ownedPlayerSkins, equippedPlayerSkin, handlePlayerSkinClick);
            renderTinySkinGrid('player-tiny-skin-grid', TINY_PLAYER_SKINS, ownedTinyPlayerSkins, equippedPlayerSkin, handleTinyPlayerSkinClick);
            renderCrateSkinGrid('player-crate-skin-grid', CRATE_PLAYER_SKINS, ownedCratePlayerSkins, equippedPlayerSkin, handleCratePlayerSkinClick);
            renderSkinGrid('ai-skin-grid', AI_SKINS, ownedAISkins, equippedAISkin, handleAISkinClick, true);
            renderTinySkinGrid('ai-tiny-skin-grid', TINY_AI_SKINS, ownedTinyAISkins, equippedAISkin, handleTinyAISkinClick, true);
            renderCrateSkinGrid('ai-crate-skin-grid', CRATE_AI_SKINS, ownedCrateAISkins, equippedAISkin, handleCrateAISkinClick, true);
        }

        function renderSkinGrid(id, skins, owned, equipped, onClick, isAI = false) {
            const g = document.getElementById(id); g.innerHTML = '';
            skins.forEach(s => {
                const o = owned.includes(s.id), e = equipped === s.id;
                const div = document.createElement('div'); div.className = `skin-item ${o ? 'owned' : ''} ${e ? 'equipped' : ''}`;
                const ps = isAI ? `background:linear-gradient(135deg,${s.colors.ai1} 33%,${s.colors.ai2} 33%,${s.colors.ai2} 66%,${s.colors.ai3} 66%);` : (s.colors.isGradient ? `background:${s.colors.body};` : `background:radial-gradient(circle at 30% 30%,${s.colors.body},${s.colors.bodyGradient});`);
                div.innerHTML = `<div class="skin-preview" style="${ps}border:2px solid ${isAI ? '#fff' : s.colors.border};"></div><div class="skin-name">${s.name}</div><div class="skin-price">${s.price === 0 ? 'Free' : '$' + s.price}</div><div class="skin-status">${e ? '‚úì' : (o ? '‚Ä¢' : '')}</div>`;
                div.onclick = () => onClick(s); g.appendChild(div);
            });
        }

        function renderTinySkinGrid(id, skins, owned, equipped, onClick, isAI = false) {
            const g = document.getElementById(id); g.innerHTML = '';
            skins.forEach(s => {
                const o = owned.includes(s.id), e = equipped === s.id, can = tinyWins >= s.winsRequired;
                const div = document.createElement('div'); div.className = `skin-item tiny-exclusive ${o ? 'owned' : ''} ${e ? 'equipped' : ''} ${!o && !can ? 'locked' : ''}`;
                const ps = isAI ? `background:linear-gradient(135deg,${s.colors.ai1} 33%,${s.colors.ai2} 33%,${s.colors.ai2} 66%,${s.colors.ai3} 66%);` : (s.colors.isGradient ? `background:${s.colors.body};` : `background:radial-gradient(circle at 30% 30%,${s.colors.body},${s.colors.bodyGradient});`);
                div.innerHTML = `<div class="skin-preview" style="${ps}border:2px solid #9b59b6;"></div><div class="skin-name">${s.name}</div><div class="skin-price tiny-unlock">${s.winsRequired}W</div><div class="skin-status">${e ? '‚úì' : (o ? '‚Ä¢' : (can ? '!' : 'üîí'))}</div>`;
                div.onclick = () => onClick(s); g.appendChild(div);
            });
        }

        function renderCrateSkinGrid(id, skins, owned, equipped, onClick, isAI = false) {
            const g = document.getElementById(id); g.innerHTML = '';
            skins.forEach(s => {
                const o = owned.includes(s.id), e = equipped === s.id;
                const div = document.createElement('div'); div.className = `skin-item crate-exclusive ${o ? 'owned' : 'locked'} ${e ? 'equipped' : ''} rarity-${s.rarity}`;
                const ps = isAI ? `background:linear-gradient(135deg,${s.colors.ai1} 33%,${s.colors.ai2} 33%,${s.colors.ai2} 66%,${s.colors.ai3} 66%);` : (s.colors.isGradient ? `background:${s.colors.body};` : `background:radial-gradient(circle at 30% 30%,${s.colors.body},${s.colors.bodyGradient});`);
                div.innerHTML = `<div class="skin-preview" style="${ps}border:2px solid #f39c12;"></div><div class="skin-name">${s.name}</div><div class="skin-price crate-only">${s.rarity}</div><div class="skin-status">${e ? '‚úì' : (o ? '‚Ä¢' : 'üéÅ')}</div>`;
                div.onclick = () => onClick(s); g.appendChild(div);
            });
        }

        function handlePlayerSkinClick(s) { if (ownedPlayerSkins.includes(s.id)) { equippedPlayerSkin = s.id; } else if (totalMoney >= s.price) { totalMoney -= s.price; ownedPlayerSkins.push(s.id); equippedPlayerSkin = s.id; } applyPlayerSkin(); saveData(); renderShop(); }
        function handleTinyPlayerSkinClick(s) { if (ownedTinyPlayerSkins.includes(s.id)) { equippedPlayerSkin = s.id; } else if (tinyWins >= s.winsRequired) { ownedTinyPlayerSkins.push(s.id); equippedPlayerSkin = s.id; } applyPlayerSkin(); saveData(); renderShop(); }
        function handleCratePlayerSkinClick(s) { if (ownedCratePlayerSkins.includes(s.id)) { equippedPlayerSkin = s.id; applyPlayerSkin(); saveData(); renderShop(); } }
        function handleAISkinClick(s) { if (ownedAISkins.includes(s.id)) { equippedAISkin = s.id; } else if (totalMoney >= s.price) { totalMoney -= s.price; ownedAISkins.push(s.id); equippedAISkin = s.id; } applyAISkins(); saveData(); renderShop(); }
        function handleTinyAISkinClick(s) { if (ownedTinyAISkins.includes(s.id)) { equippedAISkin = s.id; } else if (tinyWins >= s.winsRequired) { ownedTinyAISkins.push(s.id); equippedAISkin = s.id; } applyAISkins(); saveData(); renderShop(); }
        function handleCrateAISkinClick(s) { if (ownedCrateAISkins.includes(s.id)) { equippedAISkin = s.id; applyAISkins(); saveData(); renderShop(); } }

        document.querySelectorAll('.tab-btn').forEach(b => { b.onclick = () => { document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active')); document.querySelectorAll('.shop-tab').forEach(x => x.classList.remove('active')); b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active'); }; });

        function renderCrates() {
            updateDisplays();
            const g = document.getElementById('crate-grid'); g.innerHTML = '';
            CRATES.forEach(c => {
                const div = document.createElement('div'); div.className = 'crate-item';
                div.innerHTML = `<div class="crate-icon">${c.icon}</div><div class="crate-name">${c.name}</div><div class="crate-price">$${c.price}</div><div class="crate-contents">${c.contents}</div>`;
                div.onclick = () => openCrate(c); g.appendChild(div);
            });
        }

        function openCrate(crate) {
            if (totalMoney < crate.price) return;
            totalMoney -= crate.price; saveData(); updateDisplays();
            document.getElementById('crate-container').style.display = 'none';
            document.getElementById('crate-opening').style.display = 'block';
            document.getElementById('close-crate-btn').style.display = 'none';
            const anim = document.getElementById('crate-animation'); anim.textContent = crate.icon; anim.classList.add('shaking');
            setTimeout(() => {
                anim.classList.remove('shaking');
                const skin = getRandomSkin(crate);
                const isPlayer = Math.random() < 0.5;
                const skinList = isPlayer ? CRATE_PLAYER_SKINS : CRATE_AI_SKINS;
                const availableSkins = skinList.filter(s => s.rarity === skin.rarity);
                const chosenSkin = availableSkins[Math.floor(Math.random() * availableSkins.length)];
                const owned = isPlayer ? ownedCratePlayerSkins : ownedCrateAISkins;
                const isDupe = owned.includes(chosenSkin.id);
                if (!isDupe) { if (isPlayer) ownedCratePlayerSkins.push(chosenSkin.id); else ownedCrateAISkins.push(chosenSkin.id); }
                const refund = isDupe ? Math.floor(crate.price * 0.3) : 0;
                if (isDupe) totalMoney += refund;
                saveData(); updateDisplays();
                const ps = isPlayer ? (chosenSkin.colors.isGradient ? chosenSkin.colors.body : `radial-gradient(circle at 30% 30%,${chosenSkin.colors.body},${chosenSkin.colors.bodyGradient})`) : `linear-gradient(135deg,${chosenSkin.colors.ai1} 33%,${chosenSkin.colors.ai2} 33%,${chosenSkin.colors.ai2} 66%,${chosenSkin.colors.ai3} 66%)`;
                document.getElementById('crate-result').innerHTML = `<div style="color:${getRarityColor(chosenSkin.rarity)};font-size:16px;margin-bottom:10px;">${chosenSkin.rarity.toUpperCase()}</div><div class="crate-skin-reveal rarity-${chosenSkin.rarity}" style="background:${ps};"></div><div style="margin-top:10px;font-size:20px;">${chosenSkin.name}</div><div style="font-size:12px;color:#aaa;">${isPlayer ? 'Player Skin' : 'AI Skin'}</div>${isDupe ? `<div style="color:#f39c12;margin-top:5px;">Duplicate! +$${refund}</div>` : '<div style="color:#2ecc71;margin-top:5px;">NEW!</div>'}`;
            }, 1500);
        }

        function getRandomSkin(crate) {
            const r = Math.random() * 100;
            if (r < crate.weights.legendary) return { rarity: 'legendary' };
            if (r < crate.weights.legendary + crate.weights.epic) return { rarity: 'epic' };
            if (r < crate.weights.legendary + crate.weights.epic + crate.weights.rare) return { rarity: 'rare' };
            return { rarity: 'common' };
        }

        function getRarityColor(r) { return { common: '#aaa', rare: '#3498db', epic: '#9b59b6', legendary: '#f39c12' }[r]; }
        function closeCrateResult() { document.getElementById('crate-container').style.display = 'block'; document.getElementById('crate-opening').style.display = 'none'; document.getElementById('close-crate-btn').style.display = 'block'; renderCrates(); }

        function openLottery() { document.getElementById('lottery-modal').classList.add('open'); document.getElementById('lottery-money').textContent = `Your Money: $${totalMoney}`; document.getElementById('die1').textContent = '?'; document.getElementById('die2').textContent = '?'; document.getElementById('dice-total').textContent = 'Total: ?'; document.getElementById('lottery-result').innerHTML = ''; document.getElementById('roll-btn').disabled = false; }
        function closeLottery() { document.getElementById('lottery-modal').classList.remove('open'); }
        function rollLottery() {
            if (totalMoney < 25) { document.getElementById('lottery-result').innerHTML = '<span style="color:#e74c3c;">Not enough money! Need $25</span>'; return; }
            totalMoney -= 25; saveData(); document.getElementById('lottery-money').textContent = `Your Money: $${totalMoney}`; updateDisplays();
            document.getElementById('roll-btn').disabled = true;
            const die1El = document.getElementById('die1'), die2El = document.getElementById('die2');
            die1El.classList.add('rolling'); die2El.classList.add('rolling'); die1El.textContent = '?'; die2El.textContent = '?';
            document.getElementById('dice-total').textContent = 'Rolling...'; document.getElementById('lottery-result').innerHTML = '';
            let rollCount = 0;
            const rollInterval = setInterval(() => { die1El.textContent = 5 + Math.floor(Math.random() * 6); die2El.textContent = 5 + Math.floor(Math.random() * 6); rollCount++; }, 80);
            setTimeout(() => {
                clearInterval(rollInterval); die1El.classList.remove('rolling'); die2El.classList.remove('rolling');
                const d1 = 5 + Math.floor(Math.random() * 6), d2 = 5 + Math.floor(Math.random() * 6), total = d1 + d2;
                die1El.textContent = d1; die2El.textContent = d2; document.getElementById('dice-total').textContent = `Total: ${total}`;
                let prize = '';
                if (total <= 11) { totalMoney += 20; prize = '<span style="color:#2ecc71;">+$20!</span>'; }
                else if (total <= 13) { totalMoney += 40; prize = '<span style="color:#2ecc71;">+$40!</span>'; }
                else if (total <= 15) { totalMoney += 60; prize = '<span style="color:#2ecc71;">+$60!</span>'; }
                else if (total <= 17) { const skin = giveRandomSkin('common'); prize = `<span style="color:#9b59b6;">Free Skin: ${skin}!</span>`; }
                else if (total <= 19) { const skin = giveRandomSkin('rare'); prize = `<span style="color:#3498db;">Rare Skin: ${skin}!</span>`; }
                else { const skin = giveRandomSkin('legendary'); totalMoney += 200; prize = `<span style="color:#ffd700;">JACKPOT! +$200 + ${skin}!</span>`; }
                saveData(); updateDisplays(); document.getElementById('lottery-money').textContent = `Your Money: $${totalMoney}`;
                document.getElementById('lottery-result').innerHTML = prize; document.getElementById('roll-btn').disabled = false;
            }, 1500);
        }
        function giveRandomSkin(minRarity) {
            const rarities = ['common', 'rare', 'epic', 'legendary'];
            const startIdx = rarities.indexOf(minRarity);
            const possibleRarities = rarities.slice(startIdx);
            const rarity = possibleRarities[Math.floor(Math.random() * possibleRarities.length)];
            const isPlayer = Math.random() < 0.5;
            const skinList = isPlayer ? CRATE_PLAYER_SKINS.filter(s => s.rarity === rarity) : CRATE_AI_SKINS.filter(s => s.rarity === rarity);
            if (skinList.length === 0) { totalMoney += 50; return 'Bonus $50'; }
            const skin = skinList[Math.floor(Math.random() * skinList.length)];
            const owned = isPlayer ? ownedCratePlayerSkins : ownedCrateAISkins;
            if (owned.includes(skin.id)) { totalMoney += 30; return `${skin.name} (Dupe +$30)`; }
            if (isPlayer) ownedCratePlayerSkins.push(skin.id); else ownedCrateAISkins.push(skin.id);
            return skin.name;
        }
        function openTinyGames() { document.getElementById('tiny-games-modal').classList.add('open'); document.getElementById('tiny-games-menu').style.display = 'block'; document.getElementById('minigame-area').style.display = 'none'; document.getElementById('close-tiny-btn').style.display = 'block'; updateDisplays(); }
        function closeTinyGames() { document.getElementById('tiny-games-modal').classList.remove('open'); stopMiniGame(); }
        function backToTinyMenu() { stopMiniGame(); document.getElementById('tiny-games-menu').style.display = 'block'; document.getElementById('minigame-area').style.display = 'none'; document.getElementById('close-tiny-btn').style.display = 'block'; }

        function startMiniGame(type) {
            currentMiniGame = type;
            document.getElementById('tiny-games-menu').style.display = 'none';
            document.getElementById('minigame-area').style.display = 'block';
            document.getElementById('close-tiny-btn').style.display = 'none';
            document.getElementById('play-again-btn').style.display = 'none';
            document.getElementById('minigame-message').style.display = 'none';
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="reaction-target"></div><div id="reaction-instruction"></div>';
            if (type === 'clicker') startClickerGame();
            else if (type === 'memory') startMemoryGame();
            else if (type === 'reaction') startReactionGame();
            else if (type === 'pacman') startPacmanGame();
            else if (type === 'snake') startSnakeGame();
            else if (type === 'flappy') startFlappyGame();
            else if (type === 'tetris') startTetrisGame();
            else if (type === 'breakout') startBreakoutGame();
            else if (type === 'pong') startPongGame();
            else if (type === 'invaders') startInvadersGame();
            else if (type === 'doodle') startDoodleGame();
            else if (type === 'crossy') startCrossyGame();
            else if (type === 'game2048') start2048Game();
            else if (type === 'whack') startWhackGame();
            else if (type === 'asteroids') startAsteroidsGame();
            else if (type === 'runner') startRunnerGame();
            else if (type === 'fruit') startFruitGame();
            else if (type === 'geometry') startGeometryGame();
            else if (type === 'piano') startPianoGame();
            else if (type === 'simon') startSimonGame();
            else if (type === 'tictactoe') startTTTGame();
            else if (type === 'connect4') startC4Game();
            else if (type === 'trivia') startTriviaGame();
            else if (type === 'typing') startTypingGame();
            else if (type === 'hangman') startHangmanGame();
        }

        function stopMiniGame() { if (miniGameTimer) { clearInterval(miniGameTimer); clearTimeout(miniGameTimer); } miniGameTimer = null; currentMiniGame = null; document.removeEventListener('keydown', pacmanKeyHandler); document.removeEventListener('keydown', snakeKeyHandler); document.removeEventListener('keydown', flappyKeyHandler); document.removeEventListener('keydown', tetrisKeyHandler); document.removeEventListener('keydown', breakoutKeyHandler); document.removeEventListener('keydown', pongKeyHandler); document.removeEventListener('keydown', invadersKeyHandler); document.removeEventListener('keydown', doodleKeyHandler); document.removeEventListener('keydown', crossyKeyHandler); document.removeEventListener('keydown', game2048KeyHandler); document.removeEventListener('keydown', asteroidsKeyHandler); document.removeEventListener('keyup', asteroidsKeyHandler); document.removeEventListener('keydown', runnerKeyHandler); document.removeEventListener('keydown', geometryKeyHandler); minigameContainer.removeEventListener('click', flappyClick); minigameContainer.removeEventListener('click', geometryClick); }
        function restartMiniGame() { startMiniGame(currentMiniGame); }

        function startClickerGame() {
            miniGameScore = 0; miniGameTime = 15; updateMiniGameDisplay(); spawnClickerDot();
            miniGameTimer = setInterval(() => { miniGameTime--; updateMiniGameDisplay(); if (miniGameTime <= 0) endClickerGame(); }, 1000);
        }
        function spawnClickerDot() {
            const e = minigameContainer.querySelector('.minigame-dot'); if (e) e.remove();
            const d = document.createElement('div'); d.className = 'minigame-dot';
            const sz = 25 + Math.random() * 25; d.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random() * (360 - sz)}px;top:${Math.random() * (300 - sz)}px;background:hsl(${Math.random() * 360},70%,50%);cursor:pointer;`;
            d.onclick = () => { miniGameScore++; updateMiniGameDisplay(); spawnClickerDot(); };
            minigameContainer.appendChild(d);
        }
        function endClickerGame() { stopMiniGame(); const w = miniGameScore >= 15; if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Score: ${miniGameScore}`, w ? '+1 Win!' : 'Need 15+'); }

        function startMemoryGame() {
            miniGameScore = 0; miniGameTime = 45; memoryCards = []; flippedCards = [];
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const pairs = [...colors, ...colors]; pairs.sort(() => Math.random() - 0.5);
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            pairs.forEach((c, i) => {
                const card = document.createElement('div'); card.className = 'memory-card hidden'; card.dataset.color = c; card.dataset.index = i;
                card.style.cssText = `left:${(i % 4) * 85 + 20}px;top:${Math.floor(i / 4) * 85 + 20}px;`; card.textContent = '?';
                card.onclick = () => flipCard(card); minigameContainer.appendChild(card); memoryCards.push(card);
            });
            updateMiniGameDisplay();
            miniGameTimer = setInterval(() => { miniGameTime--; updateMiniGameDisplay(); if (miniGameTime <= 0) endMemoryGame(false); }, 1000);
        }
        function flipCard(c) {
            if (flippedCards.length >= 2 || c.classList.contains('revealed') || c.classList.contains('matched')) return;
            c.classList.remove('hidden'); c.classList.add('revealed'); c.style.background = c.dataset.color; c.textContent = ''; flippedCards.push(c);
            if (flippedCards.length === 2) {
                setTimeout(() => {
                    if (flippedCards[0].dataset.color === flippedCards[1].dataset.color) { flippedCards[0].classList.add('matched'); flippedCards[1].classList.add('matched'); miniGameScore++; if (miniGameScore === 6) endMemoryGame(true); }
                    else { flippedCards.forEach(x => { x.classList.remove('revealed'); x.classList.add('hidden'); x.style.background = '#9b59b6'; x.textContent = '?'; }); }
                    flippedCards = [];
                }, 600);
            }
        }
        function endMemoryGame(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Pairs: ${miniGameScore}/6`, w ? '+1 Win!' : 'Match all!'); }

        function startReactionGame() { reactionRound = 0; reactionTimes = []; document.getElementById('minigame-timer').textContent = 'Round: 0/5'; document.getElementById('minigame-score').textContent = 'Avg: --'; nextReactionRound(); }
        function nextReactionRound() {
            if (reactionRound >= 5) return endReactionGame();
            const inst = document.getElementById('reaction-instruction'), tgt = document.getElementById('reaction-target');
            inst.textContent = 'Wait...'; inst.style.color = '#e74c3c'; tgt.style.display = 'none'; waitingForClick = false;
            miniGameTimer = setTimeout(() => { tgt.style.display = 'block'; tgt.style.background = '#2ecc71'; inst.textContent = 'CLICK!'; inst.style.color = '#2ecc71'; reactionStartTime = Date.now(); waitingForClick = true; }, 1500 + Math.random() * 2500);
        }
        document.getElementById('reaction-target').onclick = function() {
            if (!waitingForClick) return; waitingForClick = false;
            const t = Date.now() - reactionStartTime; reactionTimes.push(t); reactionRound++;
            document.getElementById('minigame-timer').textContent = `Round: ${reactionRound}/5`;
            document.getElementById('minigame-score').textContent = `Avg: ${Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length)}ms`;
            this.style.display = 'none'; document.getElementById('reaction-instruction').textContent = `${t}ms`;
            setTimeout(nextReactionRound, 800);
        };
        function endReactionGame() { stopMiniGame(); const avg = Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length); const w = avg < 400; if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Avg: ${avg}ms`, w ? '+1 Win!' : 'Need <400ms'); }

        let pacmanKeyHandler;
        function startPacmanGame() {
            miniGameScore = 0; pacmanLives = 3; miniGameTime = 30;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            pacmanPos = { x: 190, y: 160 }; pacmanDir = { x: 0, y: 0 }; pacmanDots = []; ghosts = [];
            for (let i = 0; i < 30; i++) { pacmanDots.push({ x: 20 + Math.random() * 340, y: 20 + Math.random() * 280, el: null }); }
            pacmanDots.forEach(d => { const el = document.createElement('div'); el.className = 'pacman-dot'; el.style.cssText = `left:${d.x}px;top:${d.y}px;`; minigameContainer.appendChild(el); d.el = el; });
            for (let i = 0; i < 3; i++) { const g = { x: 50 + i * 150, y: 50 + i * 80, dx: (Math.random() - 0.5) * 3, dy: (Math.random() - 0.5) * 3, el: null }; const el = document.createElement('div'); el.className = 'ghost'; el.style.cssText = `left:${g.x}px;top:${g.y}px;background:${['#e74c3c', '#00bcd4', '#ff69b4'][i]};`; minigameContainer.appendChild(el); g.el = el; ghosts.push(g); }
            const pac = document.createElement('div'); pac.className = 'pacman'; pac.id = 'pacman-player'; pac.style.cssText = `left:${pacmanPos.x}px;top:${pacmanPos.y}px;`; minigameContainer.appendChild(pac);
            updateMiniGameDisplay(); document.getElementById('minigame-score').textContent = `Dots: 0/30 ‚ù§Ô∏è${pacmanLives}`;
            pacmanKeyHandler = (e) => { if (e.key === 'ArrowUp') pacmanDir = { x: 0, y: -3 }; if (e.key === 'ArrowDown') pacmanDir = { x: 0, y: 3 }; if (e.key === 'ArrowLeft') pacmanDir = { x: -3, y: 0 }; if (e.key === 'ArrowRight') pacmanDir = { x: 3, y: 0 }; e.preventDefault(); };
            document.addEventListener('keydown', pacmanKeyHandler);
            miniGameTimer = setInterval(pacmanLoop, 33);
        }
        function pacmanLoop() {
            pacmanPos.x = Math.max(0, Math.min(356, pacmanPos.x + pacmanDir.x));
            pacmanPos.y = Math.max(0, Math.min(296, pacmanPos.y + pacmanDir.y));
            const pac = document.getElementById('pacman-player'); if (pac) pac.style.cssText = `left:${pacmanPos.x}px;top:${pacmanPos.y}px;`;
            for (let i = pacmanDots.length - 1; i >= 0; i--) {
                const d = pacmanDots[i];
                if (Math.abs(pacmanPos.x - d.x) < 15 && Math.abs(pacmanPos.y - d.y) < 15) { if (d.el) d.el.remove(); pacmanDots.splice(i, 1); miniGameScore++; }
            }
            ghosts.forEach(g => {
                g.x += g.dx; g.y += g.dy;
                if (g.x < 0 || g.x > 358) g.dx *= -1; if (g.y < 0 || g.y > 298) g.dy *= -1;
                g.x = Math.max(0, Math.min(358, g.x)); g.y = Math.max(0, Math.min(298, g.y));
                if (g.el) g.el.style.cssText = `left:${g.x}px;top:${g.y}px;background:${g.el.style.background};`;
                if (Math.abs(pacmanPos.x - g.x) < 20 && Math.abs(pacmanPos.y - g.y) < 20) { pacmanLives--; pacmanPos = { x: 190, y: 160 }; pacmanDir = { x: 0, y: 0 }; }
            });
            document.getElementById('minigame-score').textContent = `Dots: ${miniGameScore}/30 ‚ù§Ô∏è${pacmanLives}`;
            if (pacmanDots.length === 0) endPacmanGame(true);
            if (pacmanLives <= 0) endPacmanGame(false);
        }
        function endPacmanGame(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Dots: ${miniGameScore}/30`, w ? '+1 Win!' : 'Caught by ghosts!'); }

        let snakeKeyHandler;
        function startSnakeGame() {
            miniGameScore = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            snake = [{ x: 8, y: 8 }, { x: 7, y: 8 }, { x: 6, y: 8 }];
            snakeDir = { x: 1, y: 0 }; snakeNextDir = { x: 1, y: 0 };
            spawnSnakeFood();
            renderSnake();
            document.getElementById('minigame-timer').textContent = 'Snake';
            document.getElementById('minigame-score').textContent = `Food: 0/20`;
            snakeKeyHandler = (e) => {
                if (e.key === 'ArrowUp' && snakeDir.y !== 1) snakeNextDir = { x: 0, y: -1 };
                if (e.key === 'ArrowDown' && snakeDir.y !== -1) snakeNextDir = { x: 0, y: 1 };
                if (e.key === 'ArrowLeft' && snakeDir.x !== 1) snakeNextDir = { x: -1, y: 0 };
                if (e.key === 'ArrowRight' && snakeDir.x !== -1) snakeNextDir = { x: 1, y: 0 };
                e.preventDefault();
            };
            document.addEventListener('keydown', snakeKeyHandler);
            miniGameTimer = setInterval(snakeLoop, 120);
        }
        function spawnSnakeFood() {
            let valid = false, fx, fy;
            while (!valid) {
                fx = Math.floor(Math.random() * 19); fy = Math.floor(Math.random() * 16);
                valid = !snake.some(s => s.x === fx && s.y === fy);
            }
            snakeFood = { x: fx, y: fy };
        }
        function renderSnake() {
            minigameContainer.querySelectorAll('.snake-segment, .snake-food').forEach(el => el.remove());
            snake.forEach((s, i) => {
                const el = document.createElement('div'); el.className = 'snake-segment';
                el.style.cssText = `position:absolute;width:18px;height:18px;background:${i === 0 ? '#2ecc71' : '#27ae60'};border-radius:${i === 0 ? '50%' : '3px'};left:${s.x * 20}px;top:${s.y * 20}px;`;
                minigameContainer.appendChild(el);
            });
            if (snakeFood) {
                const el = document.createElement('div'); el.className = 'snake-food';
                el.style.cssText = `position:absolute;width:16px;height:16px;background:#e74c3c;border-radius:50%;left:${snakeFood.x * 20 + 2}px;top:${snakeFood.y * 20 + 2}px;`;
                minigameContainer.appendChild(el);
            }
        }
        function snakeLoop() {
            snakeDir = snakeNextDir;
            const head = { x: snake[0].x + snakeDir.x, y: snake[0].y + snakeDir.y };
            if (head.x < 0 || head.x >= 19 || head.y < 0 || head.y >= 16) return endSnakeGame(false);
            if (snake.some(s => s.x === head.x && s.y === head.y)) return endSnakeGame(false);
            snake.unshift(head);
            if (head.x === snakeFood.x && head.y === snakeFood.y) {
                miniGameScore++; document.getElementById('minigame-score').textContent = `Food: ${miniGameScore}/20`;
                if (miniGameScore >= 20) return endSnakeGame(true);
                spawnSnakeFood();
            } else { snake.pop(); }
            renderSnake();
        }
        function endSnakeGame(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Food: ${miniGameScore}/20`, w ? '+1 Win!' : 'Crashed!'); }

        let flappyKeyHandler, flappyClick;
        function startFlappyGame() {
            flappyBird = { y: 140, velocity: 0 }; flappyPipes = []; flappyScore = 0; flappyGameOver = false;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            document.getElementById('minigame-timer').textContent = 'Flappy Bird';
            document.getElementById('minigame-score').textContent = 'Pipes: 0/15';
            const bird = document.createElement('div'); bird.id = 'flappy-bird';
            bird.style.cssText = 'position:absolute;width:28px;height:22px;background:#ffd700;border-radius:50%;left:60px;top:140px;border:2px solid #f39c12;';
            minigameContainer.appendChild(bird);
            const beak = document.createElement('div');
            beak.style.cssText = 'position:absolute;width:10px;height:8px;background:#e67e22;right:-6px;top:7px;border-radius:0 4px 4px 0;';
            bird.appendChild(beak);
            const eye = document.createElement('div');
            eye.style.cssText = 'position:absolute;width:6px;height:6px;background:#000;border-radius:50%;right:6px;top:4px;';
            bird.appendChild(eye);
            flappyClick = () => { if (!flappyGameOver) flappyBird.velocity = -6; };
            flappyKeyHandler = (e) => { if (e.code === 'Space' && !flappyGameOver) { flappyBird.velocity = -6; e.preventDefault(); } };
            document.addEventListener('keydown', flappyKeyHandler);
            minigameContainer.addEventListener('click', flappyClick);
            spawnFlappyPipe();
            miniGameTimer = setInterval(flappyLoop, 30);
        }
        function spawnFlappyPipe() {
            const gapY = 60 + Math.random() * 140;
            const gapHeight = 90;
            const pipeTop = document.createElement('div'); pipeTop.className = 'flappy-pipe';
            pipeTop.style.cssText = `position:absolute;width:45px;background:linear-gradient(90deg,#2ecc71,#27ae60);right:-45px;top:0;height:${gapY}px;border:2px solid #1e8449;border-radius:0 0 5px 5px;`;
            const pipeBottom = document.createElement('div'); pipeBottom.className = 'flappy-pipe';
            pipeBottom.style.cssText = `position:absolute;width:45px;background:linear-gradient(90deg,#2ecc71,#27ae60);right:-45px;top:${gapY + gapHeight}px;height:${320 - gapY - gapHeight}px;border:2px solid #1e8449;border-radius:5px 5px 0 0;`;
            minigameContainer.appendChild(pipeTop); minigameContainer.appendChild(pipeBottom);
            flappyPipes.push({ top: pipeTop, bottom: pipeBottom, x: 380, gapY, gapHeight, scored: false });
        }
        function flappyLoop() {
            if (flappyGameOver) return;
            flappyBird.velocity += 0.35; flappyBird.y += flappyBird.velocity;
            const bird = document.getElementById('flappy-bird');
            if (bird) { bird.style.top = flappyBird.y + 'px'; bird.style.transform = `rotate(${Math.min(flappyBird.velocity * 3, 45)}deg)`; }
            if (flappyBird.y < -10 || flappyBird.y > 290) { endFlappyGame(false); return; }
            flappyPipes.forEach(pipe => {
                pipe.x -= 3;
                pipe.top.style.right = (380 - pipe.x) + 'px'; pipe.bottom.style.right = (380 - pipe.x) + 'px';
                if (pipe.x < 90 && pipe.x > 30) {
                    if (flappyBird.y < pipe.gapY || flappyBird.y + 22 > pipe.gapY + pipe.gapHeight) { endFlappyGame(false); return; }
                }
                if (pipe.x < 55 && !pipe.scored) { pipe.scored = true; flappyScore++; document.getElementById('minigame-score').textContent = `Pipes: ${flappyScore}/15`; if (flappyScore >= 15) endFlappyGame(true); }
            });
            flappyPipes = flappyPipes.filter(pipe => { if (pipe.x < -50) { pipe.top.remove(); pipe.bottom.remove(); return false; } return true; });
            if (flappyPipes.length === 0 || flappyPipes[flappyPipes.length - 1].x < 200) spawnFlappyPipe();
        }
        function endFlappyGame(w) { flappyGameOver = true; stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Pipes: ${flappyScore}/15`, w ? '+1 Win!' : 'Crashed!'); }

        const TETRIS_PIECES = [
            { shape: [[1,1,1,1]], color: '#00bcd4' },
            { shape: [[1,1],[1,1]], color: '#ffd700' },
            { shape: [[0,1,0],[1,1,1]], color: '#9b59b6' },
            { shape: [[1,0],[1,0],[1,1]], color: '#e67e22' },
            { shape: [[0,1],[0,1],[1,1]], color: '#3498db' },
            { shape: [[1,1,0],[0,1,1]], color: '#2ecc71' },
            { shape: [[0,1,1],[1,1,0]], color: '#e74c3c' }
        ];
        let tetrisKeyHandler;
        function startTetrisGame() {
            tetrisBoard = Array(16).fill(null).map(() => Array(10).fill(null));
            tetrisLines = 0; tetrisGameOver = false;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="tetris-board" style="position:absolute;left:115px;top:0;width:150px;height:320px;background:#111;border:2px solid #ffd700;"></div>';
            document.getElementById('minigame-timer').textContent = 'Tetris';
            document.getElementById('minigame-score').textContent = 'Lines: 0/10';
            spawnTetrisPiece();
            renderTetris();
            tetrisKeyHandler = (e) => {
                if (tetrisGameOver) return;
                if (e.key === 'ArrowLeft') { if (canMove(tetrisX - 1, tetrisY, tetrisPiece.shape)) tetrisX--; }
                if (e.key === 'ArrowRight') { if (canMove(tetrisX + 1, tetrisY, tetrisPiece.shape)) tetrisX++; }
                if (e.key === 'ArrowDown') { if (canMove(tetrisX, tetrisY + 1, tetrisPiece.shape)) tetrisY++; }
                if (e.key === 'ArrowUp') { const rotated = rotatePiece(tetrisPiece.shape); if (canMove(tetrisX, tetrisY, rotated)) tetrisPiece.shape = rotated; }
                renderTetris(); e.preventDefault();
            };
            document.addEventListener('keydown', tetrisKeyHandler);
            miniGameTimer = setInterval(tetrisLoop, 400);
        }
        function spawnTetrisPiece() {
            const p = TETRIS_PIECES[Math.floor(Math.random() * TETRIS_PIECES.length)];
            tetrisPiece = { shape: p.shape.map(r => [...r]), color: p.color };
            tetrisX = 3; tetrisY = 0;
            if (!canMove(tetrisX, tetrisY, tetrisPiece.shape)) { tetrisGameOver = true; endTetrisGame(false); }
        }
        function rotatePiece(shape) {
            const rows = shape.length, cols = shape[0].length;
            const rotated = Array(cols).fill(null).map(() => Array(rows).fill(0));
            for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) rotated[c][rows - 1 - r] = shape[r][c];
            return rotated;
        }
        function canMove(nx, ny, shape) {
            for (let r = 0; r < shape.length; r++) {
                for (let c = 0; c < shape[r].length; c++) {
                    if (shape[r][c]) {
                        const bx = nx + c, by = ny + r;
                        if (bx < 0 || bx >= 10 || by >= 16) return false;
                        if (by >= 0 && tetrisBoard[by][bx]) return false;
                    }
                }
            }
            return true;
        }
        function lockPiece() {
            for (let r = 0; r < tetrisPiece.shape.length; r++) {
                for (let c = 0; c < tetrisPiece.shape[r].length; c++) {
                    if (tetrisPiece.shape[r][c]) {
                        const by = tetrisY + r, bx = tetrisX + c;
                        if (by >= 0) tetrisBoard[by][bx] = tetrisPiece.color;
                    }
                }
            }
            clearLines();
            spawnTetrisPiece();
        }
        function clearLines() {
            for (let r = tetrisBoard.length - 1; r >= 0; r--) {
                if (tetrisBoard[r].every(c => c)) {
                    tetrisBoard.splice(r, 1);
                    tetrisBoard.unshift(Array(10).fill(null));
                    tetrisLines++; r++;
                    document.getElementById('minigame-score').textContent = `Lines: ${tetrisLines}/10`;
                    if (tetrisLines >= 10) { tetrisGameOver = true; endTetrisGame(true); }
                }
            }
        }
        function renderTetris() {
            const board = document.getElementById('tetris-board'); if (!board) return;
            board.innerHTML = '';
            for (let r = 0; r < 16; r++) {
                for (let c = 0; c < 10; c++) {
                    if (tetrisBoard[r][c]) {
                        const cell = document.createElement('div');
                        cell.style.cssText = `position:absolute;width:13px;height:18px;background:${tetrisBoard[r][c]};border:1px solid rgba(255,255,255,0.3);left:${c * 15}px;top:${r * 20}px;`;
                        board.appendChild(cell);
                    }
                }
            }
            if (tetrisPiece && !tetrisGameOver) {
                for (let r = 0; r < tetrisPiece.shape.length; r++) {
                    for (let c = 0; c < tetrisPiece.shape[r].length; c++) {
                        if (tetrisPiece.shape[r][c]) {
                            const cell = document.createElement('div');
                            cell.style.cssText = `position:absolute;width:13px;height:18px;background:${tetrisPiece.color};border:1px solid rgba(255,255,255,0.5);left:${(tetrisX + c) * 15}px;top:${(tetrisY + r) * 20}px;`;
                            board.appendChild(cell);
                        }
                    }
                }
            }
        }
        function tetrisLoop() {
            if (tetrisGameOver) return;
            if (canMove(tetrisX, tetrisY + 1, tetrisPiece.shape)) { tetrisY++; }
            else { lockPiece(); }
            renderTetris();
        }
        function endTetrisGame(w) { tetrisGameOver = true; stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Lines: ${tetrisLines}/10`, w ? '+1 Win!' : 'Game Over!'); }

        let breakoutKeyHandler, breakoutKeys = { left: false, right: false };
        function startBreakoutGame() {
            breakoutPaddle = 155; breakoutBall = { x: 190, y: 250, dx: 3, dy: -3 }; breakoutBricks = []; breakoutLives = 3;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            document.getElementById('minigame-timer').textContent = 'Breakout';
            const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db'];
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 8; col++) {
                    breakoutBricks.push({ x: 15 + col * 45, y: 15 + row * 18, w: 42, h: 15, color: colors[row], alive: true });
                }
            }
            updateBreakoutScore();
            renderBreakout();
            breakoutKeyHandler = (e) => {
                if (e.key === 'ArrowLeft') breakoutKeys.left = e.type === 'keydown';
                if (e.key === 'ArrowRight') breakoutKeys.right = e.type === 'keydown';
                e.preventDefault();
            };
            document.addEventListener('keydown', breakoutKeyHandler);
            document.addEventListener('keyup', breakoutKeyHandler);
            miniGameTimer = setInterval(breakoutLoop, 20);
        }
        function updateBreakoutScore() {
            const remaining = breakoutBricks.filter(b => b.alive).length;
            document.getElementById('minigame-score').textContent = `Bricks: ${40 - remaining}/40 ‚ù§Ô∏è${breakoutLives}`;
        }
        function renderBreakout() {
            const els = minigameContainer.querySelectorAll('.bo-brick,.bo-paddle,.bo-ball');
            els.forEach(e => e.remove());
            breakoutBricks.forEach(b => {
                if (!b.alive) return;
                const el = document.createElement('div'); el.className = 'bo-brick';
                el.style.cssText = `position:absolute;left:${b.x}px;top:${b.y}px;width:${b.w}px;height:${b.h}px;background:${b.color};border-radius:3px;`;
                minigameContainer.appendChild(el);
            });
            const paddle = document.createElement('div'); paddle.className = 'bo-paddle';
            paddle.style.cssText = `position:absolute;left:${breakoutPaddle}px;top:295px;width:70px;height:12px;background:linear-gradient(180deg,#fff,#bbb);border-radius:5px;`;
            minigameContainer.appendChild(paddle);
            const ball = document.createElement('div'); ball.className = 'bo-ball';
            ball.style.cssText = `position:absolute;left:${breakoutBall.x}px;top:${breakoutBall.y}px;width:12px;height:12px;background:radial-gradient(circle at 30% 30%,#fff,#ffd700);border-radius:50%;`;
            minigameContainer.appendChild(ball);
        }
        function breakoutLoop() {
            if (breakoutKeys.left) breakoutPaddle = Math.max(0, breakoutPaddle - 6);
            if (breakoutKeys.right) breakoutPaddle = Math.min(310, breakoutPaddle + 6);
            breakoutBall.x += breakoutBall.dx; breakoutBall.y += breakoutBall.dy;
            if (breakoutBall.x <= 0 || breakoutBall.x >= 368) breakoutBall.dx *= -1;
            if (breakoutBall.y <= 0) breakoutBall.dy *= -1;
            if (breakoutBall.y >= 290 && breakoutBall.y <= 300 && breakoutBall.x >= breakoutPaddle - 5 && breakoutBall.x <= breakoutPaddle + 75) {
                breakoutBall.dy = -Math.abs(breakoutBall.dy);
                const hitPos = (breakoutBall.x - breakoutPaddle) / 70;
                breakoutBall.dx = (hitPos - 0.5) * 6;
            }
            if (breakoutBall.y > 320) {
                breakoutLives--;
                if (breakoutLives <= 0) { endBreakoutGame(false); return; }
                breakoutBall = { x: 190, y: 250, dx: 3 * (Math.random() > 0.5 ? 1 : -1), dy: -3 };
                updateBreakoutScore();
            }
            breakoutBricks.forEach(b => {
                if (!b.alive) return;
                if (breakoutBall.x + 12 > b.x && breakoutBall.x < b.x + b.w && breakoutBall.y + 12 > b.y && breakoutBall.y < b.y + b.h) {
                    b.alive = false; breakoutBall.dy *= -1; updateBreakoutScore();
                    if (breakoutBricks.every(br => !br.alive)) { endBreakoutGame(true); return; }
                }
            });
            renderBreakout();
        }
        function endBreakoutGame(w) { stopMiniGame(); document.removeEventListener('keyup', breakoutKeyHandler); if (w) { tinyWins++; saveData(); updateDisplays(); } const broken = breakoutBricks.filter(b => !b.alive).length; showMiniGameResult(w, `Bricks: ${broken}/40`, w ? '+1 Win!' : 'Ball lost!'); }

        let pongKeyHandler, pongKeys = { up: false, down: false };
        function startPongGame() {
            pongPlayer = 130; pongAI = 130; pongScoreP = 0; pongScoreAI = 0;
            pongBall = { x: 185, y: 155, dx: 4, dy: 2 };
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="pong-center" style="position:absolute;left:188px;top:0;width:4px;height:320px;background:repeating-linear-gradient(180deg,#fff 0,#fff 10px,transparent 10px,transparent 20px);opacity:0.3;"></div>';
            document.getElementById('minigame-timer').textContent = 'Pong';
            document.getElementById('minigame-score').textContent = 'You: 0 | AI: 0';
            renderPong();
            pongKeyHandler = (e) => {
                if (e.key === 'ArrowUp') pongKeys.up = e.type === 'keydown';
                if (e.key === 'ArrowDown') pongKeys.down = e.type === 'keydown';
                e.preventDefault();
            };
            document.addEventListener('keydown', pongKeyHandler);
            document.addEventListener('keyup', pongKeyHandler);
            miniGameTimer = setInterval(pongLoop, 20);
        }
        function renderPong() {
            const els = minigameContainer.querySelectorAll('.pong-paddle,.pong-ball');
            els.forEach(e => e.remove());
            const p1 = document.createElement('div'); p1.className = 'pong-paddle';
            p1.style.cssText = `position:absolute;left:10px;top:${pongPlayer}px;width:10px;height:60px;background:#2ecc71;border-radius:3px;`;
            minigameContainer.appendChild(p1);
            const p2 = document.createElement('div'); p2.className = 'pong-paddle';
            p2.style.cssText = `position:absolute;right:10px;top:${pongAI}px;width:10px;height:60px;background:#e74c3c;border-radius:3px;`;
            minigameContainer.appendChild(p2);
            const ball = document.createElement('div'); ball.className = 'pong-ball';
            ball.style.cssText = `position:absolute;left:${pongBall.x}px;top:${pongBall.y}px;width:12px;height:12px;background:#fff;border-radius:50%;box-shadow:0 0 10px #fff;`;
            minigameContainer.appendChild(ball);
        }
        function pongLoop() {
            if (pongKeys.up) pongPlayer = Math.max(0, pongPlayer - 5);
            if (pongKeys.down) pongPlayer = Math.min(260, pongPlayer + 5);
            const aiCenter = pongAI + 30;
            const ballCenter = pongBall.y + 6;
            if (aiCenter < ballCenter - 15) pongAI = Math.min(260, pongAI + 3.5);
            else if (aiCenter > ballCenter + 15) pongAI = Math.max(0, pongAI - 3.5);
            pongBall.x += pongBall.dx; pongBall.y += pongBall.dy;
            if (pongBall.y <= 0 || pongBall.y >= 308) pongBall.dy *= -1;
            if (pongBall.x <= 20 && pongBall.x >= 10 && pongBall.y + 12 >= pongPlayer && pongBall.y <= pongPlayer + 60) {
                pongBall.dx = Math.abs(pongBall.dx) * 1.05;
                pongBall.dy += ((pongBall.y - pongPlayer - 30) / 30) * 2;
            }
            if (pongBall.x >= 355 && pongBall.x <= 365 && pongBall.y + 12 >= pongAI && pongBall.y <= pongAI + 60) {
                pongBall.dx = -Math.abs(pongBall.dx) * 1.05;
                pongBall.dy += ((pongBall.y - pongAI - 30) / 30) * 2;
            }
            pongBall.dx = Math.max(-8, Math.min(8, pongBall.dx));
            pongBall.dy = Math.max(-6, Math.min(6, pongBall.dy));
            if (pongBall.x < 0) { pongScoreAI++; resetPongBall(-1); }
            if (pongBall.x > 380) { pongScoreP++; resetPongBall(1); }
            document.getElementById('minigame-score').textContent = `You: ${pongScoreP} | AI: ${pongScoreAI}`;
            if (pongScoreP >= 7) { endPongGame(true); return; }
            if (pongScoreAI >= 7) { endPongGame(false); return; }
            renderPong();
        }
        function resetPongBall(dir) {
            pongBall = { x: 185, y: 155, dx: 4 * dir, dy: (Math.random() - 0.5) * 4 };
        }
        function endPongGame(w) { stopMiniGame(); document.removeEventListener('keyup', pongKeyHandler); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `You: ${pongScoreP} | AI: ${pongScoreAI}`, w ? '+1 Win!' : 'AI wins!'); }

        let invadersKeyHandler, invadersKeys = { left: false, right: false, shoot: false }, invadersCooldown = 0;
        function startInvadersGame() {
            invaderShip = 175; invaders = []; invaderBullets = []; invaderPlayerBullets = []; invaderDir = 1; invaderLives = 3; invadersCooldown = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            document.getElementById('minigame-timer').textContent = 'Space Invaders';
            const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71'];
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 8; col++) {
                    invaders.push({ x: 30 + col * 42, y: 20 + row * 30, alive: true, color: colors[row] });
                }
            }
            updateInvadersScore();
            renderInvaders();
            invadersKeyHandler = (e) => {
                if (e.key === 'ArrowLeft') invadersKeys.left = e.type === 'keydown';
                if (e.key === 'ArrowRight') invadersKeys.right = e.type === 'keydown';
                if (e.code === 'Space') invadersKeys.shoot = e.type === 'keydown';
                e.preventDefault();
            };
            document.addEventListener('keydown', invadersKeyHandler);
            document.addEventListener('keyup', invadersKeyHandler);
            miniGameTimer = setInterval(invadersLoop, 30);
        }
        function updateInvadersScore() {
            const killed = invaders.filter(i => !i.alive).length;
            document.getElementById('minigame-score').textContent = `Aliens: ${killed}/32 ‚ù§Ô∏è${invaderLives}`;
        }
        function renderInvaders() {
            minigameContainer.querySelectorAll('.inv-alien,.inv-ship,.inv-bullet,.inv-ebullet').forEach(e => e.remove());
            invaders.forEach(inv => {
                if (!inv.alive) return;
                const el = document.createElement('div'); el.className = 'inv-alien';
                el.style.cssText = `position:absolute;left:${inv.x}px;top:${inv.y}px;width:28px;height:20px;background:${inv.color};border-radius:5px 5px 0 0;`;
                el.innerHTML = '<div style="position:absolute;width:6px;height:6px;background:#fff;border-radius:50%;top:6px;left:5px;"></div><div style="position:absolute;width:6px;height:6px;background:#fff;border-radius:50%;top:6px;right:5px;"></div>';
                minigameContainer.appendChild(el);
            });
            const ship = document.createElement('div'); ship.className = 'inv-ship';
            ship.style.cssText = `position:absolute;left:${invaderShip}px;top:285px;width:30px;height:20px;background:#3498db;clip-path:polygon(50% 0%, 100% 100%, 0% 100%);`;
            minigameContainer.appendChild(ship);
            invaderPlayerBullets.forEach(b => {
                const el = document.createElement('div'); el.className = 'inv-bullet';
                el.style.cssText = `position:absolute;left:${b.x}px;top:${b.y}px;width:4px;height:12px;background:#2ecc71;border-radius:2px;`;
                minigameContainer.appendChild(el);
            });
            invaderBullets.forEach(b => {
                const el = document.createElement('div'); el.className = 'inv-ebullet';
                el.style.cssText = `position:absolute;left:${b.x}px;top:${b.y}px;width:4px;height:10px;background:#e74c3c;border-radius:2px;`;
                minigameContainer.appendChild(el);
            });
        }
        function invadersLoop() {
            if (invadersKeys.left) invaderShip = Math.max(0, invaderShip - 4);
            if (invadersKeys.right) invaderShip = Math.min(350, invaderShip + 4);
            if (invadersKeys.shoot && invadersCooldown <= 0 && invaderPlayerBullets.length < 3) {
                invaderPlayerBullets.push({ x: invaderShip + 13, y: 280 }); invadersCooldown = 15;
            }
            if (invadersCooldown > 0) invadersCooldown--;
            invaderPlayerBullets.forEach(b => b.y -= 7);
            invaderPlayerBullets = invaderPlayerBullets.filter(b => b.y > -10);
            let moveDown = false;
            const aliveInvaders = invaders.filter(i => i.alive);
            if (aliveInvaders.length > 0) {
                const minX = Math.min(...aliveInvaders.map(i => i.x));
                const maxX = Math.max(...aliveInvaders.map(i => i.x));
                if (maxX > 345 && invaderDir > 0) { invaderDir = -1; moveDown = true; }
                if (minX < 5 && invaderDir < 0) { invaderDir = 1; moveDown = true; }
            }
            invaders.forEach(inv => {
                if (!inv.alive) return;
                inv.x += invaderDir * 0.8;
                if (moveDown) inv.y += 10;
                if (inv.y > 260) { endInvadersGame(false); return; }
            });
            if (Math.random() < 0.02 && aliveInvaders.length > 0) {
                const shooter = aliveInvaders[Math.floor(Math.random() * aliveInvaders.length)];
                invaderBullets.push({ x: shooter.x + 12, y: shooter.y + 20 });
            }
            invaderBullets.forEach(b => b.y += 4);
            invaderBullets = invaderBullets.filter(b => b.y < 330);
            invaderPlayerBullets.forEach(b => {
                invaders.forEach(inv => {
                    if (inv.alive && b.x > inv.x && b.x < inv.x + 28 && b.y > inv.y && b.y < inv.y + 20) {
                        inv.alive = false; b.y = -100; updateInvadersScore();
                    }
                });
            });
            invaderBullets.forEach(b => {
                if (b.x > invaderShip && b.x < invaderShip + 30 && b.y > 285 && b.y < 305) {
                    invaderLives--; b.y = 400; updateInvadersScore();
                    if (invaderLives <= 0) { endInvadersGame(false); return; }
                }
            });
            if (invaders.every(i => !i.alive)) { endInvadersGame(true); return; }
            renderInvaders();
        }
        function endInvadersGame(w) { stopMiniGame(); document.removeEventListener('keyup', invadersKeyHandler); if (w) { tinyWins++; saveData(); updateDisplays(); } const killed = invaders.filter(i => !i.alive).length; showMiniGameResult(w, `Aliens: ${killed}/32`, w ? '+1 Win!' : 'Invaded!'); }

        let doodleKeyHandler, doodleKeys = { left: false, right: false };
        function startDoodleGame() {
            doodlePlayer = { x: 175, y: 250, vy: 0 }; doodlePlatforms = []; doodleHeight = 0; doodleMaxHeight = 0; doodleWon = false;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="doodle-win-badge" style="display:none;position:absolute;top:5px;right:5px;background:#2ecc71;color:#fff;padding:3px 8px;border-radius:10px;font-size:11px;">WIN!</div>';
            document.getElementById('minigame-timer').textContent = 'Doodle Jump';
            document.getElementById('minigame-score').textContent = 'Height: 0';
            for (let i = 0; i < 8; i++) {
                doodlePlatforms.push({ x: Math.random() * 320, y: 280 - i * 45, w: 60 });
            }
            doodlePlayer.vy = -10;
            renderDoodle();
            doodleKeyHandler = (e) => {
                if (e.key === 'ArrowLeft') doodleKeys.left = e.type === 'keydown';
                if (e.key === 'ArrowRight') doodleKeys.right = e.type === 'keydown';
                e.preventDefault();
            };
            document.addEventListener('keydown', doodleKeyHandler);
            document.addEventListener('keyup', doodleKeyHandler);
            miniGameTimer = setInterval(doodleLoop, 25);
        }
        function renderDoodle() {
            minigameContainer.querySelectorAll('.doodle-plat,.doodle-player').forEach(e => e.remove());
            doodlePlatforms.forEach(p => {
                const el = document.createElement('div'); el.className = 'doodle-plat';
                el.style.cssText = `position:absolute;left:${p.x}px;top:${p.y}px;width:${p.w}px;height:12px;background:linear-gradient(180deg,#2ecc71,#27ae60);border-radius:5px;`;
                minigameContainer.appendChild(el);
            });
            const player = document.createElement('div'); player.className = 'doodle-player';
            player.style.cssText = `position:absolute;left:${doodlePlayer.x}px;top:${doodlePlayer.y}px;width:30px;height:35px;background:#ffd700;border-radius:15px 15px 5px 5px;`;
            player.innerHTML = '<div style="position:absolute;width:8px;height:8px;background:#333;border-radius:50%;top:8px;left:5px;"></div><div style="position:absolute;width:8px;height:8px;background:#333;border-radius:50%;top:8px;right:5px;"></div><div style="position:absolute;width:12px;height:5px;background:#e74c3c;border-radius:3px;bottom:10px;left:9px;"></div>';
            minigameContainer.appendChild(player);
        }
        function doodleLoop() {
            if (doodleKeys.left) doodlePlayer.x -= 5;
            if (doodleKeys.right) doodlePlayer.x += 5;
            if (doodlePlayer.x < -15) doodlePlayer.x = 365;
            if (doodlePlayer.x > 365) doodlePlayer.x = -15;
            doodlePlayer.vy += 0.4;
            doodlePlayer.y += doodlePlayer.vy;
            if (doodlePlayer.vy > 0) {
                doodlePlatforms.forEach(p => {
                    if (doodlePlayer.x + 30 > p.x && doodlePlayer.x < p.x + p.w &&
                        doodlePlayer.y + 35 > p.y && doodlePlayer.y + 35 < p.y + 15 && doodlePlayer.vy > 0) {
                        doodlePlayer.vy = -11;
                    }
                });
            }
            if (doodlePlayer.y < 150) {
                const scrollAmount = 150 - doodlePlayer.y;
                doodlePlayer.y = 150;
                doodleHeight += scrollAmount;
                doodleMaxHeight = Math.max(doodleMaxHeight, doodleHeight);
                doodlePlatforms.forEach(p => p.y += scrollAmount);
                doodlePlatforms = doodlePlatforms.filter(p => p.y < 350);
                while (doodlePlatforms.length < 8) {
                    const topY = Math.min(...doodlePlatforms.map(p => p.y));
                    doodlePlatforms.push({ x: Math.random() * 320, y: topY - 45 - Math.random() * 20, w: 50 + Math.random() * 20 });
                }
            }
            document.getElementById('minigame-score').textContent = `Height: ${Math.floor(doodleMaxHeight)}${doodleWon ? ' ‚úì' : ''}`;
            if (doodleMaxHeight >= 2000 && !doodleWon) {
                doodleWon = true;
                tinyWins++; saveData(); updateDisplays();
                const badge = document.getElementById('doodle-win-badge');
                if (badge) badge.style.display = 'block';
            }
            if (doodlePlayer.y > 330) { endDoodleGame(doodleWon); return; }
            renderDoodle();
        }
        function endDoodleGame(w) { stopMiniGame(); document.removeEventListener('keyup', doodleKeyHandler); showMiniGameResult(w, `Height: ${Math.floor(doodleMaxHeight)}`, w ? 'You won!' : 'Fell down!'); }

        let crossyKeyHandler;
        function startCrossyGame() {
            crossyPlayer = { x: 185, y: 280 }; crossyLanes = []; crossyScore = 0; crossyMaxScore = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            document.getElementById('minigame-timer').textContent = 'Crossy Road';
            document.getElementById('minigame-score').textContent = 'Lanes: 0/20';
            for (let i = 0; i < 10; i++) {
                crossyLanes.push(createCrossyLane(i * 32));
            }
            renderCrossy();
            crossyKeyHandler = (e) => {
                if (e.key === 'ArrowUp') { crossyPlayer.y -= 32; crossyScore++; crossyMaxScore = Math.max(crossyMaxScore, crossyScore); document.getElementById('minigame-score').textContent = `Lanes: ${crossyMaxScore}/20`; }
                if (e.key === 'ArrowDown') { crossyPlayer.y += 32; crossyScore = Math.max(0, crossyScore - 1); }
                if (e.key === 'ArrowLeft') crossyPlayer.x -= 32;
                if (e.key === 'ArrowRight') crossyPlayer.x += 32;
                crossyPlayer.x = Math.max(0, Math.min(360, crossyPlayer.x));
                crossyPlayer.y = Math.max(0, Math.min(300, crossyPlayer.y));
                if (crossyMaxScore >= 20) { endCrossyGame(true); return; }
                e.preventDefault();
            };
            document.addEventListener('keydown', crossyKeyHandler);
            miniGameTimer = setInterval(crossyLoop, 30);
        }
        function createCrossyLane(y) {
            const type = Math.random() < 0.3 ? 'safe' : 'road';
            const lane = { y, type, obstacles: [], speed: (Math.random() * 2 + 1) * (Math.random() < 0.5 ? 1 : -1) };
            if (type === 'road') {
                const count = 2 + Math.floor(Math.random() * 2);
                for (let i = 0; i < count; i++) {
                    lane.obstacles.push({ x: i * (380 / count) + Math.random() * 50, w: 40 + Math.random() * 30 });
                }
            }
            return lane;
        }
        function renderCrossy() {
            minigameContainer.querySelectorAll('.crossy-lane,.crossy-car,.crossy-player').forEach(e => e.remove());
            crossyLanes.forEach(lane => {
                const el = document.createElement('div'); el.className = 'crossy-lane';
                el.style.cssText = `position:absolute;left:0;top:${lane.y}px;width:380px;height:32px;background:${lane.type === 'safe' ? '#2ecc71' : '#555'};`;
                minigameContainer.appendChild(el);
                if (lane.type === 'road') {
                    lane.obstacles.forEach(obs => {
                        const car = document.createElement('div'); car.className = 'crossy-car';
                        const colors = ['#e74c3c', '#3498db', '#f39c12', '#9b59b6', '#1abc9c'];
                        car.style.cssText = `position:absolute;left:${obs.x}px;top:${lane.y + 4}px;width:${obs.w}px;height:24px;background:${colors[Math.floor(Math.random() * colors.length)]};border-radius:5px;`;
                        minigameContainer.appendChild(car);
                    });
                }
            });
            const player = document.createElement('div'); player.className = 'crossy-player';
            player.style.cssText = `position:absolute;left:${crossyPlayer.x}px;top:${crossyPlayer.y}px;width:25px;height:28px;background:#ffd700;border-radius:50% 50% 40% 40%;z-index:10;`;
            player.innerHTML = '<div style="position:absolute;width:5px;height:5px;background:#333;border-radius:50%;top:8px;left:5px;"></div><div style="position:absolute;width:5px;height:5px;background:#333;border-radius:50%;top:8px;right:5px;"></div><div style="position:absolute;width:10px;height:6px;background:#e67e22;left:7px;top:16px;clip-path:polygon(50% 100%, 0% 0%, 100% 0%);"></div>';
            minigameContainer.appendChild(player);
        }
        function crossyLoop() {
            if (crossyPlayer.y < 128) {
                const scrollAmount = 128 - crossyPlayer.y;
                crossyPlayer.y = 128;
                crossyLanes.forEach(lane => lane.y += scrollAmount);
                crossyLanes = crossyLanes.filter(lane => lane.y < 350);
                while (crossyLanes.length < 10) {
                    const topY = Math.min(...crossyLanes.map(l => l.y));
                    crossyLanes.push(createCrossyLane(topY - 32));
                }
            }
            crossyLanes.forEach(lane => {
                if (lane.type === 'road') {
                    lane.obstacles.forEach(obs => {
                        obs.x += lane.speed;
                        if (obs.x > 400) obs.x = -obs.w;
                        if (obs.x < -obs.w) obs.x = 400;
                    });
                }
            });
            const playerLane = crossyLanes.find(l => crossyPlayer.y >= l.y && crossyPlayer.y < l.y + 32);
            if (playerLane && playerLane.type === 'road') {
                for (const obs of playerLane.obstacles) {
                    if (crossyPlayer.x + 25 > obs.x && crossyPlayer.x < obs.x + obs.w) {
                        endCrossyGame(false); return;
                    }
                }
            }
            if (crossyPlayer.y > 310) { endCrossyGame(false); return; }
            renderCrossy();
        }
        function endCrossyGame(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Lanes: ${crossyMaxScore}/20`, w ? '+1 Win!' : 'Hit by car!'); }

        let game2048KeyHandler;
        function start2048Game() {
            grid2048 = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]; score2048 = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="grid2048" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:280px;height:280px;background:#bbada0;border-radius:8px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;"></div>';
            document.getElementById('minigame-timer').textContent = '2048';
            document.getElementById('minigame-score').textContent = 'Score: 0';
            spawn2048Tile(); spawn2048Tile();
            render2048();
            game2048KeyHandler = (e) => {
                let moved = false;
                if (e.key === 'ArrowUp') moved = move2048('up');
                if (e.key === 'ArrowDown') moved = move2048('down');
                if (e.key === 'ArrowLeft') moved = move2048('left');
                if (e.key === 'ArrowRight') moved = move2048('right');
                if (moved) {
                    spawn2048Tile();
                    document.getElementById('minigame-score').textContent = `Score: ${score2048}`;
                    if (has2048Won()) { end2048Game(true); return; }
                    if (is2048GameOver()) { end2048Game(false); return; }
                }
                render2048();
                e.preventDefault();
            };
            document.addEventListener('keydown', game2048KeyHandler);
        }
        function spawn2048Tile() {
            const empty = [];
            for (let r = 0; r < 4; r++) for (let c = 0; c < 4; c++) if (grid2048[r][c] === 0) empty.push({r, c});
            if (empty.length === 0) return;
            const cell = empty[Math.floor(Math.random() * empty.length)];
            grid2048[cell.r][cell.c] = Math.random() < 0.9 ? 2 : 4;
        }
        function get2048Color(val) {
            const colors = { 0: '#cdc1b4', 2: '#eee4da', 4: '#ede0c8', 8: '#f2b179', 16: '#f59563', 32: '#f67c5f', 64: '#f65e3b', 128: '#edcf72', 256: '#edcc61', 512: '#edc850', 1024: '#edc53f', 2048: '#edc22e' };
            return colors[val] || '#3c3a32';
        }
        function get2048TextColor(val) { return val <= 4 ? '#776e65' : '#f9f6f2'; }
        function render2048() {
            const grid = document.getElementById('grid2048'); if (!grid) return;
            grid.innerHTML = '';
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    const val = grid2048[r][c];
                    const cell = document.createElement('div');
                    cell.style.cssText = `background:${get2048Color(val)};border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:${val >= 1000 ? '20px' : val >= 100 ? '24px' : '28px'};font-weight:bold;color:${get2048TextColor(val)};`;
                    cell.textContent = val || '';
                    grid.appendChild(cell);
                }
            }
        }
        function move2048(dir) {
            let moved = false;
            const rotated = dir === 'up' || dir === 'down';
            const reversed = dir === 'down' || dir === 'right';
            for (let i = 0; i < 4; i++) {
                let line = [];
                for (let j = 0; j < 4; j++) {
                    const r = rotated ? j : i, c = rotated ? i : j;
                    line.push(grid2048[r][c]);
                }
                if (reversed) line.reverse();
                const newLine = slide2048Line(line);
                if (reversed) newLine.reverse();
                for (let j = 0; j < 4; j++) {
                    const r = rotated ? j : i, c = rotated ? i : j;
                    if (grid2048[r][c] !== newLine[j]) moved = true;
                    grid2048[r][c] = newLine[j];
                }
            }
            return moved;
        }
        function slide2048Line(line) {
            let arr = line.filter(x => x !== 0);
            for (let i = 0; i < arr.length - 1; i++) {
                if (arr[i] === arr[i + 1]) { arr[i] *= 2; score2048 += arr[i]; arr.splice(i + 1, 1); }
            }
            while (arr.length < 4) arr.push(0);
            return arr;
        }
        function has2048Won() {
            for (let r = 0; r < 4; r++) for (let c = 0; c < 4; c++) if (grid2048[r][c] >= 2048) return true;
            return false;
        }
        function is2048GameOver() {
            for (let r = 0; r < 4; r++) for (let c = 0; c < 4; c++) {
                if (grid2048[r][c] === 0) return false;
                if (c < 3 && grid2048[r][c] === grid2048[r][c + 1]) return false;
                if (r < 3 && grid2048[r][c] === grid2048[r + 1][c]) return false;
            }
            return true;
        }
        function end2048Game(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Score: ${score2048}`, w ? '+1 Win!' : 'No moves left!'); }

        let whackMoleTimer = null;
        function startWhackGame() {
            whackHoles = []; whackScore = 0; whackTime = 30;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="whack-grid" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:grid;grid-template-columns:repeat(3,1fr);gap:20px;"></div>';
            document.getElementById('minigame-timer').textContent = `Time: ${whackTime}`;
            document.getElementById('minigame-score').textContent = 'Moles: 0/20';
            const grid = document.getElementById('whack-grid');
            for (let i = 0; i < 9; i++) {
                const hole = document.createElement('div');
                hole.className = 'whack-hole';
                hole.dataset.index = i;
                hole.style.cssText = 'width:80px;height:80px;background:linear-gradient(180deg,#3d2914 0%,#5d4024 50%,#3d2914 100%);border-radius:50%;position:relative;cursor:pointer;overflow:hidden;box-shadow:inset 0 10px 20px rgba(0,0,0,0.5);';
                hole.innerHTML = '<div class="mole" style="position:absolute;bottom:-60px;left:50%;transform:translateX(-50%);width:60px;height:60px;background:#8b6914;border-radius:50% 50% 40% 40%;transition:bottom 0.1s;"><div style="position:absolute;width:12px;height:12px;background:#333;border-radius:50%;top:15px;left:10px;"></div><div style="position:absolute;width:12px;height:12px;background:#333;border-radius:50%;top:15px;right:10px;"></div><div style="position:absolute;width:20px;height:14px;background:#d4a574;border-radius:50%;top:30px;left:50%;transform:translateX(-50%);"></div></div>';
                hole.onclick = () => whackMole(i);
                grid.appendChild(hole);
                whackHoles.push({ el: hole, active: false });
            }
            miniGameTimer = setInterval(whackTimerLoop, 1000);
            whackMoleTimer = setInterval(spawnMole, 800);
            spawnMole();
        }
        function spawnMole() {
            const inactiveHoles = whackHoles.filter(h => !h.active);
            if (inactiveHoles.length === 0) return;
            const hole = inactiveHoles[Math.floor(Math.random() * inactiveHoles.length)];
            hole.active = true;
            const mole = hole.el.querySelector('.mole');
            mole.style.bottom = '5px';
            setTimeout(() => {
                if (hole.active) {
                    mole.style.bottom = '-60px';
                    hole.active = false;
                }
            }, 1000 + Math.random() * 500);
        }
        function whackMole(index) {
            const hole = whackHoles[index];
            if (!hole.active) return;
            hole.active = false;
            const mole = hole.el.querySelector('.mole');
            mole.style.bottom = '-60px';
            whackScore++;
            document.getElementById('minigame-score').textContent = `Moles: ${whackScore}/20`;
            if (whackScore >= 20) { endWhackGame(true); }
        }
        function whackTimerLoop() {
            whackTime--;
            document.getElementById('minigame-timer').textContent = `Time: ${whackTime}`;
            if (whackTime <= 0) { endWhackGame(whackScore >= 20); }
        }
        function endWhackGame(w) {
            if (whackMoleTimer) clearInterval(whackMoleTimer);
            whackMoleTimer = null;
            stopMiniGame();
            if (w) { tinyWins++; saveData(); updateDisplays(); }
            showMiniGameResult(w, `Moles: ${whackScore}/20`, w ? '+1 Win!' : 'Time up!');
        }

        let asteroidsKeyHandler, astKeys = { left: false, right: false, up: false, shoot: false }, astCooldown = 0;
        function startAsteroidsGame() {
            astShip = { x: 190, y: 160, angle: -90, vx: 0, vy: 0 }; astRocks = []; astBullets = []; astScore = 0; astLives = 3; astCooldown = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            document.getElementById('minigame-timer').textContent = 'Asteroids';
            document.getElementById('minigame-score').textContent = 'Rocks: 0/30 ‚ù§Ô∏è3';
            for (let i = 0; i < 5; i++) spawnAsteroid(2);
            renderAsteroids();
            asteroidsKeyHandler = (e) => {
                if (e.key === 'ArrowLeft') astKeys.left = e.type === 'keydown';
                if (e.key === 'ArrowRight') astKeys.right = e.type === 'keydown';
                if (e.key === 'ArrowUp') astKeys.up = e.type === 'keydown';
                if (e.code === 'Space') astKeys.shoot = e.type === 'keydown';
                e.preventDefault();
            };
            document.addEventListener('keydown', asteroidsKeyHandler);
            document.addEventListener('keyup', asteroidsKeyHandler);
            miniGameTimer = setInterval(asteroidsLoop, 30);
        }
        function spawnAsteroid(size, x, y) {
            const angle = Math.random() * Math.PI * 2;
            const speed = 1 + Math.random() * 2;
            astRocks.push({
                x: x !== undefined ? x : Math.random() * 380,
                y: y !== undefined ? y : Math.random() * 100,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                size: size,
                radius: size * 12
            });
        }
        function renderAsteroids() {
            minigameContainer.querySelectorAll('.ast-ship,.ast-rock,.ast-bullet').forEach(e => e.remove());
            const ship = document.createElement('div'); ship.className = 'ast-ship';
            ship.style.cssText = `position:absolute;left:${astShip.x - 12}px;top:${astShip.y - 12}px;width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:24px solid #3498db;transform:rotate(${astShip.angle + 90}deg);`;
            minigameContainer.appendChild(ship);
            astRocks.forEach(rock => {
                const el = document.createElement('div'); el.className = 'ast-rock';
                el.style.cssText = `position:absolute;left:${rock.x - rock.radius}px;top:${rock.y - rock.radius}px;width:${rock.radius * 2}px;height:${rock.radius * 2}px;background:#888;border-radius:40% 60% 50% 40%;border:2px solid #666;`;
                minigameContainer.appendChild(el);
            });
            astBullets.forEach(b => {
                const el = document.createElement('div'); el.className = 'ast-bullet';
                el.style.cssText = `position:absolute;left:${b.x - 3}px;top:${b.y - 3}px;width:6px;height:6px;background:#fff;border-radius:50%;box-shadow:0 0 5px #fff;`;
                minigameContainer.appendChild(el);
            });
        }
        function asteroidsLoop() {
            if (astKeys.left) astShip.angle -= 5;
            if (astKeys.right) astShip.angle += 5;
            if (astKeys.up) {
                astShip.vx += Math.cos(astShip.angle * Math.PI / 180) * 0.15;
                astShip.vy += Math.sin(astShip.angle * Math.PI / 180) * 0.15;
            }
            astShip.vx *= 0.99; astShip.vy *= 0.99;
            astShip.x += astShip.vx; astShip.y += astShip.vy;
            if (astShip.x < 0) astShip.x = 380; if (astShip.x > 380) astShip.x = 0;
            if (astShip.y < 0) astShip.y = 320; if (astShip.y > 320) astShip.y = 0;
            if (astKeys.shoot && astCooldown <= 0) {
                astBullets.push({ x: astShip.x, y: astShip.y, vx: Math.cos(astShip.angle * Math.PI / 180) * 8, vy: Math.sin(astShip.angle * Math.PI / 180) * 8, life: 50 });
                astCooldown = 10;
            }
            if (astCooldown > 0) astCooldown--;
            astBullets.forEach(b => { b.x += b.vx; b.y += b.vy; b.life--; });
            astBullets = astBullets.filter(b => b.life > 0 && b.x > 0 && b.x < 380 && b.y > 0 && b.y < 320);
            astRocks.forEach(rock => {
                rock.x += rock.vx; rock.y += rock.vy;
                if (rock.x < -rock.radius) rock.x = 380 + rock.radius;
                if (rock.x > 380 + rock.radius) rock.x = -rock.radius;
                if (rock.y < -rock.radius) rock.y = 320 + rock.radius;
                if (rock.y > 320 + rock.radius) rock.y = -rock.radius;
            });
            for (let i = astBullets.length - 1; i >= 0; i--) {
                for (let j = astRocks.length - 1; j >= 0; j--) {
                    const b = astBullets[i], r = astRocks[j];
                    if (b && Math.hypot(b.x - r.x, b.y - r.y) < r.radius) {
                        astBullets.splice(i, 1); astRocks.splice(j, 1); astScore++;
                        if (r.size > 1) { spawnAsteroid(r.size - 1, r.x, r.y); spawnAsteroid(r.size - 1, r.x, r.y); }
                        document.getElementById('minigame-score').textContent = `Rocks: ${astScore}/30 ‚ù§Ô∏è${astLives}`;
                        if (astScore >= 30) { endAsteroidsGame(true); return; }
                        break;
                    }
                }
            }
            for (const rock of astRocks) {
                if (Math.hypot(astShip.x - rock.x, astShip.y - rock.y) < rock.radius + 10) {
                    astLives--; astShip = { x: 190, y: 160, angle: -90, vx: 0, vy: 0 };
                    document.getElementById('minigame-score').textContent = `Rocks: ${astScore}/30 ‚ù§Ô∏è${astLives}`;
                    if (astLives <= 0) { endAsteroidsGame(false); return; }
                    break;
                }
            }
            if (astRocks.length < 3) spawnAsteroid(2);
            renderAsteroids();
        }
        function endAsteroidsGame(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Rocks: ${astScore}/30`, w ? '+1 Win!' : 'Ship destroyed!'); }

        let runnerKeyHandler;
        function startRunnerGame() {
            runnerPlayer = { lane: 1, y: 260, vy: 0, jumping: false }; runnerObstacles = []; runnerCoins = []; runnerDist = 0; runnerSpeed = 5;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="runner-ground" style="position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(180deg,#8b4513 0%,#654321 100%);"></div><div id="runner-lanes" style="position:absolute;bottom:60px;left:0;right:0;height:200px;background:linear-gradient(180deg,#2d5016 0%,#3d6b1e 50%,#2d5016 100%);display:flex;"><div style="flex:1;border-right:2px dashed rgba(255,255,255,0.2);"></div><div style="flex:1;border-right:2px dashed rgba(255,255,255,0.2);"></div><div style="flex:1;"></div></div><div id="runner-sky" style="position:absolute;top:0;left:0;right:0;height:60px;background:linear-gradient(180deg,#87ceeb 0%,#98d8eb 100%);"></div>';
            document.getElementById('minigame-timer').textContent = 'Temple Run';
            document.getElementById('minigame-score').textContent = 'Distance: 0m';
            for (let i = 0; i < 3; i++) spawnRunnerObstacle(400 + i * 200);
            renderRunner();
            runnerKeyHandler = (e) => {
                if (e.key === 'ArrowLeft' && runnerPlayer.lane > 0) runnerPlayer.lane--;
                if (e.key === 'ArrowRight' && runnerPlayer.lane < 2) runnerPlayer.lane++;
                if ((e.key === 'ArrowUp' || e.code === 'Space') && !runnerPlayer.jumping) {
                    runnerPlayer.jumping = true; runnerPlayer.vy = -12;
                }
                if (e.key === 'ArrowDown' && runnerPlayer.jumping) runnerPlayer.vy = 8;
                e.preventDefault();
            };
            document.addEventListener('keydown', runnerKeyHandler);
            miniGameTimer = setInterval(runnerLoop, 30);
        }
        function spawnRunnerObstacle(x) {
            const lane = Math.floor(Math.random() * 3);
            const type = Math.random() < 0.7 ? 'obstacle' : 'coin';
            if (type === 'obstacle') {
                const height = Math.random() < 0.5 ? 'low' : 'high';
                runnerObstacles.push({ x, lane, height });
            } else {
                runnerCoins.push({ x, lane, collected: false });
            }
        }
        function getLaneX(lane) { return 63 + lane * 127; }
        function renderRunner() {
            minigameContainer.querySelectorAll('.runner-player,.runner-obs,.runner-coin').forEach(e => e.remove());
            const playerX = getLaneX(runnerPlayer.lane);
            const player = document.createElement('div'); player.className = 'runner-player';
            player.style.cssText = `position:absolute;left:${playerX - 15}px;bottom:${60 + (260 - runnerPlayer.y)}px;width:30px;height:50px;background:#ffd700;border-radius:15px 15px 5px 5px;z-index:10;`;
            player.innerHTML = '<div style="position:absolute;width:8px;height:8px;background:#333;border-radius:50%;top:10px;left:5px;"></div><div style="position:absolute;width:8px;height:8px;background:#333;border-radius:50%;top:10px;right:5px;"></div><div style="position:absolute;width:20px;height:15px;background:#e74c3c;border-radius:3px;bottom:5px;left:5px;"></div>';
            minigameContainer.appendChild(player);
            runnerObstacles.forEach(obs => {
                const el = document.createElement('div'); el.className = 'runner-obs';
                const ox = getLaneX(obs.lane);
                if (obs.height === 'low') {
                    el.style.cssText = `position:absolute;left:${obs.x - 20}px;bottom:60px;width:40px;height:30px;background:#8b0000;border-radius:5px;border:2px solid #5c0000;`;
                } else {
                    el.style.cssText = `position:absolute;left:${obs.x - 15}px;bottom:60px;width:30px;height:70px;background:#4a2810;border-radius:5px;border:2px solid #2a1808;`;
                }
                minigameContainer.appendChild(el);
            });
            runnerCoins.forEach(coin => {
                if (coin.collected) return;
                const el = document.createElement('div'); el.className = 'runner-coin';
                el.style.cssText = `position:absolute;left:${coin.x - 10}px;bottom:100px;width:20px;height:20px;background:radial-gradient(circle at 30% 30%,#ffd700,#b8860b);border-radius:50%;border:2px solid #daa520;`;
                minigameContainer.appendChild(el);
            });
        }
        function runnerLoop() {
            runnerDist += runnerSpeed / 10;
            runnerSpeed = 5 + runnerDist / 200;
            if (runnerPlayer.jumping) {
                runnerPlayer.vy += 0.8;
                runnerPlayer.y -= runnerPlayer.vy;
                if (runnerPlayer.y >= 260) { runnerPlayer.y = 260; runnerPlayer.jumping = false; runnerPlayer.vy = 0; }
            }
            runnerObstacles.forEach(obs => obs.x -= runnerSpeed);
            runnerCoins.forEach(coin => coin.x -= runnerSpeed);
            runnerObstacles = runnerObstacles.filter(obs => obs.x > -50);
            runnerCoins = runnerCoins.filter(coin => coin.x > -50);
            while (runnerObstacles.length < 4) {
                const lastX = runnerObstacles.length > 0 ? Math.max(...runnerObstacles.map(o => o.x)) : 300;
                spawnRunnerObstacle(lastX + 150 + Math.random() * 100);
            }
            const playerX = getLaneX(runnerPlayer.lane);
            for (const obs of runnerObstacles) {
                const obsX = getLaneX(obs.lane);
                if (Math.abs(obs.x - playerX) < 35 && Math.abs(obsX - playerX) < 40) {
                    if (obs.height === 'low' && runnerPlayer.y < 230) continue;
                    if (obs.height === 'high' && runnerPlayer.y > 220) continue;
                    endRunnerGame(runnerDist >= 1000); return;
                }
            }
            runnerCoins.forEach(coin => {
                if (!coin.collected && Math.abs(coin.x - playerX) < 30 && Math.abs(getLaneX(coin.lane) - playerX) < 40) {
                    coin.collected = true;
                }
            });
            document.getElementById('minigame-score').textContent = `Distance: ${Math.floor(runnerDist)}m`;
            if (runnerDist >= 1000) { endRunnerGame(true); return; }
            renderRunner();
        }
        function endRunnerGame(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Distance: ${Math.floor(runnerDist)}m`, w ? '+1 Win!' : 'Crashed!'); }

        let fruitSpawnTimer = null;
        const FRUITS = [
            { emoji: 'üçé', color: '#e74c3c' },
            { emoji: 'üçä', color: '#e67e22' },
            { emoji: 'üçã', color: '#f1c40f' },
            { emoji: 'üçá', color: '#9b59b6' },
            { emoji: 'üçâ', color: '#2ecc71' },
            { emoji: 'üçì', color: '#e74c3c' },
            { emoji: 'üçë', color: '#f39c12' },
            { emoji: 'ü•ù', color: '#27ae60' }
        ];
        function startFruitGame() {
            fruitItems = []; fruitScore = 0; fruitLives = 3; fruitTime = 45;
            minigameContainer.innerHTML = '<div id="minigame-message"></div>';
            minigameContainer.style.cursor = 'crosshair';
            document.getElementById('minigame-timer').textContent = `Time: ${fruitTime}`;
            document.getElementById('minigame-score').textContent = 'Fruits: 0/30 ‚ù§Ô∏è3';
            minigameContainer.onmousemove = fruitSlice;
            minigameContainer.ontouchmove = (e) => { e.preventDefault(); fruitSlice(e.touches[0]); };
            miniGameTimer = setInterval(fruitLoop, 30);
            fruitSpawnTimer = setInterval(spawnFruit, 800);
            setTimeout(() => { if (miniGameTimer) setInterval(() => fruitTime > 0 && fruitTime--, 1000); }, 0);
        }
        function spawnFruit() {
            const isBomb = Math.random() < 0.15;
            const x = 50 + Math.random() * 280;
            const vx = (Math.random() - 0.5) * 4;
            const vy = -12 - Math.random() * 4;
            if (isBomb) {
                fruitItems.push({ x, y: 340, vx, vy, type: 'bomb', sliced: false, emoji: 'üí£', color: '#333' });
            } else {
                const fruit = FRUITS[Math.floor(Math.random() * FRUITS.length)];
                fruitItems.push({ x, y: 340, vx, vy, type: 'fruit', sliced: false, emoji: fruit.emoji, color: fruit.color });
            }
        }
        function fruitSlice(e) {
            const rect = minigameContainer.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            fruitItems.forEach(item => {
                if (item.sliced) return;
                const dist = Math.hypot(mx - item.x, my - item.y);
                if (dist < 35) {
                    item.sliced = true;
                    if (item.type === 'bomb') {
                        fruitLives--;
                        document.getElementById('minigame-score').textContent = `Fruits: ${fruitScore}/30 ‚ù§Ô∏è${fruitLives}`;
                        if (fruitLives <= 0) endFruitGame(false);
                    } else {
                        fruitScore++;
                        document.getElementById('minigame-score').textContent = `Fruits: ${fruitScore}/30 ‚ù§Ô∏è${fruitLives}`;
                        if (fruitScore >= 30) endFruitGame(true);
                    }
                }
            });
        }
        function fruitLoop() {
            fruitItems.forEach(item => {
                item.x += item.vx;
                item.vy += 0.35;
                item.y += item.vy;
            });
            fruitItems = fruitItems.filter(item => item.y < 400);
            document.getElementById('minigame-timer').textContent = `Time: ${fruitTime}`;
            if (fruitTime <= 0) { endFruitGame(fruitScore >= 30); return; }
            renderFruit();
        }
        function renderFruit() {
            minigameContainer.querySelectorAll('.fruit-item').forEach(e => e.remove());
            fruitItems.forEach(item => {
                if (item.sliced && item.type === 'fruit') {
                    const left = document.createElement('div'); left.className = 'fruit-item';
                    left.style.cssText = `position:absolute;left:${item.x - 20}px;top:${item.y}px;font-size:28px;opacity:0.6;transform:rotate(-30deg);`;
                    left.textContent = item.emoji;
                    minigameContainer.appendChild(left);
                    const right = document.createElement('div'); right.className = 'fruit-item';
                    right.style.cssText = `position:absolute;left:${item.x + 5}px;top:${item.y}px;font-size:28px;opacity:0.6;transform:rotate(30deg);`;
                    right.textContent = item.emoji;
                    minigameContainer.appendChild(right);
                } else if (item.sliced && item.type === 'bomb') {
                    const boom = document.createElement('div'); boom.className = 'fruit-item';
                    boom.style.cssText = `position:absolute;left:${item.x - 20}px;top:${item.y - 20}px;font-size:40px;`;
                    boom.textContent = 'üí•';
                    minigameContainer.appendChild(boom);
                } else {
                    const el = document.createElement('div'); el.className = 'fruit-item';
                    el.style.cssText = `position:absolute;left:${item.x - 18}px;top:${item.y - 18}px;font-size:36px;`;
                    el.textContent = item.emoji;
                    minigameContainer.appendChild(el);
                }
            });
        }
        function endFruitGame(w) {
            if (fruitSpawnTimer) clearInterval(fruitSpawnTimer);
            fruitSpawnTimer = null;
            minigameContainer.onmousemove = null;
            minigameContainer.ontouchmove = null;
            minigameContainer.style.cursor = 'default';
            stopMiniGame();
            if (w) { tinyWins++; saveData(); updateDisplays(); }
            showMiniGameResult(w, `Fruits: ${fruitScore}/30`, w ? '+1 Win!' : (fruitLives <= 0 ? 'Bomb!' : 'Time up!'));
        }

        let geometryKeyHandler, geometryClick;
        function startGeometryGame() {
            geoPlayer = { y: 220, vy: 0, jumping: false }; geoObstacles = []; geoDist = 0; geoSpeed = 5; geoGameOver = false;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="geo-bg" style="position:absolute;top:0;left:0;right:0;bottom:60px;background:linear-gradient(180deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);overflow:hidden;"><div id="geo-stars"></div></div><div id="geo-ground" style="position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(180deg,#4a0080 0%,#2d0050 100%);border-top:3px solid #ff00ff;"></div>';
            document.getElementById('minigame-timer').textContent = 'Geometry Dash';
            document.getElementById('minigame-score').textContent = 'Distance: 0m';
            const stars = document.getElementById('geo-stars');
            for (let i = 0; i < 30; i++) {
                const star = document.createElement('div');
                star.style.cssText = `position:absolute;width:${2 + Math.random() * 3}px;height:${2 + Math.random() * 3}px;background:#fff;border-radius:50%;left:${Math.random() * 380}px;top:${Math.random() * 260}px;opacity:${0.3 + Math.random() * 0.7};`;
                stars.appendChild(star);
            }
            for (let i = 0; i < 3; i++) spawnGeoObstacle(400 + i * 150);
            renderGeometry();
            geometryKeyHandler = (e) => {
                if ((e.code === 'Space' || e.key === 'ArrowUp') && !geoPlayer.jumping && !geoGameOver) {
                    geoPlayer.jumping = true; geoPlayer.vy = -12;
                    e.preventDefault();
                }
            };
            geometryClick = () => {
                if (!geoPlayer.jumping && !geoGameOver) {
                    geoPlayer.jumping = true; geoPlayer.vy = -12;
                }
            };
            document.addEventListener('keydown', geometryKeyHandler);
            minigameContainer.addEventListener('click', geometryClick);
            miniGameTimer = setInterval(geometryLoop, 25);
        }
        function spawnGeoObstacle(x) {
            const type = Math.random() < 0.6 ? 'spike' : 'block';
            if (type === 'spike') {
                const count = 1 + Math.floor(Math.random() * 3);
                for (let i = 0; i < count; i++) {
                    geoObstacles.push({ x: x + i * 25, type: 'spike', w: 25, h: 25 });
                }
            } else {
                const height = Math.random() < 0.5 ? 30 : 50;
                geoObstacles.push({ x, type: 'block', w: 40, h: height });
            }
        }
        function renderGeometry() {
            minigameContainer.querySelectorAll('.geo-player,.geo-obs').forEach(e => e.remove());
            const player = document.createElement('div'); player.className = 'geo-player';
            const rotation = geoPlayer.jumping ? Math.min((260 - geoPlayer.y) * 2, 180) : 0;
            player.style.cssText = `position:absolute;left:60px;bottom:${60 + (260 - geoPlayer.y)}px;width:30px;height:30px;background:linear-gradient(135deg,#00ffff,#0080ff);border:2px solid #fff;transform:rotate(${rotation}deg);box-shadow:0 0 10px #00ffff;`;
            minigameContainer.appendChild(player);
            geoObstacles.forEach(obs => {
                const el = document.createElement('div'); el.className = 'geo-obs';
                if (obs.type === 'spike') {
                    el.style.cssText = `position:absolute;left:${obs.x}px;bottom:60px;width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:25px solid #ff00ff;filter:drop-shadow(0 0 5px #ff00ff);`;
                } else {
                    el.style.cssText = `position:absolute;left:${obs.x}px;bottom:60px;width:${obs.w}px;height:${obs.h}px;background:linear-gradient(180deg,#ff00ff,#800080);border:2px solid #ff66ff;box-shadow:0 0 8px #ff00ff;`;
                }
                minigameContainer.appendChild(el);
            });
        }
        function geometryLoop() {
            if (geoGameOver) return;
            geoDist += geoSpeed / 15;
            geoSpeed = 5 + geoDist / 50;
            if (geoPlayer.jumping) {
                geoPlayer.vy += 0.7;
                geoPlayer.y -= geoPlayer.vy;
                if (geoPlayer.y >= 260) { geoPlayer.y = 260; geoPlayer.jumping = false; geoPlayer.vy = 0; }
            }
            geoObstacles.forEach(obs => obs.x -= geoSpeed);
            geoObstacles = geoObstacles.filter(obs => obs.x > -50);
            while (geoObstacles.length < 5) {
                const lastX = geoObstacles.length > 0 ? Math.max(...geoObstacles.map(o => o.x)) : 300;
                spawnGeoObstacle(lastX + 120 + Math.random() * 80);
            }
            const playerLeft = 60, playerRight = 90, playerBottom = 260 - geoPlayer.y, playerTop = playerBottom + 30;
            for (const obs of geoObstacles) {
                let hitbox;
                if (obs.type === 'spike') {
                    hitbox = { left: obs.x + 5, right: obs.x + 19, bottom: 0, top: 20 };
                } else {
                    hitbox = { left: obs.x, right: obs.x + obs.w, bottom: 0, top: obs.h };
                }
                if (playerRight > hitbox.left && playerLeft < hitbox.right &&
                    playerBottom < hitbox.top && playerTop > hitbox.bottom) {
                    endGeometryGame(geoDist >= 100); return;
                }
            }
            document.getElementById('minigame-score').textContent = `Distance: ${Math.floor(geoDist)}m`;
            if (geoDist >= 100) { endGeometryGame(true); return; }
            renderGeometry();
        }
        function endGeometryGame(w) { geoGameOver = true; stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Distance: ${Math.floor(geoDist)}m`, w ? '+1 Win!' : 'Crashed!'); }

        function startPianoGame() {
            pianoTiles = []; pianoScore = 0; pianoSpeed = 3; pianoGameOver = false;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="piano-lanes" style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;"></div>';
            document.getElementById('minigame-timer').textContent = 'Piano Tiles';
            document.getElementById('minigame-score').textContent = 'Tiles: 0/30';
            const lanes = document.getElementById('piano-lanes');
            for (let i = 0; i < 4; i++) {
                const lane = document.createElement('div');
                lane.className = 'piano-lane';
                lane.dataset.lane = i;
                lane.style.cssText = `flex:1;background:${i % 2 === 0 ? '#f0f0f0' : '#e0e0e0'};border-right:2px solid #ccc;position:relative;cursor:pointer;`;
                lane.onclick = (e) => handlePianoClick(i, e);
                lanes.appendChild(lane);
            }
            for (let i = 0; i < 4; i++) spawnPianoTile(-80 - i * 100);
            renderPiano();
            miniGameTimer = setInterval(pianoLoop, 25);
        }
        function spawnPianoTile(y) {
            const lane = Math.floor(Math.random() * 4);
            pianoTiles.push({ lane, y, tapped: false, missed: false });
        }
        function handlePianoClick(lane, e) {
            if (pianoGameOver) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const clickY = e.clientY - rect.top;
            let tappedAny = false;
            for (const tile of pianoTiles) {
                if (tile.lane === lane && !tile.tapped && !tile.missed) {
                    if (clickY >= tile.y && clickY <= tile.y + 80) {
                        tile.tapped = true;
                        pianoScore++;
                        document.getElementById('minigame-score').textContent = `Tiles: ${pianoScore}/30`;
                        tappedAny = true;
                        if (pianoScore >= 30) { endPianoGame(true); return; }
                        break;
                    }
                }
            }
            if (!tappedAny) {
                let tappedWhite = true;
                for (const tile of pianoTiles) {
                    if (tile.lane === lane && !tile.tapped && tile.y < 320 && tile.y + 80 > 0) {
                        tappedWhite = false;
                        break;
                    }
                }
                if (tappedWhite) {
                    endPianoGame(false);
                }
            }
        }
        function renderPiano() {
            minigameContainer.querySelectorAll('.piano-tile').forEach(e => e.remove());
            const lanes = document.getElementById('piano-lanes');
            if (!lanes) return;
            pianoTiles.forEach(tile => {
                if (tile.tapped || tile.y > 350) return;
                const el = document.createElement('div'); el.className = 'piano-tile';
                const laneWidth = 95;
                el.style.cssText = `position:absolute;left:${tile.lane * laneWidth}px;top:${tile.y}px;width:${laneWidth - 4}px;height:80px;background:${tile.missed ? '#e74c3c' : '#1a1a2e'};border-radius:5px;margin-left:2px;pointer-events:none;`;
                minigameContainer.appendChild(el);
            });
        }
        function pianoLoop() {
            if (pianoGameOver) return;
            pianoSpeed = 3 + pianoScore / 15;
            pianoTiles.forEach(tile => tile.y += pianoSpeed);
            for (const tile of pianoTiles) {
                if (!tile.tapped && !tile.missed && tile.y > 320) {
                    tile.missed = true;
                    endPianoGame(false);
                    return;
                }
            }
            pianoTiles = pianoTiles.filter(tile => tile.y < 400);
            while (pianoTiles.filter(t => !t.tapped).length < 5) {
                const lastY = pianoTiles.length > 0 ? Math.min(...pianoTiles.filter(t => !t.tapped).map(t => t.y)) : 0;
                spawnPianoTile(lastY - 100);
            }
            renderPiano();
        }
        function endPianoGame(w) { pianoGameOver = true; stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Tiles: ${pianoScore}/30`, w ? '+1 Win!' : 'Missed tile!'); }

        const SIMON_COLORS = [
            { id: 0, color: '#e74c3c', light: '#ff6b6b', name: 'red' },
            { id: 1, color: '#3498db', light: '#5dade2', name: 'blue' },
            { id: 2, color: '#2ecc71', light: '#58d68d', name: 'green' },
            { id: 3, color: '#f1c40f', light: '#f7dc6f', name: 'yellow' }
        ];
        function startSimonGame() {
            simonSequence = []; simonPlayerIndex = 0; simonRound = 0; simonPlaying = false; simonShowingSequence = false;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="simon-board" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:240px;height:240px;border-radius:50%;background:#1a1a2e;padding:10px;box-shadow:0 0 20px rgba(0,0,0,0.5);"></div><div id="simon-center" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;border-radius:50%;background:#2a2a4e;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:#ffd700;z-index:5;"></div>';
            document.getElementById('minigame-timer').textContent = 'Simon Says';
            document.getElementById('minigame-score').textContent = 'Round: 0/10';
            const board = document.getElementById('simon-board');
            SIMON_COLORS.forEach((c, i) => {
                const btn = document.createElement('div');
                btn.className = 'simon-btn';
                btn.id = `simon-${c.id}`;
                const positions = [
                    { top: '10px', left: '10px', borderRadius: '120px 10px 10px 10px' },
                    { top: '10px', right: '10px', borderRadius: '10px 120px 10px 10px' },
                    { bottom: '10px', left: '10px', borderRadius: '10px 10px 10px 120px' },
                    { bottom: '10px', right: '10px', borderRadius: '10px 10px 120px 10px' }
                ];
                const pos = positions[i];
                btn.style.cssText = `position:absolute;width:100px;height:100px;background:${c.color};cursor:pointer;transition:all 0.1s;${Object.entries(pos).map(([k,v]) => `${k}:${v}`).join(';')};`;
                btn.onclick = () => handleSimonClick(c.id);
                board.appendChild(btn);
            });
            setTimeout(() => simonNextRound(), 1000);
        }
        function simonNextRound() {
            simonRound++;
            document.getElementById('minigame-score').textContent = `Round: ${simonRound}/10`;
            document.getElementById('simon-center').textContent = simonRound;
            simonSequence.push(Math.floor(Math.random() * 4));
            simonPlayerIndex = 0;
            simonShowingSequence = true;
            simonPlaying = false;
            showSimonSequence();
        }
        function showSimonSequence() {
            let i = 0;
            const showNext = () => {
                if (i >= simonSequence.length) {
                    simonShowingSequence = false;
                    simonPlaying = true;
                    return;
                }
                const colorId = simonSequence[i];
                flashSimonButton(colorId);
                i++;
                setTimeout(showNext, 600);
            };
            setTimeout(showNext, 500);
        }
        function flashSimonButton(id) {
            const btn = document.getElementById(`simon-${id}`);
            const color = SIMON_COLORS[id];
            if (!btn) return;
            btn.style.background = color.light;
            btn.style.boxShadow = `0 0 30px ${color.light}`;
            setTimeout(() => {
                btn.style.background = color.color;
                btn.style.boxShadow = 'none';
            }, 300);
        }
        function handleSimonClick(id) {
            if (!simonPlaying || simonShowingSequence) return;
            flashSimonButton(id);
            if (simonSequence[simonPlayerIndex] === id) {
                simonPlayerIndex++;
                if (simonPlayerIndex >= simonSequence.length) {
                    if (simonRound >= 10) {
                        endSimonGame(true);
                    } else {
                        simonPlaying = false;
                        setTimeout(() => simonNextRound(), 1000);
                    }
                }
            } else {
                endSimonGame(false);
            }
        }
        function endSimonGame(w) { simonPlaying = false; stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Round: ${simonRound}/10`, w ? '+1 Win!' : 'Wrong pattern!'); }

        function startTTTGame() {
            tttPlayerWins = 0; tttAIWins = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="ttt-status" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);font-size:14px;color:#ffd700;"></div><div id="ttt-board" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:240px;height:240px;"></div><div id="ttt-score" style="position:absolute;bottom:15px;left:50%;transform:translateX(-50%);font-size:16px;"></div>';
            document.getElementById('minigame-timer').textContent = 'Tic Tac Toe';
            document.getElementById('minigame-score').textContent = 'You: 0 | AI: 0';
            startTTTRound();
        }
        function startTTTRound() {
            tttBoard = ['', '', '', '', '', '', '', '', ''];
            tttCurrentTurn = 'X';
            tttGameActive = true;
            document.getElementById('ttt-status').textContent = 'Your turn (X)';
            renderTTT();
        }
        function renderTTT() {
            const board = document.getElementById('ttt-board');
            if (!board) return;
            board.innerHTML = '';
            tttBoard.forEach((cell, i) => {
                const cellEl = document.createElement('div');
                cellEl.style.cssText = `background:#2a2a4e;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:bold;cursor:${cell === '' && tttGameActive && tttCurrentTurn === 'X' ? 'pointer' : 'default'};color:${cell === 'X' ? '#3498db' : '#e74c3c'};transition:all 0.2s;`;
                cellEl.textContent = cell;
                if (cell === '' && tttGameActive && tttCurrentTurn === 'X') {
                    cellEl.onmouseover = () => cellEl.style.background = '#3a3a6e';
                    cellEl.onmouseout = () => cellEl.style.background = '#2a2a4e';
                    cellEl.onclick = () => handleTTTClick(i);
                }
                board.appendChild(cellEl);
            });
            document.getElementById('ttt-score').innerHTML = `<span style="color:#3498db;">You: ${tttPlayerWins}</span> | <span style="color:#e74c3c;">AI: ${tttAIWins}</span>`;
        }
        function handleTTTClick(index) {
            if (!tttGameActive || tttBoard[index] !== '' || tttCurrentTurn !== 'X') return;
            tttBoard[index] = 'X';
            renderTTT();
            const result = checkTTTWinner();
            if (result) { handleTTTResult(result); return; }
            tttCurrentTurn = 'O';
            document.getElementById('ttt-status').textContent = 'AI thinking...';
            setTimeout(tttAIMove, 500);
        }
        function tttAIMove() {
            if (!tttGameActive) return;
            const move = getBestTTTMove();
            if (move !== -1) {
                tttBoard[move] = 'O';
                renderTTT();
                const result = checkTTTWinner();
                if (result) { handleTTTResult(result); return; }
            }
            tttCurrentTurn = 'X';
            document.getElementById('ttt-status').textContent = 'Your turn (X)';
        }
        function getBestTTTMove() {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (const [a,b,c] of lines) {
                if (tttBoard[a] === 'O' && tttBoard[b] === 'O' && tttBoard[c] === '') return c;
                if (tttBoard[a] === 'O' && tttBoard[c] === 'O' && tttBoard[b] === '') return b;
                if (tttBoard[b] === 'O' && tttBoard[c] === 'O' && tttBoard[a] === '') return a;
            }
            for (const [a,b,c] of lines) {
                if (tttBoard[a] === 'X' && tttBoard[b] === 'X' && tttBoard[c] === '') return c;
                if (tttBoard[a] === 'X' && tttBoard[c] === 'X' && tttBoard[b] === '') return b;
                if (tttBoard[b] === 'X' && tttBoard[c] === 'X' && tttBoard[a] === '') return a;
            }
            if (tttBoard[4] === '') return 4;
            const corners = [0, 2, 6, 8].filter(i => tttBoard[i] === '');
            if (corners.length > 0) return corners[Math.floor(Math.random() * corners.length)];
            const empty = tttBoard.map((c, i) => c === '' ? i : -1).filter(i => i !== -1);
            return empty.length > 0 ? empty[Math.floor(Math.random() * empty.length)] : -1;
        }
        function checkTTTWinner() {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (const [a,b,c] of lines) {
                if (tttBoard[a] && tttBoard[a] === tttBoard[b] && tttBoard[a] === tttBoard[c]) {
                    return tttBoard[a];
                }
            }
            if (tttBoard.every(c => c !== '')) return 'draw';
            return null;
        }
        function handleTTTResult(result) {
            tttGameActive = false;
            if (result === 'X') {
                tttPlayerWins++;
                document.getElementById('ttt-status').innerHTML = '<span style="color:#2ecc71;">You win this round!</span>';
            } else if (result === 'O') {
                tttAIWins++;
                document.getElementById('ttt-status').innerHTML = '<span style="color:#e74c3c;">AI wins this round!</span>';
            } else {
                document.getElementById('ttt-status').innerHTML = '<span style="color:#f39c12;">Draw!</span>';
            }
            renderTTT();
            if (tttPlayerWins >= 2) {
                setTimeout(() => endTTTGame(true), 1000);
            } else if (tttAIWins >= 2) {
                setTimeout(() => endTTTGame(false), 1000);
            } else {
                setTimeout(startTTTRound, 1500);
            }
        }
        function endTTTGame(w) { tttGameActive = false; stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `You: ${tttPlayerWins} | AI: ${tttAIWins}`, w ? '+1 Win!' : 'AI wins!'); }

        function startC4Game() {
            c4PlayerWins = 0; c4AIWins = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="c4-status" style="position:absolute;top:5px;left:50%;transform:translateX(-50%);font-size:14px;color:#ffd700;"></div><div id="c4-board" style="position:absolute;top:30px;left:50%;transform:translateX(-50%);background:#3498db;border-radius:10px;padding:8px;display:grid;grid-template-columns:repeat(7,1fr);gap:4px;"></div><div id="c4-score" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:14px;"></div>';
            document.getElementById('minigame-timer').textContent = 'Connect Four';
            document.getElementById('minigame-score').textContent = 'You: 0 | AI: 0';
            startC4Round();
        }
        function startC4Round() {
            c4Board = Array(6).fill(null).map(() => Array(7).fill(''));
            c4CurrentTurn = 'player'; c4GameActive = true;
            document.getElementById('c4-status').textContent = 'Your turn (üî¥)';
            renderC4();
        }
        function renderC4() {
            const board = document.getElementById('c4-board');
            if (!board) return;
            board.innerHTML = '';
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    const piece = c4Board[row][col];
                    let bg = '#1a1a2e';
                    if (piece === 'player') bg = '#e74c3c';
                    else if (piece === 'ai') bg = '#f1c40f';
                    cell.style.cssText = `width:38px;height:38px;background:${bg};border-radius:50%;cursor:${c4GameActive && c4CurrentTurn === 'player' ? 'pointer' : 'default'};transition:background 0.2s;`;
                    if (c4GameActive && c4CurrentTurn === 'player' && c4Board[row][col] === '') {
                        cell.onmouseover = () => { if (c4Board[row][col] === '') cell.style.background = 'rgba(231,76,60,0.3)'; };
                        cell.onmouseout = () => { if (c4Board[row][col] === '') cell.style.background = '#1a1a2e'; };
                        cell.onclick = () => handleC4Click(col);
                    }
                    board.appendChild(cell);
                }
            }
        }
        function handleC4Click(col) {
            if (!c4GameActive || c4CurrentTurn !== 'player') return;
            const row = getC4LowestRow(col);
            if (row === -1) return;
            c4Board[row][col] = 'player';
            renderC4();
            if (checkC4Winner('player')) { endC4Game(true); return; }
            if (isC4Full()) { endC4Game(false, true); return; }
            c4CurrentTurn = 'ai';
            document.getElementById('c4-status').textContent = 'AI thinking...';
            setTimeout(c4AIMove, 600);
        }
        function getC4LowestRow(col) {
            for (let row = 5; row >= 0; row--) {
                if (c4Board[row][col] === '') return row;
            }
            return -1;
        }
        function c4AIMove() {
            if (!c4GameActive) return;
            const col = getBestC4Move();
            if (col === -1) { endC4Game(false, true); return; }
            const row = getC4LowestRow(col);
            c4Board[row][col] = 'ai';
            renderC4();
            if (checkC4Winner('ai')) { endC4Game(false); return; }
            if (isC4Full()) { endC4Game(false, true); return; }
            c4CurrentTurn = 'player';
            document.getElementById('c4-status').textContent = 'Your turn (üî¥)';
        }
        function getBestC4Move() {
            for (let col = 0; col < 7; col++) {
                const row = getC4LowestRow(col);
                if (row !== -1) {
                    c4Board[row][col] = 'ai';
                    if (checkC4Winner('ai')) { c4Board[row][col] = ''; return col; }
                    c4Board[row][col] = '';
                }
            }
            for (let col = 0; col < 7; col++) {
                const row = getC4LowestRow(col);
                if (row !== -1) {
                    c4Board[row][col] = 'player';
                    if (checkC4Winner('player')) { c4Board[row][col] = ''; return col; }
                    c4Board[row][col] = '';
                }
            }
            if (getC4LowestRow(3) !== -1) return 3;
            const preferred = [3, 2, 4, 1, 5, 0, 6];
            for (const col of preferred) {
                if (getC4LowestRow(col) !== -1) return col;
            }
            return -1;
        }
        function checkC4Winner(who) {
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 4; col++) {
                    if (c4Board[row][col] === who && c4Board[row][col+1] === who && c4Board[row][col+2] === who && c4Board[row][col+3] === who) return true;
                }
            }
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 7; col++) {
                    if (c4Board[row][col] === who && c4Board[row+1][col] === who && c4Board[row+2][col] === who && c4Board[row+3][col] === who) return true;
                }
            }
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 4; col++) {
                    if (c4Board[row][col] === who && c4Board[row+1][col+1] === who && c4Board[row+2][col+2] === who && c4Board[row+3][col+3] === who) return true;
                }
            }
            for (let row = 3; row < 6; row++) {
                for (let col = 0; col < 4; col++) {
                    if (c4Board[row][col] === who && c4Board[row-1][col+1] === who && c4Board[row-2][col+2] === who && c4Board[row-3][col+3] === who) return true;
                }
            }
            return false;
        }
        function isC4Full() {
            return c4Board[0].every(cell => cell !== '');
        }
        function endC4Game(w, draw = false) {
            c4GameActive = false;
            if (draw) {
                document.getElementById('c4-status').innerHTML = '<span style="color:#f39c12;">Draw! New round...</span>';
            } else if (w) {
                c4PlayerWins++;
                document.getElementById('c4-status').innerHTML = '<span style="color:#2ecc71;">You win this round!</span>';
            } else {
                c4AIWins++;
                document.getElementById('c4-status').innerHTML = '<span style="color:#e74c3c;">AI wins this round!</span>';
            }
            document.getElementById('minigame-score').textContent = `You: ${c4PlayerWins} | AI: ${c4AIWins}`;
            if (c4PlayerWins >= 2) {
                setTimeout(() => {
                    stopMiniGame();
                    tinyWins++; saveData(); updateDisplays();
                    showMiniGameResult(true, `You: ${c4PlayerWins} | AI: ${c4AIWins}`, '+1 Win!');
                }, 1000);
            } else if (c4AIWins >= 2) {
                setTimeout(() => {
                    stopMiniGame();
                    showMiniGameResult(false, `You: ${c4PlayerWins} | AI: ${c4AIWins}`, 'AI wins!');
                }, 1000);
            } else {
                setTimeout(startC4Round, 1500);
            }
        }

        const TRIVIA_BANK = [
            { q: "What planet is known as the Red Planet?", a: ["Mars", "Venus", "Jupiter", "Saturn"], correct: 0 },
            { q: "How many continents are there?", a: ["5", "6", "7", "8"], correct: 2 },
            { q: "What is the largest ocean?", a: ["Atlantic", "Indian", "Pacific", "Arctic"], correct: 2 },
            { q: "What year did World War II end?", a: ["1943", "1944", "1945", "1946"], correct: 2 },
            { q: "What is the capital of France?", a: ["London", "Berlin", "Madrid", "Paris"], correct: 3 },
            { q: "How many legs does a spider have?", a: ["6", "8", "10", "12"], correct: 1 },
            { q: "What is the hardest natural substance?", a: ["Gold", "Iron", "Diamond", "Platinum"], correct: 2 },
            { q: "Who painted the Mona Lisa?", a: ["Van Gogh", "Picasso", "Da Vinci", "Monet"], correct: 2 },
            { q: "What is the smallest country?", a: ["Monaco", "Vatican City", "Malta", "Liechtenstein"], correct: 1 },
            { q: "How many colors in a rainbow?", a: ["5", "6", "7", "8"], correct: 2 },
            { q: "What is the largest mammal?", a: ["Elephant", "Blue Whale", "Giraffe", "Hippo"], correct: 1 },
            { q: "What gas do plants absorb?", a: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Helium"], correct: 2 },
            { q: "How many bones in the human body?", a: ["186", "206", "226", "246"], correct: 1 },
            { q: "What is the speed of light?", a: ["300,000 km/s", "150,000 km/s", "500,000 km/s", "100,000 km/s"], correct: 0 },
            { q: "Which planet has the most moons?", a: ["Jupiter", "Saturn", "Uranus", "Neptune"], correct: 1 },
            { q: "What is H2O commonly known as?", a: ["Salt", "Sugar", "Water", "Acid"], correct: 2 },
            { q: "Who wrote Romeo and Juliet?", a: ["Dickens", "Shakespeare", "Austen", "Hemingway"], correct: 1 },
            { q: "What is the tallest mountain?", a: ["K2", "Kangchenjunga", "Everest", "Lhotse"], correct: 2 },
            { q: "How many players on a soccer team?", a: ["9", "10", "11", "12"], correct: 2 },
            { q: "What year did the Titanic sink?", a: ["1910", "1911", "1912", "1913"], correct: 2 },
            { q: "What is the capital of Japan?", a: ["Seoul", "Beijing", "Tokyo", "Bangkok"], correct: 2 },
            { q: "How many hours in a day?", a: ["12", "24", "36", "48"], correct: 1 },
            { q: "What animal is known as King of the Jungle?", a: ["Tiger", "Elephant", "Lion", "Gorilla"], correct: 2 },
            { q: "What is the largest planet?", a: ["Saturn", "Jupiter", "Neptune", "Uranus"], correct: 1 },
            { q: "How many sides does a hexagon have?", a: ["5", "6", "7", "8"], correct: 1 },
            { q: "What is the freezing point of water?", a: ["-10¬∞C", "0¬∞C", "10¬∞C", "32¬∞C"], correct: 1 },
            { q: "Who discovered gravity?", a: ["Einstein", "Newton", "Galileo", "Darwin"], correct: 1 },
            { q: "What is the capital of Italy?", a: ["Milan", "Venice", "Rome", "Florence"], correct: 2 },
            { q: "How many strings on a standard guitar?", a: ["4", "5", "6", "8"], correct: 2 },
            { q: "What is the longest river?", a: ["Amazon", "Nile", "Mississippi", "Yangtze"], correct: 1 },
            { q: "Which element has symbol 'O'?", a: ["Gold", "Oxygen", "Osmium", "Oganesson"], correct: 1 },
            { q: "What year did man first walk on the moon?", a: ["1965", "1967", "1969", "1971"], correct: 2 },
            { q: "How many days in a leap year?", a: ["364", "365", "366", "367"], correct: 2 },
            { q: "What is the capital of Australia?", a: ["Sydney", "Melbourne", "Canberra", "Perth"], correct: 2 },
            { q: "Which ocean is the smallest?", a: ["Atlantic", "Indian", "Arctic", "Pacific"], correct: 2 },
            { q: "What is the main ingredient in bread?", a: ["Rice", "Corn", "Flour", "Oats"], correct: 2 },
            { q: "How many weeks in a year?", a: ["48", "50", "52", "54"], correct: 2 },
            { q: "What color do you get mixing red and blue?", a: ["Green", "Orange", "Purple", "Brown"], correct: 2 },
            { q: "Which planet is closest to the Sun?", a: ["Venus", "Mercury", "Mars", "Earth"], correct: 1 },
            { q: "What is the capital of Egypt?", a: ["Cairo", "Alexandria", "Luxor", "Giza"], correct: 0 },
            { q: "How many teeth does an adult human have?", a: ["28", "30", "32", "34"], correct: 2 },
            { q: "What is the largest bird?", a: ["Eagle", "Ostrich", "Albatross", "Condor"], correct: 1 },
            { q: "Who invented the telephone?", a: ["Edison", "Tesla", "Bell", "Morse"], correct: 2 },
            { q: "What is the capital of Brazil?", a: ["Rio de Janeiro", "S√£o Paulo", "Bras√≠lia", "Salvador"], correct: 2 },
            { q: "How many minutes in an hour?", a: ["30", "45", "60", "90"], correct: 2 },
            { q: "What is the chemical symbol for gold?", a: ["Go", "Gd", "Au", "Ag"], correct: 2 },
            { q: "Which country has the most people?", a: ["USA", "India", "China", "Russia"], correct: 2 },
            { q: "What is the boiling point of water?", a: ["90¬∞C", "100¬∞C", "110¬∞C", "120¬∞C"], correct: 1 },
            { q: "How many planets in our solar system?", a: ["7", "8", "9", "10"], correct: 1 },
            { q: "What is the capital of Germany?", a: ["Munich", "Frankfurt", "Berlin", "Hamburg"], correct: 2 },
            { q: "Which animal is the fastest?", a: ["Lion", "Cheetah", "Horse", "Gazelle"], correct: 1 },
            { q: "What year was the first iPhone released?", a: ["2005", "2006", "2007", "2008"], correct: 2 },
            { q: "How many hearts does an octopus have?", a: ["1", "2", "3", "4"], correct: 2 },
            { q: "What is the largest desert?", a: ["Sahara", "Arabian", "Gobi", "Antarctic"], correct: 3 },
            { q: "Which vitamin comes from sunlight?", a: ["Vitamin A", "Vitamin B", "Vitamin C", "Vitamin D"], correct: 3 },
            { q: "What is the capital of Canada?", a: ["Toronto", "Vancouver", "Ottawa", "Montreal"], correct: 2 },
            { q: "How many degrees in a circle?", a: ["180", "270", "360", "450"], correct: 2 },
            { q: "What is the smallest bone in the body?", a: ["Stapes", "Femur", "Radius", "Phalanx"], correct: 0 },
            { q: "Which is the largest continent?", a: ["Africa", "North America", "Europe", "Asia"], correct: 3 },
            { q: "What gas makes up most of Earth's atmosphere?", a: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"], correct: 1 },
        ];
        function startTriviaGame() {
            triviaQuestions = [...TRIVIA_BANK].sort(() => Math.random() - 0.5).slice(0, 10);
            triviaIndex = 0; triviaScore = 0; triviaAnswered = false;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="trivia-container" style="position:absolute;top:10px;left:10px;right:10px;bottom:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;"></div>';
            document.getElementById('minigame-timer').textContent = 'Trivia';
            document.getElementById('minigame-score').textContent = 'Q: 1/10 | Score: 0';
            showTriviaQuestion();
        }
        function showTriviaQuestion() {
            triviaAnswered = false;
            const container = document.getElementById('trivia-container');
            if (!container) return;
            const q = triviaQuestions[triviaIndex];
            container.innerHTML = `
                <div style="font-size:14px;color:#ffd700;margin-bottom:15px;">Question ${triviaIndex + 1} of 10</div>
                <div style="font-size:16px;text-align:center;margin-bottom:20px;padding:0 10px;">${q.q}</div>
                <div id="trivia-answers" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:340px;"></div>
                <div id="trivia-feedback" style="margin-top:15px;font-size:14px;min-height:20px;"></div>
            `;
            const answersDiv = document.getElementById('trivia-answers');
            q.a.forEach((answer, i) => {
                const btn = document.createElement('button');
                btn.style.cssText = 'padding:12px 8px;background:#2a2a4e;border:2px solid #9b59b6;color:#fff;border-radius:8px;cursor:pointer;font-size:13px;transition:all 0.2s;';
                btn.textContent = answer;
                btn.onmouseover = () => { if (!triviaAnswered) btn.style.background = '#3a3a6e'; };
                btn.onmouseout = () => { if (!triviaAnswered) btn.style.background = '#2a2a4e'; };
                btn.onclick = () => handleTriviaAnswer(i);
                answersDiv.appendChild(btn);
            });
        }
        function handleTriviaAnswer(selected) {
            if (triviaAnswered) return;
            triviaAnswered = true;
            const q = triviaQuestions[triviaIndex];
            const buttons = document.querySelectorAll('#trivia-answers button');
            const feedback = document.getElementById('trivia-feedback');
            buttons.forEach((btn, i) => {
                btn.style.cursor = 'default';
                if (i === q.correct) {
                    btn.style.background = '#2ecc71';
                    btn.style.borderColor = '#2ecc71';
                } else if (i === selected) {
                    btn.style.background = '#e74c3c';
                    btn.style.borderColor = '#e74c3c';
                }
            });
            if (selected === q.correct) {
                triviaScore++;
                feedback.innerHTML = '<span style="color:#2ecc71;">Correct! ‚úì</span>';
            } else {
                feedback.innerHTML = `<span style="color:#e74c3c;">Wrong! The answer was: ${q.a[q.correct]}</span>`;
            }
            document.getElementById('minigame-score').textContent = `Q: ${triviaIndex + 1}/10 | Score: ${triviaScore}`;
            setTimeout(() => {
                triviaIndex++;
                if (triviaIndex >= 10) {
                    endTriviaGame(triviaScore >= 8);
                } else {
                    showTriviaQuestion();
                }
            }, 1500);
        }
        function endTriviaGame(w) { stopMiniGame(); if (w) { tinyWins++; saveData(); updateDisplays(); } showMiniGameResult(w, `Score: ${triviaScore}/10`, w ? '+1 Win!' : 'Need 8+ correct!'); }

        const TYPING_WORDS = [
            'apple', 'house', 'water', 'music', 'happy', 'green', 'phone', 'light', 'world', 'dream',
            'space', 'cloud', 'river', 'beach', 'storm', 'plant', 'bread', 'chair', 'clock', 'dance',
            'earth', 'fire', 'ghost', 'heart', 'juice', 'knife', 'lemon', 'money', 'night', 'ocean',
            'paper', 'queen', 'robot', 'snake', 'tiger', 'train', 'voice', 'watch', 'zebra', 'brain',
            'candy', 'piano', 'magic', 'smile', 'stone', 'think', 'quick', 'proud', 'lucky', 'crazy',
            'super', 'sweet', 'fresh', 'clean', 'brave', 'smart', 'story', 'power', 'speed', 'peace',
            'game', 'code', 'star', 'moon', 'fish', 'bird', 'tree', 'book', 'door', 'hand',
            'type', 'fast', 'cool', 'nice', 'good', 'best', 'time', 'play', 'work', 'love'
        ];
        function startTypingGame() {
            typingWords = [...TYPING_WORDS].sort(() => Math.random() - 0.5);
            typingScore = 0; typingTime = 30;
            minigameContainer.innerHTML = `
                <div id="minigame-message"></div>
                <div id="typing-container" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:340px;text-align:center;">
                    <div id="typing-word" style="font-size:32px;font-weight:bold;color:#ffd700;margin-bottom:20px;letter-spacing:2px;"></div>
                    <input type="text" id="typing-input" style="width:100%;padding:15px;font-size:20px;border:3px solid #9b59b6;border-radius:10px;background:#2a2a4e;color:#fff;text-align:center;outline:none;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <div id="typing-feedback" style="margin-top:15px;font-size:14px;min-height:20px;"></div>
                </div>
            `;
            document.getElementById('minigame-timer').textContent = `Time: ${typingTime}`;
            document.getElementById('minigame-score').textContent = 'Words: 0/15';
            typingInput = document.getElementById('typing-input');
            typingInput.addEventListener('input', handleTypingInput);
            showNextTypingWord();
            typingInput.focus();
            miniGameTimer = setInterval(typingTimerLoop, 1000);
        }
        function showNextTypingWord() {
            typingCurrentWord = typingWords[typingScore % typingWords.length];
            document.getElementById('typing-word').textContent = typingCurrentWord;
            if (typingInput) {
                typingInput.value = '';
                typingInput.style.borderColor = '#9b59b6';
            }
        }
        function handleTypingInput(e) {
            const typed = e.target.value.toLowerCase();
            const target = typingCurrentWord.toLowerCase();
            if (typed === target) {
                typingScore++;
                document.getElementById('minigame-score').textContent = `Words: ${typingScore}/15`;
                document.getElementById('typing-feedback').innerHTML = '<span style="color:#2ecc71;">Correct! ‚úì</span>';
                typingInput.style.borderColor = '#2ecc71';
                if (typingScore >= 15) {
                    endTypingGame(true);
                    return;
                }
                setTimeout(() => {
                    showNextTypingWord();
                    document.getElementById('typing-feedback').innerHTML = '';
                }, 300);
            } else if (target.startsWith(typed)) {
                typingInput.style.borderColor = '#9b59b6';
                document.getElementById('typing-feedback').innerHTML = '';
            } else {
                typingInput.style.borderColor = '#e74c3c';
                document.getElementById('typing-feedback').innerHTML = '<span style="color:#e74c3c;">Typo!</span>';
            }
        }
        function typingTimerLoop() {
            typingTime--;
            document.getElementById('minigame-timer').textContent = `Time: ${typingTime}`;
            if (typingTime <= 0) {
                endTypingGame(typingScore >= 15);
            }
        }
        function endTypingGame(w) {
            if (typingInput) typingInput.removeEventListener('input', handleTypingInput);
            stopMiniGame();
            if (w) { tinyWins++; saveData(); updateDisplays(); }
            showMiniGameResult(w, `Words: ${typingScore}/15`, w ? '+1 Win!' : 'Too slow!');
        }

        const HANGMAN_WORDS = [
            'JAVASCRIPT', 'PYTHON', 'COMPUTER', 'KEYBOARD', 'MONITOR', 'INTERNET', 'BROWSER', 'WEBSITE',
            'PROGRAM', 'FUNCTION', 'VARIABLE', 'ELEPHANT', 'GIRAFFE', 'DOLPHIN', 'PENGUIN', 'BUTTERFLY',
            'MOUNTAIN', 'VOLCANO', 'RAINBOW', 'THUNDER', 'SUNSHINE', 'DIAMOND', 'CRYSTAL', 'MYSTERY',
            'ADVENTURE', 'CHAMPION', 'TREASURE', 'FANTASY', 'WARRIOR', 'KINGDOM', 'DRAGON', 'WIZARD',
            'UNIVERSE', 'GALAXY', 'PLANET', 'ROCKET', 'ASTRONAUT', 'SATELLITE', 'SCIENCE', 'BIOLOGY',
            'CHEMISTRY', 'PHYSICS', 'HISTORY', 'GEOGRAPHY', 'LANGUAGE', 'ALPHABET', 'SENTENCE', 'LIBRARY',
            'HOSPITAL', 'RESTAURANT', 'BUILDING', 'APARTMENT', 'FURNITURE', 'TELEPHONE', 'TELEVISION', 'CAMERA'
        ];
        let hangmanKeyHandler;
        function startHangmanGame() {
            hangmanWins = 0;
            minigameContainer.innerHTML = '<div id="minigame-message"></div><div id="hangman-container" style="position:absolute;top:10px;left:10px;right:10px;bottom:10px;display:flex;flex-direction:column;align-items:center;"></div>';
            document.getElementById('minigame-timer').textContent = 'Hangman';
            document.getElementById('minigame-score').textContent = 'Wins: 0/3';
            startHangmanRound();
        }
        function startHangmanRound() {
            hangmanWord = HANGMAN_WORDS[Math.floor(Math.random() * HANGMAN_WORDS.length)];
            hangmanGuessed = []; hangmanWrong = 0; hangmanGameActive = true;
            renderHangman();
            hangmanKeyHandler = (e) => {
                if (!hangmanGameActive) return;
                const key = e.key.toUpperCase();
                if (/^[A-Z]$/.test(key) && !hangmanGuessed.includes(key)) {
                    hangmanGuessed.push(key);
                    if (!hangmanWord.includes(key)) {
                        hangmanWrong++;
                    }
                    renderHangman();
                    checkHangmanEnd();
                }
            };
            document.addEventListener('keydown', hangmanKeyHandler);
        }
        function renderHangman() {
            const container = document.getElementById('hangman-container');
            if (!container) return;
            const wordDisplay = hangmanWord.split('').map(letter =>
                hangmanGuessed.includes(letter) ? letter : '_'
            ).join(' ');
            const hangmanParts = [
                hangmanWrong >= 1 ? '<circle cx="50" cy="25" r="15" stroke="#fff" stroke-width="3" fill="none"/>' : '',
                hangmanWrong >= 2 ? '<line x1="50" y1="40" x2="50" y2="80" stroke="#fff" stroke-width="3"/>' : '',
                hangmanWrong >= 3 ? '<line x1="50" y1="50" x2="30" y2="65" stroke="#fff" stroke-width="3"/>' : '',
                hangmanWrong >= 4 ? '<line x1="50" y1="50" x2="70" y2="65" stroke="#fff" stroke-width="3"/>' : '',
                hangmanWrong >= 5 ? '<line x1="50" y1="80" x2="35" y2="110" stroke="#fff" stroke-width="3"/>' : '',
                hangmanWrong >= 6 ? '<line x1="50" y1="80" x2="65" y2="110" stroke="#fff" stroke-width="3"/>' : ''
            ].join('');
            container.innerHTML = `
                <svg width="100" height="130" style="margin-top:10px;">
                    <line x1="10" y1="125" x2="90" y2="125" stroke="#8b4513" stroke-width="4"/>
                    <line x1="30" y1="125" x2="30" y2="5" stroke="#8b4513" stroke-width="3"/>
                    <line x1="30" y1="5" x2="50" y2="5" stroke="#8b4513" stroke-width="3"/>
                    <line x1="50" y1="5" x2="50" y2="10" stroke="#8b4513" stroke-width="2"/>
                    ${hangmanParts}
                </svg>
                <div style="font-size:28px;letter-spacing:8px;margin:15px 0;font-family:monospace;color:#ffd700;">${wordDisplay}</div>
                <div style="color:#e74c3c;font-size:14px;margin-bottom:10px;">Wrong: ${hangmanWrong}/6</div>
                <div id="hangman-keyboard" style="display:flex;flex-wrap:wrap;justify-content:center;gap:5px;max-width:320px;"></div>
                <div style="margin-top:10px;font-size:12px;color:#888;">Press a letter key or click</div>
            `;
            const keyboard = document.getElementById('hangman-keyboard');
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => {
                const btn = document.createElement('button');
                const isGuessed = hangmanGuessed.includes(letter);
                const isCorrect = hangmanWord.includes(letter);
                let bg = '#2a2a4e';
                if (isGuessed) bg = isCorrect ? '#2ecc71' : '#e74c3c';
                btn.style.cssText = `width:28px;height:32px;border:none;border-radius:5px;background:${bg};color:#fff;font-size:14px;font-weight:bold;cursor:${isGuessed ? 'default' : 'pointer'};opacity:${isGuessed ? '0.7' : '1'};`;
                btn.textContent = letter;
                if (!isGuessed && hangmanGameActive) {
                    btn.onclick = () => {
                        hangmanGuessed.push(letter);
                        if (!hangmanWord.includes(letter)) hangmanWrong++;
                        renderHangman();
                        checkHangmanEnd();
                    };
                }
                keyboard.appendChild(btn);
            });
        }
        function checkHangmanEnd() {
            const won = hangmanWord.split('').every(letter => hangmanGuessed.includes(letter));
            const lost = hangmanWrong >= 6;
            if (won) {
                hangmanGameActive = false;
                hangmanWins++;
                document.getElementById('minigame-score').textContent = `Wins: ${hangmanWins}/3`;
                if (hangmanWins >= 3) {
                    setTimeout(() => endHangmanGame(true), 1000);
                } else {
                    setTimeout(() => {
                        document.removeEventListener('keydown', hangmanKeyHandler);
                        startHangmanRound();
                    }, 1500);
                }
            } else if (lost) {
                hangmanGameActive = false;
                const container = document.getElementById('hangman-container');
                if (container) {
                    container.innerHTML += `<div style="color:#e74c3c;font-size:16px;margin-top:10px;">The word was: <strong>${hangmanWord}</strong></div>`;
                }
                setTimeout(() => endHangmanGame(false), 2000);
            }
        }
        function endHangmanGame(w) {
            hangmanGameActive = false;
            document.removeEventListener('keydown', hangmanKeyHandler);
            stopMiniGame();
            if (w) { tinyWins++; saveData(); updateDisplays(); }
            showMiniGameResult(w, `Wins: ${hangmanWins}/3`, w ? '+1 Win!' : 'Hanged!');
        }

        function showMiniGameResult(w, l1, l2) {
            const m = document.getElementById('minigame-message');
            m.innerHTML = `<div style="color:${w ? '#2ecc71' : '#e74c3c'}">${w ? 'WIN!' : 'LOSE'}</div><div style="font-size:14px;margin-top:8px">${l1}</div><div style="font-size:12px;color:#9b59b6;margin-top:4px">${l2}</div>`;
            m.style.display = 'block'; document.getElementById('play-again-btn').style.display = 'block';
        }
        function updateMiniGameDisplay() { document.getElementById('minigame-timer').textContent = `Time: ${miniGameTime}`; document.getElementById('minigame-score').textContent = `Score: ${miniGameScore}`; }

        function setMode(m) {
            currentMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === m));
            aiSpeeds = { ...MODES[m].aiSpeeds };
            [{ el: ai1, sc: document.querySelector('.ai1-score'), i: 1 }, { el: ai2, sc: document.querySelector('.ai2-score'), i: 2 }, { el: ai3, sc: document.querySelector('.ai3-score'), i: 3 }].forEach(({ el, sc, i }) => { const sh = i <= MODES[m].aiCount; el.classList.toggle('ai-hidden', !sh); sc.classList.toggle('ai-score-hidden', !sh); });
            init();
        }

        function init() {
            dots = []; scores = { player: 0, ai1: 0, ai2: 0, ai3: 0 }; gameOver = false;
            message.style.display = 'none'; earnedMoneyEl.style.display = 'none';
            document.querySelectorAll('.dot').forEach(d => d.remove());
            playerPos = { x: 100, y: 300 }; aiPositions = { ai1: { x: 700, y: 100 }, ai2: { x: 700, y: 300 }, ai3: { x: 700, y: 500 } }; aiTargets = { ai1: null, ai2: null, ai3: null };
            updatePositions(); for (let i = 0; i < TOTAL_DOTS; i++) createDot(); updateScoreboard();
        }

        function createDot() { const d = document.createElement('div'); d.className = 'dot'; const x = Math.random() * (GAME_WIDTH - DOT_SIZE), y = Math.random() * (GAME_HEIGHT - DOT_SIZE); d.style.cssText = `left:${x}px;top:${y}px;`; d.dataset.x = x + DOT_SIZE / 2; d.dataset.y = y + DOT_SIZE / 2; gameContainer.appendChild(d); dots.push(d); }
        function updatePositions() { playerEl.style.cssText = `left:${playerPos.x - PLAYER_SIZE / 2}px;top:${playerPos.y - PLAYER_SIZE / 2}px;`; [ai1, ai2, ai3].forEach((el, i) => { const p = aiPositions[`ai${i + 1}`]; el.style.cssText = `left:${p.x - PLAYER_SIZE / 2}px;top:${p.y - PLAYER_SIZE / 2}px;`; }); }
        function updateScoreboard() { document.getElementById('player-points').textContent = scores.player; document.getElementById('ai1-points').textContent = scores.ai1; document.getElementById('ai2-points').textContent = scores.ai2; document.getElementById('ai3-points').textContent = scores.ai3; document.getElementById('dots-left').textContent = `Dots: ${dots.length}`; }
        function distance(x1, y1, x2, y2) { return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2); }

        function collectDot(c) {
            const p = c === 'player' ? playerPos : aiPositions[c];
            for (let i = dots.length - 1; i >= 0; i--) {
                const d = dots[i]; if (distance(p.x, p.y, parseFloat(d.dataset.x), parseFloat(d.dataset.y)) < COLLECTION_DISTANCE) {
                    d.remove(); dots.splice(i, 1); scores[c]++; updateScoreboard();
                    ['ai1', 'ai2', 'ai3'].forEach(a => { if (aiTargets[a] === d) aiTargets[a] = null; });
                    checkGameOver(); return true;
                }
            } return false;
        }

        function findNearestDot(p, ex = []) { let n = null, nd = Infinity; dots.forEach(d => { if (ex.includes(d)) return; const dist = distance(p.x, p.y, parseFloat(d.dataset.x), parseFloat(d.dataset.y)); if (dist < nd) { nd = dist; n = d; } }); return n; }

        function moveAI(a) {
            if (gameOver || !dots.length) return;
            const ai = parseInt(a.replace('ai', '')); if (ai > MODES[currentMode].aiCount) return;
            const p = aiPositions[a];
            if (!aiTargets[a] || !dots.includes(aiTargets[a])) { const ot = Object.entries(aiTargets).filter(([n]) => n !== a).map(([, t]) => t).filter(t => t); aiTargets[a] = (Math.random() < 0.7 ? findNearestDot(p, ot) : null) || findNearestDot(p); }
            const t = aiTargets[a]; if (!t) return;
            const dx = parseFloat(t.dataset.x) - p.x, dy = parseFloat(t.dataset.y) - p.y, dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > 0) { p.x += (dx / dist) * aiSpeeds[a]; p.y += (dy / dist) * aiSpeeds[a]; }
            collectDot(a);
        }

        const keys = { up: false, down: false, left: false, right: false };
        document.addEventListener('keydown', e => { if (gameOver || document.querySelector('.modal.open')) return; if (e.key === 'ArrowUp') keys.up = true; if (e.key === 'ArrowDown') keys.down = true; if (e.key === 'ArrowLeft') keys.left = true; if (e.key === 'ArrowRight') keys.right = true; e.preventDefault(); });
        document.addEventListener('keyup', e => { if (e.key === 'ArrowUp') keys.up = false; if (e.key === 'ArrowDown') keys.down = false; if (e.key === 'ArrowLeft') keys.left = false; if (e.key === 'ArrowRight') keys.right = false; });

        function movePlayer() {
            if (gameOver) return;
            if (keys.up) playerPos.y -= 5; if (keys.down) playerPos.y += 5; if (keys.left) playerPos.x -= 5; if (keys.right) playerPos.x += 5;
            playerPos.x = Math.max(PLAYER_SIZE / 2, Math.min(GAME_WIDTH - PLAYER_SIZE / 2, playerPos.x));
            playerPos.y = Math.max(PLAYER_SIZE / 2, Math.min(GAME_HEIGHT - PLAYER_SIZE / 2, playerPos.y));
            updatePositions(); collectDot('player');
        }

        function checkGameOver() {
            if (dots.length === 0) {
                gameOver = true; const em = scores.player * MODES[currentMode].moneyPerDot; totalMoney += em; saveData(); updateDisplays();
                const w = Object.entries(scores).reduce((a, b) => a[1] > b[1] ? a : b);
                const ms = w[1], ws = Object.entries(scores).filter(([, s]) => s === ms);
                if (ws.length > 1 && ws.some(([n]) => n === 'player')) { message.textContent = "TIE! You win!"; message.style.color = '#4CAF50'; }
                else if (w[0] === 'player') { message.textContent = 'YOU WIN!'; message.style.color = '#4CAF50'; }
                else { message.textContent = `AI ${w[0].replace('ai', '')} Wins!`; message.style.color = '#e74c3c'; }
                message.style.display = 'block'; earnedMoneyEl.textContent = `+$${em}`; earnedMoneyEl.style.display = 'block';
            }
        }

        function gameLoop() { if (!gameOver) { movePlayer(); moveAI('ai1'); moveAI('ai2'); moveAI('ai3'); updatePositions(); } requestAnimationFrame(gameLoop); }

        document.getElementById('shop-btn').onclick = openShop;
        document.getElementById('crate-btn').onclick = openCrates;
        document.getElementById('tiny-games-btn').onclick = openTinyGames;
        document.getElementById('lottery-btn').onclick = openLottery;
        document.querySelectorAll('.mode-btn').forEach(b => b.onclick = () => setMode(b.dataset.mode));
        document.getElementById('restart-btn').onclick = init;

        loadData(); setMode('easy'); gameLoop();
    </script>
</body>
</html>
